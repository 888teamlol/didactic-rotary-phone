<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no">
    
<script>
/* === Telegram Mini App + Mobile sizing === */
(function(){
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  function setVH(){
    // Telegram uses its own viewport height; fallback to visualViewport / innerHeight
    let h = (tg && tg.viewportStableHeight) ? tg.viewportStableHeight
            : (window.visualViewport && window.visualViewport.height ? window.visualViewport.height : window.innerHeight);

    // guard against NaN/0 (some desktop WebViews report 0 early)
    if (!Number.isFinite(h) || h < 200) h = window.innerHeight || 800;

    document.documentElement.style.setProperty('--app-vh', (h * 0.01) + 'px');
  }
  window.__tg = tg;

  if (tg){
    try { tg.ready(); } catch(e){}
    try { tg.expand(); } catch(e){}
    try { tg.setHeaderColor('secondary_bg_color'); } catch(e){}
    try { tg.setBackgroundColor('bg_color'); } catch(e){}
    try { tg.disableVerticalSwipes && tg.disableVerticalSwipes(); } catch(e){}
    try { tg.onEvent('viewportChanged', setVH); } catch(e){}
    try { tg.onEvent('themeChanged', function(){
      // reflect theme params to CSS vars
      const p = tg.themeParams || {};
      for (const k in p){
        document.documentElement.style.setProperty('--tg-'+k, p[k]);
      }
    }); } catch(e){}
  }

  window.addEventListener('resize', setVH, {passive:true});
  if (window.visualViewport) window.visualViewport.addEventListener('resize', setVH, {passive:true});
  setVH();
})();
</script>

<title>üîí –†–ö–ù: –ë–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫ –í—Å–µ–≥–æ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Russo+One&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --rkn-red: #d32f2f;
            --rkn-dark: #1a1a2e;
            --rkn-blue: #16213e;
            --rkn-accent: #e94560;
            --rkn-gold: #ffd700;
            --rkn-green: #00e676;
            --telegram-bg: var(--tg-theme-bg-color, #1a1a2e);
            --telegram-text: var(--tg-theme-text-color, #ffffff);
            --telegram-hint: var(--tg-theme-hint-color, #8a8a8a);
        }

        body {
            font-family: 'Russo One', sans-serif;
            background: var(--telegram-bg);
            color: var(--telegram-text);
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(233, 69, 96, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(22, 33, 62, 0.8) 0%, transparent 50%);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.1) 2px, rgba(0,0,0,0.1) 4px);
            pointer-events: none;
            z-index: 500;
        }

        .hidden { display: none !important; }

        /* === PROLOGUE === */
        .prologue-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .prologue-text {
            font-size: 13px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            text-align: left;
            max-width: 340px;
            line-height: 1.7;
            opacity: 0;
            white-space: pre-wrap;
            max-height: 70vh;
            overflow-y: auto;
        }

        .prologue-text.visible { animation: typeIn 0.3s ease forwards; }

        @keyframes typeIn { from { opacity: 0; } to { opacity: 1; } }

        .prologue-skip {
            position: absolute;
            bottom: 30px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
        }

        .prologue-continue {
            margin-top: 20px;
            padding: 12px 30px;
            background: #00ff00;
            color: #000;
            border: none;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .prologue-continue.visible { opacity: 1; }

        /* === INTRO === */
        .intro-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a1a2e, #0f0f1a);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .intro-logo { font-size: 70px; margin-bottom: 12px; animation: pulse 2s infinite; }

        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        .intro-badge {
            background: var(--rkn-red);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 9px;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .intro-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            color: var(--rkn-accent);
            text-align: center;
            margin-bottom: 6px;
            text-shadow: 0 0 20px var(--rkn-accent);
        }

        .intro-subtitle {
            font-size: 11px;
            color: var(--telegram-hint);
            margin-bottom: 20px;
        }

        .intro-story {
            font-size: 12px;
            color: var(--telegram-text);
            text-align: center;
            line-height: 1.8;
            max-width: 320px;
            margin-bottom: 24px;
            padding: 16px;
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            border: 1px solid var(--rkn-accent);
        }

        .intro-story .highlight { color: var(--rkn-accent); font-weight: bold; }
        .intro-story .year { font-family: 'Press Start 2P', cursive; font-size: 14px; color: var(--rkn-gold); display: block; margin-bottom: 10px; }

        .intro-btn {
            font-family: 'Press Start 2P', cursive;
            background: linear-gradient(135deg, var(--rkn-red), var(--rkn-accent));
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 9px;
            cursor: pointer;
            box-shadow: 0 4px 30px rgba(233, 69, 96, 0.5);
        }

        .intro-btn:active { transform: scale(0.95); }

        .intro-btn.secondary {
            background: rgba(255,255,255,0.12);
            border: 2px solid rgba(255,255,255,0.25);
            box-shadow: none;
        }
        

        .intro-warning {
            margin-top: 16px;
            font-size: 8px;
            color: #555;
            text-align: center;
            max-width: 280px;
        }

        /* === GAME === */
        .game-container {
            max-width: 100%;
            padding: 12px;
            padding-bottom: 80px;
        }

        .header {
            text-align: center;
            padding: 12px 0;
        }

        .title {
            font-family: 'Press Start 2P', cursive;
            font-size: 11px;
            color: var(--rkn-accent);
            text-shadow: 0 0 10px var(--rkn-accent);
            margin-bottom: 4px;
        }

        .subtitle {
            font-size: 9px;
            color: var(--telegram-hint);
            letter-spacing: 2px;
        }

        .rank-display {
            margin-top: 6px;
            padding: 3px 10px;
            background: linear-gradient(90deg, var(--rkn-red), var(--rkn-accent));
            border-radius: 16px;
            display: inline-block;
            font-size: 9px;
        }

        /* Stats */
        .stats-panel {
            background: linear-gradient(135deg, rgba(22, 33, 62, 0.9), rgba(26, 26, 46, 0.95));
            border: 2px solid var(--rkn-accent);
            border-radius: 10px;
            padding: 12px;
            margin: 10px 0;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .stat-item {
            text-align: center;
            padding: 6px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
        }

        .stat-label { font-size: 8px; color: var(--telegram-hint); margin-bottom: 2px; }
        .stat-value { font-family: 'Press Start 2P', cursive; font-size: 11px; color: var(--rkn-gold); }
        .stat-value.danger { color: #ff4444; }

        /* Tension Bar */
        .tension-panel {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.3), rgba(26, 26, 46, 0.9));
            border: 2px solid #ff4444;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
        }

        .tension-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .tension-title { font-size: 9px; color: #ff4444; }
        .tension-value { font-size: 10px; color: #ff4444; font-weight: bold; }

        .tension-bar {
            height: 12px;
            background: rgba(0,0,0,0.5);
            border-radius: 6px;
            overflow: hidden;
        }

        .tension-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffcc00, #ff6600, #ff0000);
            transition: width 0.3s;
        }

        .tension-warning {
            font-size: 8px;
            color: #ff6666;
            margin-top: 4px;
            text-align: center;
        }

        /* Target */
        .target-panel {
            background: linear-gradient(135deg, rgba(22, 33, 62, 0.9), rgba(26, 26, 46, 0.95));
            border: 2px solid rgba(233, 69, 96, 0.5);
            border-radius: 10px;
            padding: 12px;
            margin: 10px 0;
            text-align: center;
        }

        .target-title { font-size: 8px; color: var(--telegram-hint); margin-bottom: 4px; }
        .target-name { font-size: 13px; color: var(--rkn-accent); margin-bottom: 8px; }

        .target-progress {
            height: 16px;
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--rkn-accent);
            position: relative;
        }

        .target-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--rkn-red), var(--rkn-accent));
            transition: width 0.3s;
        }

        .target-progress-text {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8px;
            color: white;
        }

        /* Block Button */
        .block-area {
            display: flex;
            justify-content: center;
            padding: 14px 0;
        }

        .block-button {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ff6b6b, var(--rkn-red) 50%, #8b0000);
            border: 4px solid var(--rkn-accent);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 25px rgba(211, 47, 47, 0.5);
            transition: all 0.1s;
            user-select: none;
        }

        .block-button:active {
            transform: scale(0.95);
        }

        .block-button::before {
            content: 'üö´';
            font-size: 45px;
            animation: pulse 2s infinite;
        }

        .block-button::after {
            content: '–ë–õ–û–ß–ò–¢–¨';
            font-family: 'Press Start 2P', cursive;
            font-size: 7px;
            color: white;
            margin-top: 6px;
        }

        .fly-number {
            position: fixed;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            color: var(--rkn-gold);
            pointer-events: none;
            z-index: 100;
            animation: flyUp 1s ease-out forwards;
        }

        @keyframes flyUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-60px); }
        }

        /* Dialog */
        .dialog-panel {
            background: linear-gradient(135deg, rgba(0,0,0,0.85), rgba(22, 33, 62, 0.9));
            border: 2px solid var(--rkn-accent);
            border-radius: 10px;
            padding: 12px;
            margin: 10px 0;
        }

        .dialog-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(233, 69, 96, 0.3);
        }

        .dialog-avatar { font-size: 28px; }
        .dialog-name { font-size: 11px; color: var(--rkn-accent); }
        .dialog-role { font-size: 8px; color: var(--telegram-hint); }
        .dialog-text { font-size: 11px; line-height: 1.6; }

        /* News Ticker */
        .news-ticker {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff4444;
            border-radius: 8px;
            padding: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .news-label {
            font-size: 8px;
            color: #ff4444;
            margin-bottom: 4px;
        }

        .news-text {
            font-size: 10px;
            color: #ffaaaa;
            white-space: nowrap;
            animation: scroll 15s linear infinite;
        }

        @keyframes scroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        /* Blocked Sites */
        .blocked-sites { margin: 12px 0; }

        .section-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 8px;
            color: var(--rkn-accent);
            text-align: center;
            margin-bottom: 8px;
        }

        .sites-scroll {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            padding: 6px 0;
            scrollbar-width: none;
        }

        .sites-scroll::-webkit-scrollbar { display: none; }

        .site-badge {
            flex-shrink: 0;
            background: rgba(211, 47, 47, 0.3);
            border: 1px solid var(--rkn-red);
            border-radius: 16px;
            padding: 4px 10px;
            font-size: 9px;
            color: var(--rkn-accent);
        }

        /* Upgrades */
        .upgrades-section { margin: 12px 0; }

        .upgrades-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .upgrade-card {
            background: linear-gradient(135deg, rgba(22, 33, 62, 0.9), rgba(26, 26, 46, 0.95));
            border: 2px solid rgba(233, 69, 96, 0.3);
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            position: relative;
        }

        .upgrade-card.can-afford {
            border-color: var(--rkn-green);
            box-shadow: 0 0 10px rgba(0, 230, 118, 0.3);
        }

        .upgrade-icon { font-size: 20px; margin-bottom: 2px; }
        .upgrade-name { font-size: 8px; margin-bottom: 2px; }
        .upgrade-desc { font-size: 7px; color: var(--telegram-hint); margin-bottom: 3px; }
        .upgrade-cost { font-family: 'Press Start 2P', cursive; font-size: 7px; color: var(--rkn-gold); }
        .upgrade-level { position: absolute; top: 4px; right: 4px; font-size: 7px; color: var(--rkn-accent); }

        /* Choice Modal */
        .choice-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.98);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
        }

        .choice-modal.show {
            display: flex;
        }

        .choice-icon { font-size: 60px; margin-bottom: 12px; }

        .choice-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 11px;
            color: var(--rkn-accent);
            text-align: center;
            margin-bottom: 12px;
        }

        .choice-text {
            font-size: 12px;
            color: var(--telegram-text);
            text-align: center;
            line-height: 1.7;
            max-width: 300px;
            margin-bottom: 20px;
        }

        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            max-width: 300px;
            position: relative;
            z-index: 10001;
        }

        .choice-consequence {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 4px;
            font-weight: normal;
        }

        .choice-btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-family: 'Russo One', sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            text-align: center;
            position: relative;
            z-index: 10000;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .choice-btn.primary {
            background: linear-gradient(135deg, var(--rkn-red), var(--rkn-accent));
            color: white;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
        }

        .choice-btn.secondary {
            background: rgba(255,255,255,0.15);
            color: var(--telegram-text);
            border: 2px solid var(--telegram-hint);
        }

        .choice-btn:hover {
            transform: scale(1.02);
        }

        .choice-btn:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .choice-consequence {
            font-size: 9px;
            color: var(--telegram-hint);
            margin-top: 4px;
        }

        /* Story Overlay */
        .story-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        .story-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .story-overlay-icon { font-size: 60px; margin-bottom: 12px; }

        .story-overlay-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 11px;
            color: var(--rkn-accent);
            text-align: center;
            margin-bottom: 10px;
        }

        .story-overlay-text {
            font-size: 12px;
            color: var(--telegram-text);
            text-align: center;
            line-height: 1.7;
            max-width: 300px;
            margin-bottom: 16px;
        }

        .story-overlay-btn {
            background: var(--rkn-accent);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
        }

        /* Chapter Screen */
        .chapter-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1s;
        }

        .chapter-screen.show {
            opacity: 1;
            pointer-events: auto;
        }

        .chapter-number {
            font-family: 'Press Start 2P', cursive;
            font-size: 9px;
            color: var(--rkn-accent);
            letter-spacing: 3px;
            margin-bottom: 12px;
        }

        .chapter-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            color: white;
            text-align: center;
        }

        /* Ending */
        .ending-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #0a0a0a, #1a0a0a);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
            overflow-y: auto;
        }

        .ending-screen.show { display: flex; }

        .ending-icon { font-size: 60px; margin-bottom: 12px; }

        .ending-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 11px;
            color: var(--rkn-accent);
            text-align: center;
            margin-bottom: 10px;
        }

        .ending-text {
            font-size: 12px;
            text-align: center;
            line-height: 1.7;
            max-width: 300px;
            margin-bottom: 16px;
        }

        .ending-stats {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 12px 18px;
            margin-bottom: 16px;
        }

        .ending-stat {
            display: flex;
            justify-content: space-between;
            gap: 14px;
            margin: 5px 0;
            font-size: 10px;
        }

        .ending-stat-label { color: var(--telegram-hint); }
        .ending-stat-value { color: var(--rkn-gold); font-family: 'Press Start 2P', cursive; font-size: 8px; }

        /* Boss Panel */
        .boss-panel {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.9), rgba(26, 26, 46, 0.95));
            border: 3px solid #ff0000;
            border-radius: 10px;
            padding: 12px;
            margin: 10px 0;
            text-align: center;
            animation: bossGlow 1s infinite alternate;
        }

        @keyframes bossGlow {
            from { box-shadow: 0 0 15px rgba(255, 0, 0, 0.5); }
            to { box-shadow: 0 0 30px rgba(255, 0, 0, 0.8); }
        }

        .boss-title { font-family: 'Press Start 2P', cursive; font-size: 9px; color: #ff0000; margin-bottom: 6px; }
        .boss-name { font-size: 14px; color: white; margin-bottom: 8px; }

        .boss-health {
            height: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #ff0000;
            position: relative;
        }

        .boss-health-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #ff6600);
            transition: width 0.3s;
        }

        .boss-health-text {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 9px;
            color: white;
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: var(--rkn-blue);
            border: 2px solid var(--rkn-accent);
            border-radius: 10px;
            padding: 8px 16px;
            z-index: 400;
            opacity: 0;
            transition: all 0.3s;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .notification-text { font-size: 10px; }

        /* Event Shake */
        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
    
        /* === MOBILE / PERFORMANCE === */
        html, body { height: 100%; }
        body {
            overscroll-behavior: none;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
            touch-action: manipulation;
        }
        .game-container {
            padding-bottom: calc(90px + env(safe-area-inset-bottom));
        }
        .header {
            padding-top: calc(12px + env(safe-area-inset-top));
        }

        /* Stats: more slots */
        .stats-panel { grid-template-columns: repeat(3, 1fr); }
        @media (max-width: 360px) {
            .stats-panel { grid-template-columns: repeat(2, 1fr); }
            .block-button { width: 128px; height: 128px; }
        }

        /* Top actions */
        .top-actions {
            position: sticky;
            top: 0;
            z-index: 1200;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            padding: 8px 0 2px;
            pointer-events: none;
        }
        .top-actions .icon-btn{
            pointer-events: auto;
            width: 40px; height: 36px;
            border-radius: 10px;
            border: 2px solid rgba(233, 69, 96, 0.4);
            background: rgba(0,0,0,0.25);
            color: var(--telegram-text);
            display: grid;
            place-items: center;
            font-size: 16px;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
        }
        .top-actions .icon-btn:active { transform: scale(0.96); opacity: 0.9; }

        /* Block button ripple */
        .block-button {
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
            will-change: transform;
        }
        .ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            opacity: 0.65;
            background: rgba(255,255,255,0.35);
            animation: ripple 450ms ease-out forwards;
            pointer-events: none;
        }
        @keyframes ripple {
            to { transform: scale(3.2); opacity: 0; }
        }

        /* Hit flash */
        .flash {
            animation: flash 180ms ease-out;
        }
        @keyframes flash {
            from { filter: brightness(1.7) saturate(1.2); }
            to { filter: brightness(1) saturate(1); }
        }

        /* Mini HUD pills */
        .pill-row {
            display: flex;
            gap: 6px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 6px 0 0;
        }
        .pill {
            font-size: 8px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid rgba(233, 69, 96, 0.35);
            background: rgba(0,0,0,0.25);
            color: var(--telegram-hint);
        }
        .pill strong { color: var(--rkn-gold); font-weight: normal; }
        
    
        /* === ACHIEVEMENTS / COLLECTION === */
        .choice-btn.disabled{opacity:0.45; pointer-events:none; filter: grayscale(0.3);}
        .ach-list{
            text-align:left;
            max-width: 360px;
            margin: 0 auto;
            padding: 6px 0 0;
            font-size: 10px;
            line-height: 1.5;
        }
        .ach-item{
            display:flex;
            gap:10px;
            align-items:flex-start;
            padding: 10px 10px;
            border-radius: 12px;
            border: 1px solid rgba(233, 69, 96, 0.25);
            background: rgba(0,0,0,0.18);
            margin-bottom: 8px;
        }
        .ach-icon{
            width: 32px; height: 32px;
            display:grid; place-items:center;
            font-size: 18px;
            border-radius: 10px;
            background: rgba(233, 69, 96, 0.16);
            border: 1px solid rgba(233, 69, 96, 0.25);
            flex: 0 0 auto;
        }
        .ach-meta{flex:1 1 auto;}
        .ach-name{font-size: 10px; color: var(--telegram-text);}
        .ach-desc{font-size: 9px; color: var(--telegram-hint); margin-top: 2px;}
        .ach-status{font-size: 8px; color: var(--rkn-gold); margin-top: 4px;}
        .ach-item.locked{opacity: 0.55;}
        .chip-wrap{display:flex; flex-wrap:wrap; gap:6px; justify-content:center; padding-top:8px;}
        .chip{
            font-size: 9px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(233, 69, 96, 0.28);
            background: rgba(0,0,0,0.22);
            color: var(--telegram-text);
        }
        .chip.locked{opacity:0.45; color: var(--telegram-hint); filter: grayscale(0.4);}
        .tab-row{display:flex; gap:8px; justify-content:center; margin: 6px 0 10px;}
        .tab-btn{
            font-family: 'Press Start 2P', cursive;
            font-size: 8px;
            padding: 10px 12px;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.18);
            background: rgba(255,255,255,0.10);
            color: white;
            cursor: pointer;
        }
        .tab-btn.active{
            border-color: rgba(233, 69, 96, 0.65);
            background: rgba(233, 69, 96, 0.20);
        }

    

/* === Mobile/Telegram tweaks === */
:root{
  --safe-top: env(safe-area-inset-top);
  --safe-bottom: env(safe-area-inset-bottom);
  --safe-left: env(safe-area-inset-left);
  --safe-right: env(safe-area-inset-right);
}
html, body{
  height: calc(var(--app-vh, 1vh) * 100);
  overscroll-behavior: none;
}
body{
  padding-top: var(--safe-top);
  padding-bottom: var(--safe-bottom);
  padding-left: var(--safe-left);
  padding-right: var(--safe-right);
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}
button, .btn, .choice-btn, .big-btn{
  touch-action: manipulation;
}
#gameContainer, #introScreen{
  min-height: calc(var(--app-vh, 1vh) * 100);
}


/* Telegram MainButton spacer */
body.tg-mainbutton{
  padding-bottom: calc(var(--safe-bottom) + 72px);
}


@media (prefers-reduced-motion: reduce){
  .prologue-text{ opacity: 1 !important; }
  .prologue-text.visible{ animation: none !important; opacity: 1 !important; }
}
</style>
</head>
<body>

<div id="disclaimer" style="
position:fixed;inset:0;z-index:9999;
background:#0b0b0f;color:#fff;
display:flex;flex-direction:column;
justify-content:center;align-items:center;
text-align:center;padding:20px;">
<h2>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ</h2>
<p style="max-width:600px;margin:15px 0;">
–ò–≥—Ä–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—É—é –ª–µ–∫—Å–∏–∫—É –∏ —Å–∞—Ç–∏—Ä—É.<br><br>
–í—Å–µ —Å–æ–±—ã—Ç–∏—è ‚Äî —é–º–æ—Ä –∏ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–º—ã—Å–µ–ª.<br>
–°—Ç. 29 –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–∏ –†–§ ‚Äî —Å–≤–æ–±–æ–¥–∞ —Å–ª–æ–≤–∞.
</p>
<button onclick="document.getElementById('disclaimer').remove()"
style="padding:12px 20px;font-size:16px;border:0;
border-radius:8px;background:#4caf50;color:#000;">
–ü–æ–Ω—è—Ç–Ω–æ, –ø–æ–≥–Ω–∞–ª–∏
</button>
</div>

    <!-- Prologue -->
    <div class="prologue-screen" id="prologueScreen">
        <div class="prologue-text" id="prologueText"></div>
        <button class="prologue-continue" id="prologueContinue" onclick="endPrologue()">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
        <div class="prologue-skip" onclick="skipPrologue()">[ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å ]</div>
    </div>

    <!-- Intro -->
    <div class="intro-screen hidden" id="introScreen">
        <div class="intro-logo">üèõÔ∏è</div>
        <div class="intro-badge">–°–û–í–ï–†–®–ï–ù–ù–û –°–ï–ö–†–ï–¢–ù–û</div>
        <div class="intro-title">–†–ö–ù –°–ò–ú–£–õ–Ø–¢–û–†</div>
        <div class="intro-subtitle">–ë–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫ –í—Å–µ–≥–æ ‚Ä¢ –ò–∑–¥–∞–Ω–∏–µ 2026</div>
        <div class="intro-story">
            <span class="year">2026 –ì–û–î</span>
            –ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Å—Ç–∞–ª —É–≥—Ä–æ–∑–æ–π. –ú–µ–º—ã –ø–æ–¥—Ä—ã–≤–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å. VPN –ø–ª–æ–¥—è—Ç—Å—è –∫–∞–∫ —Ç–∞—Ä–∞–∫–∞–Ω—ã.<br><br>
            –í—ã ‚Äî <span class="highlight">–Ω–æ–≤—ã–π –∞–≥–µ–Ω—Ç –†–ö–ù</span>. –ú–∏—Å—Å–∏—è: <span class="highlight">–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Ö—É–π –≤—Å—ë</span>.<br><br>
            –ù–æ –ø–æ–º–Ω–∏—Ç–µ: <span class="highlight">–Ω–∞—Ä–æ–¥ –±—É–¥–µ—Ç —Å–æ–ø—Ä–æ—Ç–∏–≤–ª—è—Ç—å—Å—è</span>. –ú–∏—Ç–∏–Ω–≥–∏, —É–≥—Ä–æ–∑—ã, –ø–æ–∫—É—à–µ–Ω–∏—è... –≠—Ç–æ —Ü–µ–Ω–∞ –≤–∞—à–µ–π —Ä–∞–±–æ—Ç—ã.<br><br>
            <span class="highlight">–í—ã –≥–æ—Ç–æ–≤—ã?</span>
        </div>
        <button class="intro-btn" onclick="startGame()">–ù–ê–ß–ê–¢–¨ –°–õ–£–ñ–ë–£</button>

        <button class="intro-btn secondary hidden" id="continueBtn" onclick="resumeGame()">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>

        <div class="intro-warning">‚ö†Ô∏è 18+ ‚Ä¢ –ú–∞—Ç ‚Ä¢ –ù–∞—Å–∏–ª–∏–µ ‚Ä¢ –°–∞—Ç–∏—Ä–∞<br>–í—Å–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω—ã</div>
    </div>

    <!-- Chapter -->
    <div class="chapter-screen" id="chapterScreen">
        <div class="chapter-number" id="chapterNumber">–ì–õ–ê–í–ê I</div>
        <div class="chapter-title" id="chapterTitle">–ü–ï–†–í–´–ô –î–ï–ù–¨</div>
    </div>

    <!-- Game -->
    <div class="game-container hidden" id="gameContainer">

        <div class="top-actions">
            <button class="icon-btn" id="btnMenu" title="–ú–µ–Ω—é">‚ò∞</button>
            <button class="icon-btn" id="btnSave" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">üíæ</button>
            <button class="icon-btn" id="btnAch" title="–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è">üèÜ</button>
            <button class="icon-btn" id="btnDocs" title="–î–æ–∫—É–º–µ–Ω—Ç—ã">üìÅ</button>
        </div>

        <div class="header">
            <div class="title">–†–ö–ù –°–ò–ú–£–õ–Ø–¢–û–†</div>
            <div class="subtitle">–ó–ê–©–ò–©–ê–ï–ú –†–£–ù–ï–¢</div>
            <div class="rank-display" id="rankDisplay">üëî –°—Ç–∞–∂—ë—Ä</div>
            <div class="pill-row">
                <div class="pill">‚ö°/—Å–µ–∫: <strong id="perSecondPill">0</strong></div>
                <div class="pill">‚ú® —ç—Ñ—Ñ–µ–∫—Ç—ã: <strong id="buffsPill">0</strong></div>
            </div>
        </div>

        <!-- Tension Bar -->
        <div class="tension-panel">
            <div class="tension-header">
                <span class="tension-title">üò° –ù–ê–†–û–î–ù–´–ô –ì–ù–ï–í</span>
                <span class="tension-value" id="tensionValue">0%</span>
            </div>
            <div class="tension-bar">
                <div class="tension-fill" id="tensionFill" style="width: 0%"></div>
            </div>
            <div class="tension-warning" id="tensionWarning"></div>
        </div>

        <!-- News Ticker -->
        <div class="news-ticker">
            <div class="news-label">üì∫ –ù–û–í–û–°–¢–ò</div>
            <div class="news-text" id="newsText">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –†–ö–ù! –ù–∞—á–∏–Ω–∞–π—Ç–µ —Ä–∞–±–æ—Ç—É...</div>
        </div>

        <div class="stats-panel">
            <div class="stat-item">
                <div class="stat-label">üí∞ –ë—é–¥–∂–µ—Ç</div>
                <div class="stat-value" id="money">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">üö´ –ë–ª–æ–∫–∏—Ä–æ–≤–æ–∫</div>
                <div class="stat-value" id="totalBlocks">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">‚ö° –ó–∞ –∫–ª–∏–∫</div>
                <div class="stat-value" id="perClick">1</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ</div>
                <div class="stat-value" id="health">100</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">üìÖ –î–µ–Ω—å</div>
                <div class="stat-value" id="day">1</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">üõ°Ô∏è –õ–æ—è–ª—å–Ω–æ—Å—Ç—å</div>
                <div class="stat-value" id="loyalty">50</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">üéñÔ∏è –î–æ–ª–∂–Ω–æ—Å—Ç—å</div>
                <div class="stat-value" id="position">–°—Ç–∞–∂—ë—Ä</div>
            </div>
        </div>

        <div class="target-panel" id="targetPanel">
            <div class="target-title">üéØ –¶–ï–õ–¨</div>
            <div class="target-name" id="targetName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="target-progress">
                <div class="target-progress-bar" id="targetProgress" style="width: 0%"></div>
                <div class="target-progress-text" id="targetProgressText">0%</div>
            </div>
        </div>

        <div class="boss-panel hidden" id="bossPanel">
            <div class="boss-title">‚öîÔ∏è –ë–û–°–° ‚öîÔ∏è</div>
            <div class="boss-name" id="bossName">???</div>
            <div class="boss-health">
                <div class="boss-health-bar" id="bossHealthBar" style="width: 100%"></div>
                <div class="boss-health-text" id="bossHealthText">100%</div>
            </div>
        </div>

        <div class="block-area">
            <div class="block-button" id="blockButton"></div>
        </div>

        <div class="dialog-panel">
            <div class="dialog-header">
                <div class="dialog-avatar" id="dialogAvatar">üë®‚Äçüíº</div>
                <div>
                    <div class="dialog-name" id="dialogName">–°–∏—Å—Ç–µ–º–∞</div>
                    <div class="dialog-role" id="dialogRole">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</div>
                </div>
            </div>
            <div class="dialog-text" id="dialogText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div class="blocked-sites">
            <div class="section-title">üìã –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–û</div>
            <div class="sites-scroll" id="blockedList"></div>
        </div>

        <div class="upgrades-section">
            <div class="section-title">‚¨ÜÔ∏è –£–õ–£–ß–®–ï–ù–ò–Ø</div>
            <div class="upgrades-grid" id="upgradesGrid"></div>
        </div>
    </div>

    <!-- Choice Modal -->
    <div class="choice-modal" id="choiceModal">
        <div class="choice-icon" id="choiceIcon">‚ö†Ô∏è</div>
        <div class="choice-title" id="choiceTitle">–í–´–ë–û–†</div>
        <div class="choice-text" id="choiceText">–¢–µ–∫—Å—Ç –≤—ã–±–æ—Ä–∞</div>
        <div class="choice-buttons" id="choiceButtons"></div>
    </div>

    <!-- Story Overlay -->
    <div class="story-overlay" id="storyOverlay">
        <div class="story-overlay-icon" id="storyOverlayIcon">üì¢</div>
        <div class="story-overlay-title" id="storyOverlayTitle">–í–ù–ò–ú–ê–ù–ò–ï</div>
        <div class="story-overlay-text" id="storyOverlayText">–¢–µ–∫—Å—Ç</div>
        <button class="story-overlay-btn" onclick="closeStoryOverlay()">–ü–û–ù–Ø–õ</button>
    </div>


    <!-- Menu Overlay -->
    <div class="story-overlay" id="menuOverlay">
        <div class="story-overlay-icon">‚ò∞</div>
        <div class="story-overlay-title">–ú–ï–ù–Æ</div>
        <div class="story-overlay-text" id="menuText"></div>
        <div class="choice-buttons" style="max-width:320px">
            <button class="choice-btn primary" type="button" onclick="manualSave()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="choice-btn secondary" type="button" onclick="openAchievements('ach')">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
            <button class="choice-btn secondary" id="prestigeBtn" type="button" onclick="openPrestige()">üîÅ –ù–æ–≤–∞—è —Å–º–µ–Ω–∞</button>
            <button class="choice-btn secondary" type="button" onclick="closeMenu()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            <button class="choice-btn secondary" type="button" onclick="hardReset()">üóëÔ∏è –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
        </div>
    </div>


    <!-- Achievements / Collection Overlay -->
    <div class="story-overlay" id="achOverlay">
        <div class="story-overlay-icon">üèÜ</div>
        <div class="story-overlay-title" id="achTitle">–î–û–°–¢–ò–ñ–ï–ù–ò–Ø</div>
        <div class="tab-row">
            <button class="tab-btn" id="tabAch" type="button" onclick="switchAchTab('ach')">–î–û–°–¢–ò–ñ–ï–ù–ò–Ø</button>
            <button class="tab-btn" id="tabCol" type="button" onclick="switchAchTab('col')">–ö–û–õ–õ–ï–ö–¶–ò–Ø</button>
            <button class="tab-btn" id="tabDocs" type="button" onclick="switchAchTab('docs')">–î–û–ö–£–ú–ï–ù–¢–´</button>
            <button class="tab-btn" id="tabArt" type="button" onclick="switchAchTab('art')">–ê–†–¢–ï–§–ê–ö–¢–´</button>
        </div>
        <div class="story-overlay-text" id="achText"></div>
        <div class="choice-buttons" style="max-width:320px">
            <button class="choice-btn secondary" type="button" onclick="closeAchievements()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- Ending -->
    <div class="ending-screen" id="endingScreen">
        <div class="ending-icon" id="endingIcon">üíÄ</div>
        <div class="ending-title" id="endingTitle">–ö–û–ù–ï–¶</div>
        <div class="ending-text" id="endingText">–¢–µ–∫—Å—Ç</div>
        <div class="ending-stats">
            <div class="ending-stat">
                <span class="ending-stat-label">–ë–ª–æ–∫–∏—Ä–æ–≤–æ–∫:</span>
                <span class="ending-stat-value" id="endBlocks">0</span>
            </div>
            <div class="ending-stat">
                <span class="ending-stat-label">–í—Ä–µ–º—è:</span>
                <span class="ending-stat-value" id="endTime">0</span>
            </div>
            <div class="ending-stat">
                <span class="ending-stat-label">–ö–æ–Ω—Ü–æ–≤–∫–∞:</span>
                <span class="ending-stat-value" id="endType">?</span>
            </div>
        </div>
        <button class="story-overlay-btn" onclick="restartGame()">–ó–ê–ù–û–í–û</button>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-text" id="notificationText">–¢–µ–∫—Å—Ç</div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); }

        // === SAVE / LOAD ===
        const SAVE_KEY = 'rkn_save_v2';
        const SAVE_VERSION = 3;

        let uiState = {
            lastUiFrame: 0,
            lastUpgradeRefresh: 0,
            lastEventTs: 0,
            modalOpen: false,
            lastHapticTs: 0,
            achTab: 'ach'
        };

        function safeHaptic(type='light') {
            if (!tg) return;
            const now = Date.now();
            if (now - uiState.lastHapticTs < 90) return;
            uiState.lastHapticTs = now;
            try { tg.HapticFeedback?.impactOccurred(type); } catch(e) {}
        }


        // === META / PRESTIGE / ACHIEVEMENTS HELPERS ===
        const positionNames = [
            "üëî –°—Ç–∞–∂—ë—Ä",
            "üñ•Ô∏è –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç",
            "üìã –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å —Å–º–µ–Ω—ã",
            "üéñÔ∏è –ù–∞—á–∞–ª—å–Ω–∏–∫ –æ—Ç–¥–µ–ª–∞",
            "üëë –ó–∞–º. –º–∏–Ω–∏—Å—Ç—Ä–∞ (–ø–æ—á—Ç–∏)"
        ];

        function ensureMeta() {
            gameState.prestige = gameState.prestige || 0;
            gameState.positionLevel = gameState.positionLevel || 0;
            gameState.permClickAdd = gameState.permClickAdd || 0;
            gameState.permSecondMul = (gameState.permSecondMul == null) ? 1 : gameState.permSecondMul;
            gameState.lifetimeBlocks = gameState.lifetimeBlocks || 0;
            gameState.clicks = gameState.clicks || 0;
            gameState.upgradeBuys = gameState.upgradeBuys || 0;
            if (!gameState.achievements || typeof gameState.achievements !== 'object') gameState.achievements = {};
                        if (!gameState.collection || typeof gameState.collection !== 'object') gameState.collection = { targets: {}, artifacts: {} };
            if (!gameState.collection.targets || typeof gameState.collection.targets !== 'object') gameState.collection.targets = {};
            if (!gameState.collection.artifacts || typeof gameState.collection.artifacts !== 'object') gameState.collection.artifacts = {};

            // —Ä–µ–¥–∫–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã (–∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã)
            if (!Array.isArray(gameState.artifacts)) gameState.artifacts = [];

            // —Ü–µ–ø–æ—á–∫–∏ –≤—Å—Ç—Ä–µ—á
            if (!Array.isArray(gameState.scheduledEncounters)) gameState.scheduledEncounters = [];
            if (gameState.escapeActive == null) gameState.escapeActive = false;
            gameState.escapeStage = gameState.escapeStage || 0;
            if (gameState.escapeLeak == null) gameState.escapeLeak = false;
            gameState.escapeHeat = (gameState.escapeHeat == null) ? 0 : gameState.escapeHeat;
            if (gameState.exileMode == null) gameState.exileMode = false;
            gameState.exileShifts = gameState.exileShifts || 0;
            if (gameState.starterPerk == null) gameState.starterPerk = '';
            if (gameState.firstBuyDiscount == null) gameState.firstBuyDiscount = false;

        }

        function positionLabel() {
            const lvl = Math.max(0, Math.min(positionNames.length - 1, gameState.positionLevel || 0));
            const base = positionNames[lvl] + (gameState.prestige ? ` ‚Ä¢ –°–º–µ–Ω–∞ #${gameState.prestige + 1}` : '');
            return base + (gameState.exileMode ? ` ‚Ä¢ –∏–∑–≥–Ω–∞–Ω–∏–µ #${(gameState.exileShifts||0)}` : '');}


        function makeBaseState(keepMeta=false) {
            const meta = keepMeta ? {
                prestige: gameState.prestige || 0,
                positionLevel: gameState.positionLevel || 0,
                permClickAdd: gameState.permClickAdd || 0,
                permSecondMul: (gameState.permSecondMul == null) ? 1 : gameState.permSecondMul,
                lifetimeBlocks: gameState.lifetimeBlocks || 0,
                exileMode: gameState.exileMode || false,
                exileShifts: gameState.exileShifts || 0,
                achievements: (gameState.achievements && typeof gameState.achievements === 'object') ? gameState.achievements : {},
                collection: (gameState.collection && typeof gameState.collection === 'object') ? gameState.collection : { targets: {} }
            } : {
                prestige: 0,
                positionLevel: 0,
                permClickAdd: 0,
                permSecondMul: 1,
                lifetimeBlocks: 0,
                achievements: {},
                collection: { targets: {} }
            };

            return {
                money: 0,
                totalBlocks: 0,
                perClick: 1,
                perSecond: 0,
                currentTargetIndex: 0,
                targetProgress: 0,
                blockedSites: [],
                upgrades: {},
                startTime: Date.now(),
                totalSpent: 0,
                tension: 0,
                health: 100,
                currentChapter: 0,
                bossActive: false,
                bossHealth: 0,
                bossMaxHealth: 0,
                eventsTriggered: [],
                gameEnded: false,
                endingType: null,
                day: 1,
                loyalty: 50,
                storyLog: [],
                buffs: [],
                lastSaveTs: 0,
                documents: [],
                resistance: 0,
                suspicion: 0,
                clicks: 0,
                upgradeBuys: 0,
                ...meta
            };
        }

        function serializeState() {
            // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            return {
                v: SAVE_VERSION,
                ts: Date.now(),
                gameState
            };
        }

        function manualSave(silent=false) {
            try {
                const payload = serializeState();
                localStorage.setItem(SAVE_KEY, JSON.stringify(payload));
                gameState.lastSaveTs = payload.ts;
                if (!silent) showNotification('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            } catch (e) {
                if (!silent) showNotification('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å');
            }
        }

        function loadSave() {
            try {
                const raw = localStorage.getItem(SAVE_KEY);
                if (!raw) return null;
                const data = JSON.parse(raw);
                if (!data || !data.gameState) return null;
                return data;
            } catch(e) {
                return null;
            }
        }

        function clearSave() {
            try { localStorage.removeItem(SAVE_KEY); } catch(e) {}
        }

        function applyLoadedGame(loaded) {
            // –ú—è–≥–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ —Å–ª—É—á–∞–π –∏–∑–º–µ–Ω–µ–Ω–∏–π
            const gs = loaded.gameState || {};
            gameState = Object.assign({}, gameState, gs);
            // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø–æ–ª—è
            gameState.day = gameState.day || 1;
            ensureDocs();
            gameState.loyalty = (gameState.loyalty ?? 50);
            gameState.storyLog = Array.isArray(gameState.storyLog) ? gameState.storyLog : [];
            gameState.buffs = Array.isArray(gameState.buffs) ? gameState.buffs : [];
            gameState.lastSaveTs = loaded.ts || Date.now();
            ensureMeta();
            setupTelegramButtons();

            // –û—Ñ—Ñ–ª–∞–π–Ω-–ø—Ä–æ–≥—Ä–µ—Å—Å: —Ç–æ–ª—å–∫–æ –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥, —Å –∫–∞–ø–æ–º
            const now = Date.now();
            const offlineMs = Math.max(0, now - (loaded.ts || now));
            const capMs = 4 * 60 * 60 * 1000; // 4 —á–∞—Å–∞
            const effectiveMs = Math.min(offlineMs, capMs);

            if (gameState.perSecond > 0 && effectiveMs > 10_000) {
                const seconds = effectiveMs / 1000;
                const basePS = (gameState.perSecond || 0) * (gameState.permSecondMul || 1);
                const gain = basePS * seconds;
                gameState.money += gain;
                gameState.totalBlocks += gain;
                showStoryOverlay('‚è≥', '–û–§–§–õ–ê–ô–ù-–ü–†–û–ì–†–ï–°–°',
                    `–ü–æ–∫–∞ —Ç–µ–±—è –Ω–µ –±—ã–ª–æ (${formatTime(effectiveMs)}), —Å—Ç–∞–∂—ë—Ä—ã –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∏ –±–ª–æ—á–∏—Ç—å.<br><br>+${formatNumber(gain)} –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ / –±—é–¥–∂–µ—Ç–∞.`
                );
            }
        }

        function updateIntroContinueButton() {
            const save = loadSave();
            const btn = document.getElementById('continueBtn');
            if (btn && save && save.gameState && !save.gameState.gameEnded) {
                btn.classList.remove('hidden');
            } else if (btn) {
                btn.classList.add('hidden');
            }
        }

        function resumeGame() {
            const loaded = loadSave();
            if (!loaded) return startGame();
            // —Å—Ç–∞—Ä—Ç—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–≥—Ä—ã –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            document.getElementById('introScreen').classList.add('hidden');
            document.getElementById('gameContainer').classList.remove('hidden');

            applyLoadedGame(loaded);

            // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º UI —Å–ø–∏—Å–∫–æ–≤
            initUpgrades(true);
            rebuildBlockedList();
            updateDialog();
            updateRank();
            updateDisplay(true);
            updateNews();
            updatePrestigeButton();
            startGameLoop();

            setTimeout(() => showChapter(gameState.currentChapter || 0), 300);
            safeHaptic('heavy');
        }

        function rebuildBlockedList() {
            const list = document.getElementById('blockedList');
            list.innerHTML = '';
            (gameState.blockedSites || []).slice().reverse().forEach(n => addBlockedSite(n));
        }

        function openMenu() {
            uiState.modalOpen = true;
            ensureMeta();
            setupTelegramButtons();
            updatePrestigeButton();
            const lines = [];
            lines.push(`<strong>–í—Ä–µ–º—è:</strong> ${formatTime(Date.now() - gameState.startTime)}`);
            lines.push(`<strong>–ë–ª–æ–∫–∏—Ä–æ–≤–æ–∫:</strong> ${formatNumber(gameState.totalBlocks)}`);
            lines.push(`<strong>–ë—é–¥–∂–µ—Ç:</strong> ${formatNumber(gameState.money)}`);
            lines.push(`<strong>–î–µ–Ω—å:</strong> ${gameState.day}`);
            lines.push(`<strong>–õ–æ—è–ª—å–Ω–æ—Å—Ç—å:</strong> ${Math.floor(gameState.loyalty)}%`);
            lines.push(`<strong>–ì–Ω–µ–≤:</strong> ${Math.floor(gameState.tension || 0)}%`);
            lines.push(`<strong>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</strong> ${positionLabel()}`);
            lines.push(`<strong>–ü–æ—Å—Ç–æ—è–Ω–Ω–æ:</strong> +${gameState.permClickAdd || 0} –∫–ª–∏–∫, +${Math.round(((gameState.permSecondMul||1)-1)*100)}% –ø–∞—Å—Å–∏–≤`);
            lines.push(`<strong>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</strong> ${unlockedCount()}/${achievementsData.length}`);
            if (gameState.lifetimeBlocks) lines.push(`<strong>–í—Å–µ–≥–æ –∑–∞ –≤—Å–µ —Å–º–µ–Ω—ã:</strong> ${formatNumber(gameState.lifetimeBlocks)}`);
            if (gameState.lastSaveTs) lines.push(`<strong>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:</strong> ${new Date(gameState.lastSaveTs).toLocaleString()}`);
            document.getElementById('menuText').innerHTML = lines.join('<br>');
            document.getElementById('menuOverlay').classList.add('show');
        
            try{ showTgMainButton(); }catch(e){}}

        function closeMenu() {
            document.getElementById('menuOverlay').classList.remove('show');
            uiState.modalOpen = false;
            try{ hideTgMainButton(); }catch(e){}
        }

        function hardReset() {
            clearSave();
            restartGame(false);
            closeMenu();
            showNotification('üóëÔ∏è –°–±—Ä–æ—à–µ–Ω–æ');
            updateIntroContinueButton();
        }


        // === PROLOGUE ===
        const prologueLines = [
            "> –ú–æ—Å–∫–≤–∞. –Ø–Ω–≤–∞—Ä—å 2026.",
            "> –ó–¥–∞–Ω–∏–µ –Ω–∞ –ö–∏—Ç–∞–π-–≥–æ—Ä–æ–¥–µ. (–∏–ª–∏ –µ–≥–æ –º–∞–∫–µ—Ç, –∫—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–∑–±–µ—Ä—ë—Ç.)",
            "",
            "> –í—ã –ø—Ä–æ—à–ª–∏ 7 —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–π.",
            "> –ü—Ä–æ–≤–µ—Ä–∫—É –§–°–ë. –ò —Ç–µ—Å—Ç –Ω–∞ ‚Äú–Ω–µ –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã‚Äù.",
            "> –¢–µ—Å—Ç –Ω–∞ –ø–æ–ª–∏–≥—Ä–∞—Ñ–µ.",
            "",
            '> HR —É–ª—ã–±–Ω—É–ª–∞—Å—å:',
            '  "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤',
            '   –†–æ—Å–∫–æ–º–Ω–∞–¥–∑–æ—Ä."',
            "",
            "> –í—ã –Ω–µ –∑–Ω–∞–ª–∏, —Ä–∞–¥–æ–≤–∞—Ç—å—Å—è",
            "> –∏–ª–∏ –±–µ–∂–∞—Ç—å –Ω–∞—Ö—É–π. –ù–æ –±–µ–∂–∞—Ç—å –±—ã–ª–æ –Ω–µ–∫—É–¥–∞ ‚Äî –ø—Ä–æ–ø—É—Å–∫ —É–∂–µ –Ω–∞–ø–µ—á–∞—Ç–∞–ª–∏.",
            "",
            "> –ù–æ –≤—ã–±–æ—Ä–∞ –Ω–µ –±—ã–ª–æ.",
            "> –ò–ø–æ—Ç–µ–∫–∞. –ö—Ä–µ–¥–∏—Ç—ã. –ñ–µ–Ω–∞.",
            "",
            "> –í–∞—à–∞ –∑–∞–¥–∞—á–∞ –ø—Ä–æ—Å—Ç–∞:",
            "> –ë–õ–û–ö–ò–†–û–í–ê–¢–¨. –í–°–Å. –ü–û–î–†–Ø–î.",
            "",
            "> –ù–æ –µ—Å—Ç—å –Ω—é–∞–Ω—Å...",
            "",
            "> –õ—é–¥–∏ –±—É–¥—É—Ç —Å–æ–ø—Ä–æ—Ç–∏–≤–ª—è—Ç—å—Å—è.",
            "> –ú–∏—Ç–∏–Ω–≥–∏. –£–≥—Ä–æ–∑—ã. –ù–∞—Å–∏–ª–∏–µ.",
            "",
            "> –í—ã –≥–æ—Ç–æ–≤—ã –ø–ª–∞—Ç–∏—Ç—å —Ü–µ–Ω—É?",
            "",
            "[ –ó–ê–ì–†–£–ó–ö–ê –°–ò–°–¢–ï–ú–´... ]"
        ];

        let prologueIndex = 0;
        let prologueInterval;

        // === GAME STATE ===
        let gameState = {
            money: 0,
            totalBlocks: 0,
            perClick: 1,
            perSecond: 0,
            currentTargetIndex: 0,
            targetProgress: 0,
            blockedSites: [],
            upgrades: {},
            startTime: Date.now(),
            totalSpent: 0,
            tension: 0, // –ù–∞—Ä–æ–¥–Ω—ã–π –≥–Ω–µ–≤ 0-100
            health: 100, // –ó–¥–æ—Ä–æ–≤—å–µ –∏–≥—Ä–æ–∫–∞
            currentChapter: 0,
            bossActive: false,
            bossHealth: 0,
            bossMaxHealth: 0,
            eventsTriggered: [],
            gameEnded: false,
            endingType: null,
            day: 1,
            loyalty: 50,
            storyLog: [],
            buffs: [],
            lastSaveTs: 0,

            // meta / progression
            prestige: 0,                 // —Å–∫–æ–ª—å–∫–æ ‚Äú–Ω–æ–≤—ã—Ö —Å–º–µ–Ω‚Äù
            positionLevel: 0,            // –¥–æ–ª–∂–Ω–æ—Å—Ç—å (–ø–æ –ø—Ä–µ—Å—Ç–∏–∂—É)
            permClickAdd: 0,             // –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π +–∫–ª–∏–∫ (–º–∞–ª–µ–Ω—å–∫–∏–π)
            permSecondMul: 1,            // –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å –ø–∞—Å—Å–∏–≤–∞ (–º–∞–ª–µ–Ω—å–∫–∏–π)
            lifetimeBlocks: 0,           // —Å—É–º–º–∞—Ä–Ω–æ –∑–∞ –≤—Å–µ —Å–º–µ–Ω—ã
            clicks: 0,                   // –∫–ª–∏–∫–∏ –∑–∞ —Å–º–µ–Ω—É
            upgradeBuys: 0,              // –ø–æ–∫—É–ø–æ–∫ —É–ª—É—á—à–µ–Ω–∏–π –∑–∞ —Å–º–µ–Ω—É
            achievements: {},            // {id:{ts}}
            collection: { targets: {} }  // —Ç—Ä–æ—Ñ–µ–∏ –ø–æ —Ü–µ–ª—è–º
        };

        // === NEWS ===
        const newsHeadlines = [
            "–†–ö–ù –Ω–∞—á–∞–ª —Ä–∞–±–æ—Ç—É –ø–æ –Ω–æ–≤–æ–º—É –ø–ª–∞–Ω—É –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫...",
            "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∂–∞–ª—É—é—Ç—Å—è –Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∞–π—Ç–æ–≤...",
            "VPN-—Å–µ—Ä–≤–∏—Å—ã —Ñ–∏–∫—Å–∏—Ä—É—é—Ç —Ä–æ—Å—Ç –∑–∞–≥—Ä—É–∑–æ–∫ –Ω–∞ 300%...",
            "–ú–∏—Ç–∏–Ω–≥ –ø—Ä–æ—Ç–∏–≤ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ —Å–æ–±—Ä–∞–ª 50 —á–µ–ª–æ–≤–µ–∫...",
            "–ì–æ—Å–¥—É–º–∞ –æ–¥–æ–±—Ä–∏–ª–∞ –∑–∞–∫–æ–Ω –æ —Å—É–≤–µ—Ä–µ–Ω–Ω–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ...",
            "–Ø–Ω–¥–µ–∫—Å: '–ú—ã –∑–∞ —Å–≤–æ–±–æ–¥–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç, –Ω–æ –ø–æ–Ω–∏–º–∞–µ–º...'",
            "Telegram —Å–Ω–æ–≤–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç. –†–ö–ù: '–≠—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–æ'...",
            "–ü—Ä–æ—Ç–µ—Å—Ç—ã –≤ –ú–æ—Å–∫–≤–µ: –∑–∞–¥–µ—Ä–∂–∞–Ω—ã 200 —á–µ–ª–æ–≤–µ–∫...",
            "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–æ–¥–æ–∂–≥–ª–∏ –æ—Ñ–∏—Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞...",
            "–•–∞–∫–µ—Ä—ã –∞—Ç–∞–∫–æ–≤–∞–ª–∏ —Å–∞–π—Ç –†–æ—Å–∫–æ–º–Ω–∞–¥–∑–æ—Ä–∞...",
            "–ú–∏—Ç–∏–Ω–≥–∏ –ø—Ä–æ—Ç–∏–≤ —Ü–µ–Ω–∑—É—Ä—ã –ø—Ä–æ—à–ª–∏ –≤ 15 –≥–æ—Ä–æ–¥–∞—Ö...",
            "YouTube –∑–∞–º–µ–¥–ª–µ–Ω –Ω–∞ 90% –ø–æ –≤—Å–µ–π –†–æ—Å—Å–∏–∏...",
            "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–æ–∑–¥–∞—é—Ç mesh-—Å–µ—Ç–∏ –≤ –æ–±—Ö–æ–¥ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫...",
            "–í –ì–æ—Å–¥—É–º–µ –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∏ –≤–≤–µ—Å—Ç–∏ '–±–µ–ª—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç'...",
            "–û–ú–û–ù —Ä–∞–∑–æ–≥–Ω–∞–ª –º–∏—Ç–∏–Ω–≥ —É –∑–¥–∞–Ω–∏—è –†–ö–ù...",
        ];

        // === RANKS ===
        const ranks = [
            { blocks: 0, name: "üëî –°—Ç–∞–∂—ë—Ä-–ª–æ—Ö" },
            { blocks: 100, name: "üìã –ú–ª. –±–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫" },
            { blocks: 500, name: "üñ•Ô∏è –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç" },
            { blocks: 2000, name: "‚ö° –°—Ç. —Ü–µ–Ω–∑–æ—Ä" },
            { blocks: 10000, name: "üéñÔ∏è –ö–∞–ø–∏—Ç–∞–Ω" },
            { blocks: 50000, name: "üëë –ì–µ–Ω–µ—Ä–∞–ª" },
            { blocks: 200000, name: "üíÄ –ü–∞–ª–∞—á –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞" }
        ];

        // === CHAPTERS ===
        const chapters = [
            { num: "I", title: "–ü–ï–†–í–´–ô –î–ï–ù–¨", trigger: 0 },
            { num: "II", title: "–°–û–ü–†–û–¢–ò–í–õ–ï–ù–ò–ï", trigger: 500 },
            { num: "III", title: "–≠–°–ö–ê–õ–ê–¶–ò–Ø", trigger: 5000 },
            { num: "IV", title: "–í–û–ô–ù–ê", trigger: 30000 },
            { num: "V", title: "–ö–û–ù–ï–¶ –ò–ì–†–´", trigger: 200000 }
        ];

        // === TARGETS ===
        const targets = [
            { 
                name: "üé∞ –û–Ω–ª–∞–π–Ω-–∫–∞–∑–∏–Ω–æ", 
                required: 50, 
                reward: 100,
                tensionAdd: 2,
                dialog: { avatar: "üë®‚Äçüíº", name: "–ü–µ—Ç—Ä–æ–≤–∏—á", role: "–ù–∞—á–∞–ª—å–Ω–∏–∫", text: "–ù—É —á—ë, —Å–∞–ª–∞–≥–∞, –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å? –î–∞–≤–∞–π, –∑–∞–≤–∞–ª–∏ —ç—Ç–∏ —ë–±–∞–Ω—ã–µ –∫–∞–∑–∏–Ω–æ. –ü—Ä–æ—Å—Ç–æ, –∫–∞–∫ –¥–≤–∞ –ø–∞–ª—å—Ü–∞ –æ–±–æ—Å—Å–∞—Ç—å." },
                completion: "–ö–∞–∑–∏–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã! –ü–µ—Ç—Ä–æ–≤–∏—á: ¬´–ú–æ–ª–æ–¥–µ—Ü, –Ω–µ –æ–±–æ—Å—Ä–∞–ª—Å—è. –ü–æ–∫–∞.¬ª",
                news: "–†–ö–ù –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª 150 –æ–Ω–ª–∞–π–Ω-–∫–∞–∑–∏–Ω–æ –∑–∞ –¥–µ–Ω—å"
            },
            { 
                name: "üíä –ê–ø—Ç–µ–∫–∏ —Å –¥–æ–ø–∏–Ω–≥–æ–º", 
                required: 120, 
                reward: 180,
                tensionAdd: 3,
                dialog: { avatar: "üë©‚Äçüíª", name: "–ú–∞—Ä–∏–Ω–∫–∞", role: "–ö–æ–ª–ª–µ–≥–∞", text: "–ü—Ä–∏–≤–µ—Ç! –°–ª—ã—à–∞–ª–∞, —Ç—ã –∫–∞–∑–∏–Ω–æ –∑–∞–≤–∞–ª–∏–ª? –¢–µ–ø–µ—Ä—å —ç—Ç–∏ –∞–ø—Ç–µ–∫–∏ –µ–±—É—á–∏–µ. –¢–∞–º –≤–∏–∞–≥—Ä—É –±–µ–∑ —Ä–µ—Ü–µ–ø—Ç–∞ –ø—Ä–æ–¥–∞—é—Ç, –ø—Ä–∏–∫–∏–Ω—å." },
                completion: "–ê–ø—Ç–µ–∫–∏ –∑–∞–±–ª–æ—á–µ–Ω—ã! –ü—Ä–æ–¥–∞–∂–∏ –≤ –æ–±—ã—á–Ω—ã—Ö –∞–ø—Ç–µ–∫–∞—Ö –≤—ã—Ä–æ—Å–ª–∏ –Ω–∞ 200%.",
                news: "–ù–µ–ª–µ–≥–∞–ª—å–Ω—ã–µ –æ–Ω–ª–∞–π–Ω-–∞–ø—Ç–µ–∫–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –†–ö–ù"
            },
            { 
                name: "üì± Telegram (–ø–æ–ø—ã—Ç–∫–∞ #1)", 
                required: 300, 
                reward: 350,
                tensionAdd: 15,
                hasChoice: true,
                choiceId: 'telegram1',
                dialog: { avatar: "üòà", name: "–°–∏—Å—Ç–µ–º–∞", role: "–ü—Ä–∏–∫–∞–∑ —Å–≤–µ—Ä—Ö—É", text: "–í–ù–ò–ú–ê–ù–ò–ï! –ü—Ä–∏–∫–∞–∑ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å Telegram. –î—É—Ä–æ–≤ –ø–æ—Å–ª–∞–ª –≤—Å–µ—Ö –Ω–∞—Ö—É–π. –ü–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∏—Ç—å." },
                completion: "Telegram –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω! –ù–∞ 2 —á–∞—Å–∞. –ü–æ—Ç–æ–º —Å–Ω–æ–≤–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ö–ª–∞—Å—Å–∏–∫–∞.",
                news: "Telegram –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ —è—Ä–æ—Å—Ç–∏"
            },
            { 
                name: "üê¶ Twitter/X", 
                required: 600, 
                reward: 500,
                tensionAdd: 20,
                dialog: { avatar: "üë®‚Äçüíº", name: "–ü–µ—Ç—Ä–æ–≤–∏—á", role: "–ù–∞—á–∞–ª—å–Ω–∏–∫", text: "–ú–∞—Å–∫, —Å—É–∫–∞, —Ç—Ä–æ–ª–ª–∏—Ç –Ω–∞—Å –≤ —Ç–≤–∏—Ç—Ç–µ—Ä–µ. –ü–∏—à–µ—Ç 'Russia blocks freedom'. –ó–∞–±–ª–æ—á–∏ —ç—Ç—É —Ö—É–π–Ω—é –Ω–∞—Ö–µ—Ä!" },
                completion: "Twitter –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω! –ú–∞—Å–∫ –Ω–∞–ø–∏—Å–∞–ª: 'Sad.' –∏ –ø–æ–ª–µ—Ç–µ–ª –Ω–∞ –ú–∞—Ä—Å.",
                news: "Twitter/X –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –†–§"
            },
            {
                name: "üì∏ Instagram*",
                required: 1200,
                reward: 900,
                tensionAdd: 25,
                dialog: { avatar: "üë©‚Äçüíª", name: "–ú–∞—Ä–∏–Ω–∫–∞", role: "–ö–æ–ª–ª–µ–≥–∞", text: "–ò–Ω—Å—Ç–∞ ‚Äî —ç—Ç–æ –ø–∏–∑–¥–µ—Ü. –ò–Ω—Ñ–æ—Ü—ã–≥–∞–Ω–µ, –∂–æ–ø—ã, –º–∞—Ä–∞—Ñ–æ–Ω—ã –∂–µ–ª–∞–Ω–∏–π... –ü–æ—Ä–∞ —ç—Ç–æ –≥–æ–≤–Ω–æ –ø—Ä–∏–∫—Ä—ã—Ç—å." },
                completion: "Instagram –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω! –ò–Ω—Ñ–ª—é–µ–Ω—Å–µ—Ä—ã –æ—Å–≤–∞–∏–≤–∞—é—Ç –û–¥–Ω–æ–∫–ª–∞—Å—Å–Ω–∏–∫–∏.",
                news: "Instagram –ø—Ä–∏–∑–Ω–∞–Ω —ç–∫—Å—Ç—Ä–µ–º–∏—Å—Ç—Å–∫–∏–º –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω",
                triggerEvent: 'protest_small'
            },
            {
                name: "üé¨ YouTube",
                required: 3000,
                reward: 2000,
                tensionAdd: 40,
                isBoss: true,
                bossHealth: 5000,
                hasChoice: true,
                choiceId: 'youtube',
                dialog: { avatar: "‚öîÔ∏è", name: "–ë–û–°–°: YouTube", role: "–ì–∏–≥–∞–Ω—Ç", text: "–≠—Ç–æ —Å–µ—Ä—å—ë–∑–Ω–æ. YouTube ‚Äî –Ω–µ —Ö—É—Ö—Ä—ã-–º—É—Ö—Ä—ã. –ú–∏–ª–ª–∏–æ–Ω—ã —Å–º–æ—Ç—Ä—è—Ç. –ì–æ—Ç–æ–≤—å—Å—è –∫ –ø–∏–∑–¥–µ—Ü—É, –µ—Å–ª–∏ –∑–∞–±–ª–æ—á–∏—à—å." },
                completion: "YOUTUBE –ü–ê–õ! –°—Ç—Ä–∞–Ω–∞ –≤ —à–æ–∫–µ. RuTube —É–ø–∞–ª –æ—Ç –Ω–∞–ø–ª—ã–≤–∞. –û–±–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø–µ—á–∞–ª–∏.",
                news: "–°–†–û–ß–ù–û: YouTube –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –†–æ—Å—Å–∏–∏",
                triggerEvent: 'car_bomb'
            },
            {
                name: "üîç Google",
                required: 6000,
                reward: 4000,
                tensionAdd: 35,
                dialog: { avatar: "üéñÔ∏è", name: "–ì–µ–Ω–µ—Ä–∞–ª", role: "–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ", text: "Google –∑–Ω–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ. –ü–æ—Ä–∞ –∏–º –Ω–∞–ø–æ–º–Ω–∏—Ç—å, –∫—Ç–æ —Ç—É—Ç –≥–ª–∞–≤–Ω—ã–π. –Ø–Ω–¥–µ–∫—Å —É–∂–µ –ø–æ—Ç–∏—Ä–∞–µ—Ç —Ä—É–∫–∏." },
                completion: "Google –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω! –Ø–Ω–¥–µ–∫—Å —É—Å—Ç—Ä–æ–∏–ª –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤ –Ω–∞ –Ω–µ–¥–µ–ª—é.",
                news: "Google –∏ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –≤ –†–§",
                triggerEvent: 'house_fire'
            },
            {
                name: "üìñ Wikipedia",
                required: 10000,
                reward: 6000,
                tensionAdd: 30,
                dialog: { avatar: "üë®‚Äçüíº", name: "–ü–µ—Ç—Ä–æ–≤–∏—á", role: "–ù–∞—á–∞–ª—å–Ω–∏–∫", text: "–í–∏–∫–∏–ø–µ–¥–∏—è ‚Äî —Ä–∞—Å—Å–∞–¥–Ω–∏–∫ –≤—Ä–∞–∂–µ—Å–∫–æ–π –ø—Ä–æ–ø–∞–≥–∞–Ω–¥—ã! –¢–∞–º –Ω–∞–ø–∏—Å–∞–Ω–æ, —á—Ç–æ –ó–µ–º–ª—è –∫—Ä—É–≥–ª–∞—è. –≠—Ç–æ –ø—Ä–æ–≤–æ–∫–∞—Ü–∏—è!" },
                completion: "Wikipedia –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞! –¢–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –ë–°–≠ 1978 –≥–æ–¥–∞.",
                news: "Wikipedia –≤–Ω–µ—Å–µ–Ω–∞ –≤ —Ä–µ–µ—Å—Ç—Ä –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö —Å–∞–π—Ç–æ–≤"
            },
            {
                name: "üí¨ WhatsApp",
                required: 18000,
                reward: 10000,
                tensionAdd: 35,
                dialog: { avatar: "üì±", name: "–ñ–µ–Ω–∞", role: "–õ–∏—á–Ω–æ–µ", text: "–î–æ—Ä–æ–≥–æ–π, –µ—Å–ª–∏ —Ç—ã –∑–∞–±–ª–æ—á–∏—à—å –≤–æ—Ç—Å–∞–ø, —è —Ç–µ–±—è —É–±—å—é. –ö–∞–∫ —è –±—É–¥—É —Å –º–∞–º–æ–π –æ–±—â–∞—Ç—å—Å—è?!" },
                completion: "WhatsApp –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω! –ë–∞–±—É—à–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥—è—Ç –Ω–∞ –≥–æ–ª—É–±–∏–Ω—É—é –ø–æ—á—Ç—É.",
                news: "WhatsApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–¥–∞–∂–∏ –≥–æ–ª—É–±–µ–π –≤—ã—Ä–æ—Å–ª–∏ –Ω–∞ 500%",
                triggerEvent: 'family_threat'
            },
            {
                name: "üéÆ Steam",
                required: 30000,
                reward: 18000,
                tensionAdd: 45,
                isBoss: true,
                bossHealth: 40000,
                dialog: { avatar: "‚öîÔ∏è", name: "–ë–û–°–°: –ì–µ–π–± –ù—å—é—ç–ª–ª", role: "–ü–æ–≤–µ–ª–∏—Ç–µ–ª—å —Å–∫–∏–¥–æ–∫", text: "–¢–´ –ü–û–°–ú–ï–õ?! –Ø –°–û–ó–î–ê–õ HALF-LIFE! –Ø –ë–û–ì –ì–ï–ô–ú–ï–†–û–í! –¢–´ –¢–†–£–ü, –°–õ–´–®–ò–®–¨?!" },
                completion: "STEAM –£–ù–ò–ß–¢–û–ñ–ï–ù! –ì–µ–π–º–µ—Ä—ã —Ä—ã–¥–∞—é—Ç. –ü—Ä–æ–¥–∞–∂–∏ —à–∞—Ö–º–∞—Ç –≤—ã—Ä–æ—Å–ª–∏.",
                news: "Steam –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –ì–µ–π–º–µ—Ä—ã –≤—ã—à–ª–∏ –Ω–∞ —É–ª–∏—Ü—ã",
                triggerEvent: 'assassination_attempt'
            },
            {
                name: "‚òÅÔ∏è –í—Å–µ VPN",
                required: 60000,
                reward: 35000,
                tensionAdd: 50,
                hasChoice: true,
                choiceId: 'vpn_all',
                dialog: { avatar: "üéñÔ∏è", name: "–ì–µ–Ω–µ—Ä–∞–ª", role: "–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ", text: "–≠—Ç–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ, –≥–æ–≤–æ—Ä–∏–ª–∏ –æ–Ω–∏. VPN –Ω–µ–ª—å–∑—è –∑–∞–±–ª–æ—á–∏—Ç—å, –≥–æ–≤–æ—Ä–∏–ª–∏ –æ–Ω–∏. –ü–æ–∫–∞–∂–∏ –∏–º, —Å—ã–Ω–æ–∫." },
                completion: "–í–°–ï VPN –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–´! –ö–∞–∫?! –ú–∞–≥–∏—è, –±–ª—è—Ç—å, –Ω–µ –∏–Ω–∞—á–µ.",
                news: "–†–ö–ù –∑–∞—è–≤–∏–ª –æ –ø–æ–ª–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ VPN-—Å–µ—Ä–≤–∏—Å–æ–≤",
                triggerEvent: 'mass_protests'
            },
            {
                name: "üåê –í–µ—Å—å IPv4",
                required: 120000,
                reward: 70000,
                tensionAdd: 60,
                dialog: { avatar: "üòà", name: "–°–∏—Å—Ç–µ–º–∞", role: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ", text: "–¢—ã —Å–æ–±–∏—Ä–∞–µ—à—å—Å—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –§–£–ù–î–ê–ú–ï–ù–¢ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞. IPv4. –í—Å—é –∞–¥—Ä–µ—Å–∞—Ü–∏—é. –¢—ã —Ç–æ—á–Ω–æ —ë–±–Ω—É—Ç—ã–π." },
                completion: "IPv4 –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù! –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ —Å–ª–æ–º–∞–Ω. –ö–∞–∫-—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç.",
                news: "–≠–ö–°–¢–†–ï–ù–ù–û: –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–¥ —É–≥—Ä–æ–∑–æ–π"
            },
            {
                name: "üíÄ –í–ï–°–¨ –ò–ù–¢–ï–†–ù–ï–¢",
                required: 300000,
                reward: 0,
                tensionAdd: 100,
                isBoss: true,
                bossHealth: 150000,
                hasChoice: true,
                choiceId: 'final',
                dialog: { avatar: "üåê", name: "–ò–ù–¢–ï–†–ù–ï–¢", role: "–§–∏–Ω–∞–ª—å–Ω—ã–π –±–æ—Å—Å", text: "–¢–ê–ö –¢–´ –î–û–®–Å–õ –î–û –ú–ï–ù–Ø?! –Ø ‚Äî –ò–ù–¢–ï–†–ù–ï–¢! –Ø –í–ò–î–ï–õ –í–°–Å! –ò –¢–´... –•–û–ß–ï–®–¨ –ú–ï–ù–Ø –£–ù–ò–ß–¢–û–ñ–ò–¢–¨?!" },
                completion: "–§–ò–ù–ê–õ",
                isEnding: true
            }
        ];

        // === EVENTS ===
        const gameEvents = {
            protest_small: {
                icon: "üì¢",
                title: "–ú–ò–¢–ò–ù–ì",
                text: "–£ –∑–¥–∞–Ω–∏—è –†–ö–ù —Å–æ–±—Ä–∞–ª–∏—Å—å 500 —á–µ–ª–æ–≤–µ–∫ —Å –ø–ª–∞–∫–∞—Ç–∞–º–∏ '–†—É–∫–∏ –ø—Ä–æ—á—å –æ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞!' –∏ '–¶–µ–Ω–∑–æ—Ä—ã ‚Äî –ø–æ–∑–æ—Ä —Å—Ç—Ä–∞–Ω—ã!'<br><br>–û–ú–û–ù —Ä–∞–∑–æ–≥–Ω–∞–ª –∑–∞ —á–∞—Å. –ù–æ —ç—Ç–æ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ...",
                tensionAdd: 10,
                healthLoss: 0
            },
            car_bomb: {
                icon: "üí•",
                title: "–ü–û–ö–£–®–ï–ù–ò–ï",
                text: "–£—Ç—Ä–æ–º —Ç—ã –≤—ã—à–µ–ª –∫ –º–∞—à–∏–Ω–µ. –ù–∞–∂–∞–ª –±—Ä–µ–ª–æ–∫...<br><br>–ë–ê–ë–ê–•!<br><br>–ú–∞—à–∏–Ω–∞ –≤–∑–æ—Ä–≤–∞–ª–∞—Å—å –∫ —Ö—É—è–º. –¢—ã —á—É–¥–æ–º –≤—ã–∂–∏–ª ‚Äî –∑–∞–±—ã–ª –∫–ª—é—á–∏ –¥–æ–º–∞ –∏ –≤–µ—Ä–Ω—É–ª—Å—è.<br><br>–ö—Ç–æ-—Ç–æ –æ—á–µ–Ω—å –Ω–µ–¥–æ–≤–æ–ª–µ–Ω —Ç–≤–æ–µ–π —Ä–∞–±–æ—Ç–æ–π.",
                tensionAdd: 5,
                healthLoss: 30,
                news: "–ü–æ–∫—É—à–µ–Ω–∏–µ –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –†–ö–ù: –≤–∑–æ—Ä–≤–∞–Ω –∞–≤—Ç–æ–º–æ–±–∏–ª—å"
            },
            house_fire: {
                icon: "üî•",
                title: "–ü–û–î–ñ–û–ì",
                text: "–ù–æ—á—å—é –∑–∞–≥–æ—Ä–µ–ª–∞—Å—å —Ç–≤–æ—è –∫–≤–∞—Ä—Ç–∏—Ä–∞. –°–æ—Å–µ–¥–∏ –≤—ã–∑–≤–∞–ª–∏ –ø–æ–∂–∞—Ä–Ω—ã—Ö.<br><br>–¢—ã –ø–æ—Ç–µ—Ä—è–ª –ø–æ—á—Ç–∏ –≤—Å—ë. –ù–∞ —Å—Ç–µ–Ω–µ –∫—Ä–∞—Å–∫–æ–π –Ω–∞–ø–∏—Å–∞–Ω–æ: '–°–õ–ï–î–£–Æ–©–ò–ô –†–ê–ó ‚Äî –¢–´'<br><br>–ñ–µ–Ω–∞ —É—à–ª–∞ –∫ –º–∞–º–µ. –°–∫–∞–∑–∞–ª–∞, —á—Ç–æ —Ç—ã —ë–±–Ω—É—Ç—ã–π.",
                tensionAdd: 10,
                healthLoss: 20,
                news: "–ü–æ–¥–∂–æ–≥ –∫–≤–∞—Ä—Ç–∏—Ä—ã —á–∏–Ω–æ–≤–Ω–∏–∫–∞: –ø–æ–¥–æ–∑—Ä–µ–≤–∞—é—Ç —ç–∫—Å—Ç—Ä–µ–º–∏—Å—Ç–æ–≤"
            },
            family_threat: {
                icon: "üë®‚Äçüë©‚Äçüëß",
                title: "–£–ì–†–û–ó–´ –°–ï–ú–¨–ï",
                text: "–¢–≤–æ–µ–π –∂–µ–Ω–µ –ø—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏ –¥–µ—Ç–µ–π –∏–∑ —à–∫–æ–ª—ã.<br><br>'–ü–∞–ø–∞ –¥–µ–ª–∞–µ—Ç –ø–ª–æ—Ö–∏–µ –≤–µ—â–∏. –ü—É—Å—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è. –ò–ª–∏ –º—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–º.'<br><br>–ñ–µ–Ω–∞ –≤ –∏—Å—Ç–µ—Ä–∏–∫–µ. –î–µ—Ç–∏ –Ω–∞–ø—É–≥–∞–Ω—ã. –¢—ã...",
                tensionAdd: 15,
                healthLoss: 15
            },
            assassination_attempt: {
                icon: "üî´",
                title: "–ù–ê–ü–ê–î–ï–ù–ò–ï",
                text: "–¢—ã –≤—ã—à–µ–ª –∏–∑ –æ—Ñ–∏—Å–∞ –≤–µ—á–µ—Ä–æ–º. –î–≤–æ–µ –≤ –º–∞—Å–∫–∞—Ö –ø–æ–¥–±–µ–∂–∞–ª–∏ —Å–∑–∞–¥–∏.<br><br>–£–¥–∞—Ä –ø–æ –≥–æ–ª–æ–≤–µ. –ü–∏–Ω–∫–∏. '–≠—Ç–æ —Ç–µ–±–µ –∑–∞ Steam, —Å—É–∫–∞!'<br><br>–û—Ö—Ä–∞–Ω–∞ —Å–ø—É–≥–Ω—É–ª–∞. –¢—ã –≤ –±–æ–ª—å–Ω–∏—Ü–µ –Ω–µ–¥–µ–ª—é.",
                tensionAdd: 20,
                healthLoss: 40,
                news: "–ù–∞–ø–∞–¥–µ–Ω–∏–µ –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –†–ö–ù: –¥–≤–æ–µ –≤ —Ä–æ–∑—ã—Å–∫–µ"
            },
            mass_protests: {
                icon: "üî•",
                title: "–ú–ê–°–°–û–í–´–ï –ü–†–û–¢–ï–°–¢–´",
                text: "–ü–æ –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–µ –≤—ã—à–ª–∏ –ú–ò–õ–õ–ò–û–ù–´. –ú–æ—Å–∫–≤–∞, –ü–∏—Ç–µ—Ä, –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫...<br><br>'–°–í–û–ë–û–î–£ –ò–ù–¢–ï–†–ù–ï–¢–£!'<br>'–†–ö–ù ‚Äî –í–†–ê–ì–ò –ù–ê–†–û–î–ê!'<br><br>–ï—Å—Ç—å –ø–æ–≥–∏–±—à–∏–µ. –¢–≤–æ—ë —Ñ–æ—Ç–æ –Ω–∞ –ø–ª–∞–∫–∞—Ç–∞—Ö —Å –Ω–∞–¥–ø–∏—Å—å—é '–†–ê–ó–´–°–ö–ò–í–ê–ï–¢–°–Ø'.",
                tensionAdd: 30,
                healthLoss: 25,
                news: "–ú–∞—Å—Å–æ–≤—ã–µ –ø—Ä–æ—Ç–µ—Å—Ç—ã –ø—Ä–æ—Ç–∏–≤ –†–ö–ù: –∑–∞–¥–µ—Ä–∂–∞–Ω—ã —Ç—ã—Å—è—á–∏"
            }
        };

        // === CHOICES ===
        const gameChoices = {
            telegram1: {
                icon: "üì±",
                title: "–ü–†–ò–ö–ê–ó: TELEGRAM",
                text: "–°–≤–µ—Ä—Ö—É –ø—Ä–∏—à—ë–ª –ø—Ä–∏–∫–∞–∑ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å Telegram. –î—É—Ä–æ–≤ –ø—É–±–ª–∏—á–Ω–æ –ø–æ—Å–ª–∞–ª –†–ö–ù –Ω–∞—Ö—É–π.<br><br>–ù–æ —Ç—ã –∑–Ω–∞–µ—à—å ‚Äî –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç. –¢–æ–ª—å–∫–æ —Ä–∞–∑–æ–∑–ª–∏—Ç –ª—é–¥–µ–π.<br><br>–ß—Ç–æ –¥–µ–ª–∞–µ—à—å?",
                options: [
                    { text: "–ë–õ–û–ö–ò–†–û–í–ê–¢–¨", subtext: "–ü—Ä–∏–∫–∞–∑ –µ—Å—Ç—å –ø—Ä–∏–∫–∞–∑", action: 'block', tensionAdd: 20 },
                    { text: "–°–ê–ë–û–¢–ò–†–û–í–ê–¢–¨", subtext: "–°–¥–µ–ª–∞—Ç—å –≤–∏–¥, —á—Ç–æ –±–ª–æ—á–∏—à—å", action: 'sabotage', tensionAdd: -5, riskFire: 30 }
                ]
            },
            youtube: {
                icon: "üé¨",
                title: "–†–ï–®–ï–ù–ò–ï: YOUTUBE",
                text: "YouTube ‚Äî —ç—Ç–æ –Ω–µ —à—É—Ç–∫–∏. –ú–∏–ª–ª–∏–æ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –î–µ—Ç—Å–∫–∏–µ –∫–∞–Ω–∞–ª—ã. –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ. –ú—É–∑—ã–∫–∞.<br><br>–ï—Å–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—à—å ‚Äî –±—É–¥–µ—Ç –ü–ò–ó–î–ï–¶. –ü—Ä–æ—Ç–µ—Å—Ç—ã, —É–≥—Ä–æ–∑—ã, –º–æ–∂–µ—Ç –¥–∞–∂–µ —Ö—É–∂–µ.<br><br>–ì–µ–Ω–µ—Ä–∞–ª –∑–≤–æ–Ω–∏—Ç –∫–∞–∂–¥—ã–π —á–∞—Å. '–ö–æ–≥–¥–∞?!'<br><br>–¢–≤–æ–π —Ö–æ–¥.",
                options: [
                    { text: "–ó–ê–ë–õ–û–ö–ò–†–û–í–ê–¢–¨", subtext: "–í—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–∏–∫–∞–∑ –ª—é–±–æ–π —Ü–µ–Ω–æ–π", action: 'block', tensionAdd: 40 },
                    { text: "–£–í–û–õ–ò–¢–¨–°–Ø", subtext: "–ù–∞—Ö—É–π —ç—Ç—É —Ä–∞–±–æ—Ç—É", action: 'quit_youtube', isEnding: true }
                ]
            },
            vpn_all: {
                icon: "‚òÅÔ∏è",
                title: "–§–ò–ù–ê–õ–¨–ù–´–ô –†–£–ë–ï–ñ: VPN",
                text: "–¢—ã –ø–æ–ª—É—á–∏–ª –¥–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–µ –≥–ª—É–±–æ–∫–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏. –ú–æ–∂–µ—à—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –í–°–ï VPN —Ä–∞–∑–æ–º.<br><br>–ù–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø—É—Ç–∏ –Ω–∞–∑–∞–¥ –Ω–µ –±—É–¥–µ—Ç. –¢—ã —Å—Ç–∞–Ω–µ—à—å –≤—Ä–∞–≥–æ–º ‚Ññ1 –¥–ª—è –º–∏–ª–ª–∏–æ–Ω–æ–≤.<br><br>–û—Ö—Ä–∞–Ω–∞ —É–∂–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ—Ç —Ç–µ–±—è 24/7. –ñ–µ–Ω–∞ —É—à–ª–∞. –î–µ—Ç–∏ —Ç–µ–±—è –±–æ—è—Ç—Å—è.<br><br>–°—Ç–æ–∏—Ç –ª–∏ –æ–Ω–æ —Ç–æ–≥–æ?",
                options: [
                    { text: "–ó–ê–ë–õ–û–ö–ò–†–û–í–ê–¢–¨ –í–°–Å", subtext: "–î–æ–≤–µ—Å—Ç–∏ –¥–µ–ª–æ –¥–æ –∫–æ–Ω—Ü–∞", action: 'block', tensionAdd: 50 },
                    { text: "–°–õ–ò–¢–¨ –î–ê–ù–ù–´–ï", subtext: "–ü–µ—Ä–µ–¥–∞—Ç—å –≤—Å—ë –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–∞–º –∏ –±–µ–∂–∞—Ç—å", action: 'leak', isEnding: true },
                    { text: "–£–í–û–õ–ò–¢–¨–°–Ø", subtext: "–ü—Ä–æ—Å—Ç–æ —É–π—Ç–∏, –ø–æ–∫–∞ –∂–∏–≤", action: 'quit_vpn', isEnding: true }
                ]
            },
            final: {
                icon: "üåê",
                title: "–§–ò–ù–ê–õ: –í–ï–°–¨ –ò–ù–¢–ï–†–ù–ï–¢",
                text: "–¢—ã —Å—Ç–æ–∏—à—å –ø–µ—Ä–µ–¥ –≥–ª–∞–≤–Ω—ã–º —Ä—É–±–∏–ª—å–Ω–∏–∫–æ–º. –û–¥–Ω–æ –Ω–∞–∂–∞—Ç–∏–µ ‚Äî –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –≤ –†–æ—Å—Å–∏–∏ —É–º—Ä—ë—Ç –Ω–∞–≤—Å–µ–≥–¥–∞.<br><br>–°–Ω–∞—Ä—É–∂–∏ ‚Äî –∞—Ä–º–∏—è. –í–Ω—É—Ç—Ä–∏ ‚Äî —Ç—ã –æ–¥–∏–Ω.<br><br>–ó–∞ —Å–ø–∏–Ω–æ–π ‚Äî —Å–æ—Ç–Ω–∏ —Ç—ã—Å—è—á –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–∞–π—Ç–æ–≤. –í–ø–µ—Ä–µ–¥–∏ ‚Äî —Ç–µ–º–Ω–æ—Ç–∞.<br><br>–ì–æ–ª–æ—Å –≤ –≥–æ–ª–æ–≤–µ: '–≠—Ç–æ –ø—Ä–∞–≤–¥–∞ —Ç–æ–≥–æ —Å—Ç–æ–∏–ª–æ?'<br><br>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–±–æ—Ä.",
                options: [
                    { text: "–ù–ê–ñ–ê–¢–¨", subtext: "–ó–∞–≤–µ—Ä—à–∏—Ç—å –Ω–∞—á–∞—Ç–æ–µ", action: 'block', isEnding: true, endingType: 'internet_dead' },
                    { text: "–£–ô–¢–ò", subtext: "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å—Å—è –∏ —É–π—Ç–∏ –≤ –Ω–æ—á—å", action: 'walk_away', isEnding: true, endingType: 'walk_away' },
                    { text: "–†–ê–ó–†–£–®–ò–¢–¨ –°–ò–°–¢–ï–ú–£", subtext: "–£–Ω–∏—á—Ç–æ–∂–∏—Ç—å –≤—Å—ë, –≤–∫–ª—é—á–∞—è —Å–µ–±—è", action: 'destroy', isEnding: true, endingType: 'martyr' }
                ]
            },
            low_health: {
                icon: "üíÄ",
                title: "–¢–´ –ü–†–ò –°–ú–ï–†–¢–ò",
                text: "–ü–æ–∫—É—à–µ–Ω–∏—è, –∏–∑–±–∏–µ–Ω–∏—è, —Å—Ç—Ä–µ—Å—Å... –¢–≤–æ—ë —Ç–µ–ª–æ —Å–¥–∞—ë—Ç. –í—Ä–∞—á–∏ –≥–æ–≤–æ—Ä—è—Ç: –µ—â—ë –æ–¥–∏–Ω —É–¥–∞—Ä ‚Äî –∏ –≤—Å—ë.<br><br>–û—Ö—Ä–∞–Ω–∞ –Ω–µ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è. –í—Ä–∞–≥–∏ –≤–µ–∑–¥–µ.<br><br>–ú–æ–∂–µ—Ç, —Ö–≤–∞—Ç–∏—Ç?",
                options: [
                    { text: "–ü–†–û–î–û–õ–ñ–ê–¢–¨", subtext: "–£–º—Ä—É, –Ω–æ –Ω–µ —Å–¥–∞–º—Å—è", action: 'continue' },
                    { text: "–£–ô–¢–ò –ù–ê –ü–ï–ù–°–ò–Æ", subtext: "–ó–¥–æ—Ä–æ–≤—å–µ –≤–∞–∂–Ω–µ–µ", action: 'retire', isEnding: true, endingType: 'retired' }
                ]
            },
            high_tension: {
                icon: "üî•",
                title: "–¢–û–ß–ö–ê –ö–ò–ü–ï–ù–ò–Ø",
                text: "–ù–∞—Ä–æ–¥–Ω—ã–π –≥–Ω–µ–≤ –Ω–∞ –ø—Ä–µ–¥–µ–ª–µ! –ú–∏—Ç–∏–Ω–≥–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å. –¢–≤–æ—ë –∏–º—è —Å–∫–∞–Ω–¥–∏—Ä—É—é—Ç –∫–∞–∫ –ø—Ä–æ–∫–ª—è—Ç–∏–µ.<br><br>–ì–µ–Ω–µ—Ä–∞–ª –∑–≤–æ–Ω–∏—Ç: '–ò–ª–∏ —Ç—ã, –∏–ª–∏ –º—ã –≤—Å–µ –≥–æ—Ä–∏–º.'<br><br>–ß—Ç–æ –±—É–¥–µ—à—å –¥–µ–ª–∞—Ç—å?",
                options: [
                    { text: "–ü–†–û–î–û–õ–ñ–ê–¢–¨", subtext: "–ü—É—Å—Ç—å –≥–æ—Ä–∏—Ç –≤—Å—ë", action: 'continue', tensionAdd: 10 },
                    { text: "–°–ë–ï–ñ–ê–¢–¨ –ó–ê –ì–†–ê–ù–ò–¶–£", subtext: "–ü–æ–∫–∞ –Ω–µ –ø–æ–∑–¥–Ω–æ", action: 'escape', isEnding: true, endingType: 'escaped' }
                ]
            }
        };

        // === UPGRADES ===
        const upgradesData = [
            { id: 'intern', name: 'üë®‚Äçüíº –°—Ç–∞–∂—ë—Ä', desc: '+1/—Å–µ–∫', basePrice: 50, mult: 1.5, effect: 'perSecond', value: 1 },
            { id: 'bot', name: 'ü§ñ –ë–æ—Ç', desc: '+10/—Å–µ–∫', basePrice: 500, mult: 1.6, effect: 'perSecond', value: 10 },
            { id: 'ai', name: 'üß† –ù–µ–π—Ä–æ—Å–µ—Ç—å', desc: '+50/—Å–µ–∫', basePrice: 3000, mult: 1.7, effect: 'perSecond', value: 50 },
            { id: 'quantum', name: '‚öõÔ∏è –ö–≤–∞–Ω—Ç—É–º', desc: '+200/—Å–µ–∫', basePrice: 15000, mult: 1.8, effect: 'perSecond', value: 200 },
            { id: 'mouse', name: 'üñ±Ô∏è –ú—ã—à—å', desc: '+2/–∫–ª–∏–∫', basePrice: 100, mult: 2, effect: 'perClick', value: 2 },
            { id: 'macro', name: '‚å®Ô∏è –ú–∞–∫—Ä–æ—Å', desc: '+10/–∫–ª–∏–∫', basePrice: 800, mult: 2.2, effect: 'perClick', value: 10 },
            { id: 'armor', name: 'üõ°Ô∏è –ë—Ä–æ–Ω—è', desc: '+20 HP', basePrice: 1000, mult: 2, effect: 'health', value: 20 },
            { id: 'bunker', name: 'üè† –ë—É–Ω–∫–µ—Ä', desc: '-10% –≥–Ω–µ–≤–∞', basePrice: 5000, mult: 2.5, effect: 'tension', value: -10 }
        ];


        // === ACHIEVEMENTS DATA ===
        const achievementsData = [
            { id:'first_click', icon:'üñ±Ô∏è', name:'–ü–µ—Ä–≤—ã–π —â–µ–ª—á–æ–∫', desc:'–ù–∞–∂–º–∏ ‚Äú–ë–õ–û–ö–ò–†–û–í–ê–¢–¨‚Äù 1 —Ä–∞–∑.', progress: () => `${Math.min(1, gameState.clicks||0)}/1` },
            { id:'first_upgrade', icon:'‚¨ÜÔ∏è', name:'–ë—é–¥–∂–µ—Ç –æ—Å–≤–æ–µ–Ω', desc:'–ö—É–ø–∏ –ø–µ—Ä–≤–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ.', progress: () => `${Math.min(1, gameState.upgradeBuys||0)}/1` },
            { id:'ten_upgrades', icon:'üßæ', name:'–ó–∞–∫—É–ø—â–∏–∫', desc:'–ö—É–ø–∏ 10 —É–ª—É—á—à–µ–Ω–∏–π –∑–∞ —Å–º–µ–Ω—É.', progress: () => `${Math.min(10, gameState.upgradeBuys||0)}/10` },
            { id:'1k_blocks', icon:'üö´', name:'–†–∞–∑–º—è–ª—Å—è', desc:'–°–¥–µ–ª–∞–π 1K –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –∑–∞ —Å–º–µ–Ω—É.', progress: () => `${Math.min(1000, Math.floor(gameState.totalBlocks||0))}/1000` },
            { id:'50k_blocks', icon:'üî•', name:'–í–æ—à—ë–ª –≤–æ –≤–∫—É—Å', desc:'–°–¥–µ–ª–∞–π 50K –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –∑–∞ —Å–º–µ–Ω—É.', progress: () => `${Math.min(50000, Math.floor(gameState.totalBlocks||0))}/50000` },
            { id:'calm', icon:'üïäÔ∏è', name:'–¢–∏—Ö–∞—è —Å–º–µ–Ω–∞', desc:'–î–æ–∂–∏–≤–∏ –¥–æ 5 –¥–Ω—è —Å –≥–Ω–µ–≤–æ–º –Ω–∏–∂–µ 30%.', progress: () => `${Math.min(5, gameState.day||1)}/5` },
            { id:'fury', icon:'üò°', name:'–¢–æ—á–∫–∞ –∫–∏–ø–µ–Ω–∏—è', desc:'–ü–æ–¥–Ω–∏–º–∏ –Ω–∞—Ä–æ–¥–Ω—ã–π –≥–Ω–µ–≤ –¥–æ 90%.', progress: () => `${Math.min(90, Math.floor(gameState.tension||0))}/90` },
            { id:'loyal', icon:'üõ°Ô∏è', name:'–°–≤–æ–π —á–µ–ª–æ–≤–µ–∫', desc:'–ü–æ–¥–Ω–∏–º–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç—å –¥–æ 90%.', progress: () => `${Math.min(90, Math.floor(gameState.loyalty||50))}/90` },
            { id:'prestige_1', icon:'üîÅ', name:'–ù–æ–≤–∞—è —Å–º–µ–Ω–∞', desc:'–°–¥–µ–ª–∞–π –ø–µ—Ä–≤—ã–π –ø—Ä–µ—Å—Ç–∏–∂.', progress: () => `${Math.min(1, gameState.prestige||0)}/1` },
            { id:'prestige_3', icon:'üéñÔ∏è', name:'–î–æ–ª–∂–Ω–æ—Å—Ç—å', desc:'–°–¥–µ–ª–∞–π 3 –ø—Ä–µ—Å—Ç–∏–∂–∞.', progress: () => `${Math.min(3, gameState.prestige||0)}/3` },
            { id:'ending_any', icon:'üé¨', name:'–ö–æ–Ω—Ü–æ–≤–∫–∞', desc:'–ü–æ–ª—É—á–∏ –ª—é–±—É—é –∫–æ–Ω—Ü–æ–≤–∫—É.', progress: () => (gameState.gameEnded ? '‚úì' : '‚Äî') },
            { id:'ending_good', icon:'üëë', name:'–ö–∞—Ä—å–µ—Ä–∏—Å—Ç', desc:'–î–æ–π–¥–∏ –¥–æ ‚Äú—Ö–æ—Ä–æ—à–µ–π‚Äù –∫–æ–Ω—Ü–æ–≤–∫–∏ (–ª–æ—è–ª—å–Ω–æ—Å—Ç—å –≤—ã—Å–æ–∫–∞—è, –≥–Ω–µ–≤ –Ω–µ –∑–∞—à–∫–∞–ª–∏–≤–∞–µ—Ç).', progress: () => '‚Äî' },
            { id:'ending_bad', icon:'‚ò†Ô∏è', name:'–°–≥–æ—Ä–µ–ª –Ω–∞ —Ä–∞–±–æ—Ç–µ', desc:'–î–æ–π–¥–∏ –¥–æ ‚Äú–ø–ª–æ—Ö–æ–π‚Äù –∫–æ–Ω—Ü–æ–≤–∫–∏ (–≥–Ω–µ–≤ –≤—ã—Å–æ–∫–∏–π / –ª–æ—è–ª—å–Ω–æ—Å—Ç—å –Ω–∏–∑–∫–∞—è).', progress: () => '‚Äî' },
        
      { id:'doc_3', icon:'üìÑ', name:'–ê—Ä—Ö–∏–≤–∞—Ä–∏—É—Å', desc:'–ù–∞–π–¥–∏ 3 –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∑–∞ –æ–¥–Ω—É —Å–º–µ–Ω—É.', progress: () => `${countDocs({realOnly:false})}/3` },
      { id:'leak_doc', icon:'üì§', name:'–°–ª–∏–ª –ø–æ-—Ç–∏—Ö–æ–º—É', desc:'–°–ª–µ–π –ª—é–±–æ–π –¥–æ–∫—É–º–µ–Ω—Ç –≤ –ø–æ–¥–ø–æ–ª—å–µ.', progress: () => countDocs({leakedOnly:true}) ? '‚úì' : '‚Äî' },
      { id:'fake_doc', icon:'üßª', name:'–ü–æ–¥—Å—Ç–∞–≤–∞', desc:'–ù–∞–π–¥–∏ (–∏–ª–∏ —Å–æ–ª—å—ë—à—å) —Ñ–µ–π–∫–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç.', progress: () => countDocs({fakeOnly:true}) ? '‚úì' : '‚Äî' },
      { id:'artifact_1', icon:'üíæ', name:'–ù–∞—Ö–æ–¥–∫–∞', desc:'–ù–∞–π–¥–∏ –ª—é–±–æ–π —Ä–µ–¥–∫–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç.', progress: () => (gameState.artifacts||[]).length ? '‚úì' : '‚Äî' },
      { id:'artifact_3', icon:'üì¶', name:'–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä', desc:'–°–æ–±–µ—Ä–∏ 3 —Ä–µ–¥–∫–∏—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞.', progress: () => `${Math.min(3,(gameState.artifacts||[]).length)}/3` },
];

        function isAchUnlocked(id) {
            return !!(gameState.achievements && gameState.achievements[id]);
        }

        function unlockAchievement(id) {
            ensureMeta();
            if (isAchUnlocked(id)) return false;
            gameState.achievements[id] = { ts: Date.now() };
            const a = achievementsData.find(x => x.id === id);
            if (a) showNotification(`üèÜ ${a.name}`);
            manualSave(true);
            return true;
        }

        function unlockedCount() {
            ensureMeta();
            return Object.keys(gameState.achievements || {}).length;
        }

        function renderAchievements() {
            ensureMeta();
            const total = achievementsData.length;
            const unlocked = unlockedCount();

            const parts = [];
            parts.push(`<div style="text-align:center;color:var(--telegram-hint);font-size:9px">–û—Ç–∫—Ä—ã—Ç–æ: <strong style="color:var(--rkn-gold)">${unlocked}</strong> / ${total}</div>`);
            parts.push(`<div class="ach-list">`);

            achievementsData.forEach(a => {
                const ok = isAchUnlocked(a.id);
                const status = ok ? `–û—Ç–∫—Ä—ã—Ç–æ ‚Ä¢ ${new Date(gameState.achievements[a.id].ts).toLocaleDateString()}` : `–ü—Ä–æ–≥—Ä–µ—Å—Å: ${a.progress ? a.progress() : '‚Äî'}`;
                const cls = ok ? '' : 'locked';
                parts.push(`
                    <div class="ach-item ${cls}">
                        <div class="ach-icon">${a.icon}</div>
                        <div class="ach-meta">
                            <div class="ach-name">${ok ? a.name : '????'}</div>
                            <div class="ach-desc">${ok ? a.desc : '–û—Ç–∫—Ä–æ–π, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ.'}</div>
                            <div class="ach-status">${status}</div>
                        </div>
                    </div>
                `);
            });

            parts.push(`</div>`);
            document.getElementById('achTitle').textContent = '–î–û–°–¢–ò–ñ–ï–ù–ò–Ø';
            document.getElementById('achText').innerHTML = parts.join('');
        }

        function renderCollection() {
            ensureMeta();
            const got = (gameState.collection && gameState.collection.targets) ? gameState.collection.targets : {};
            const parts = [];
            parts.push(`<div style="text-align:center;color:var(--telegram-hint);font-size:9px">–¢—Ä–æ—Ñ–µ–∏ –ø–æ —Ü–µ–ª—è–º (–æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ —Ü–µ–ª–∏)</div>`);
            parts.push(`<div class="chip-wrap">`);
            targets.forEach(tg => {
                const ok = !!got[tg.name];
                parts.push(`<div class="chip ${ok ? '' : 'locked'}">${ok ? tg.name : '‚ùî ???'}</div>`);
            });
            parts.push(`</div>`);
            parts.push(`<div style="margin-top:10px;text-align:center;color:var(--telegram-hint);font-size:9px">–£–ª–∏–∫–∏/–¥–æ–∫—É–º–µ–Ω—Ç—ã ‚Äî –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´üìÑ¬ª</div>`);

            document.getElementById('achTitle').textContent = '–ö–û–õ–õ–ï–ö–¶–ò–Ø';
            document.getElementById('achText').innerHTML = parts.join('');
        }

        function docById(id){ return (allDocuments||[]).find(d=>d.id===id); }

        function ensureDocs(){
            // –º–∏–≥—Ä–∞—Ü–∏—è: —Å—Ç–∞—Ä—ã–µ —Å–µ–π–≤—ã –º–æ–≥–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å ['id','id2']
            if (!gameState.documents) gameState.documents = [];
            if (Array.isArray(gameState.documents) && gameState.documents.length && typeof gameState.documents[0] === 'string') {
                gameState.documents = gameState.documents.map(x => ({ id: x, real: true, status: 'kept', ts: Date.now() }));
            }
            if (!Array.isArray(gameState.documents)) gameState.documents = [];
            gameState.resistance = (gameState.resistance ?? 0); // 0-100
            gameState.suspicion  = (gameState.suspicion  ?? 0); // 0-100
        }

        
        // === CHAINS (scheduled encounters) ===
        function ensureChains(){
            if (!Array.isArray(gameState.scheduledEncounters)) gameState.scheduledEncounters = [];
        }

        function scheduleEncounter(encId, minDays=2, maxDays=3) {
            ensureChains();
            const dayNow = (gameState.day || 1);
            const delta = Math.floor(Math.random() * (maxDays - minDays + 1)) + minDays;
            const day = dayNow + delta;
            gameState.scheduledEncounters.push({ day, id: encId, ts: Date.now() });
            // —á–∏—Å—Ç–∏–º —Ö–≤–æ—Å—Ç—ã (–Ω–∞ –≤—Å—è–∫–∏–π)
            gameState.scheduledEncounters = gameState.scheduledEncounters
                .filter(x => x && x.id && x.day)
                .slice(-25);
        }

        function popScheduledEncounterForToday() {
            ensureChains();
            const dayNow = (gameState.day || 1);
            const idx = gameState.scheduledEncounters.findIndex(x => x.day <= dayNow);
            if (idx === -1) return null;
            const item = gameState.scheduledEncounters.splice(idx, 1)[0];
            return item ? item.id : null;
        }

        
        // === ESCAPE ARC (–≤—ã–±—Ä–∞–ª ‚Äú—Å—ä–µ–±–∞—Ç—å –∏–∑ —Å—Ç—Ä–∞–Ω—ã‚Äù) ===
        function startEscapeArc(){
            ensureMeta();
            ensureChains();
            ensureDocs();

            if (gameState.escapeActive) return;

            gameState.escapeActive = true;
            gameState.escapeStage = 1;
            gameState.escapeLeak = false;
            gameState.escapeHeat = clamp((gameState.suspicion||0) + (gameState.tension||0)*0.35, 0, 100);

            showStoryOverlay('üß≥', '–ü–õ–ê–ù', '–¢—ã —Ä–µ—à–∏–ª —Å—ä–µ–±–∞—Ç—å –∏–∑ —Å—Ç—Ä–∞–Ω—ã. –ö—Ä–∞—Å–∏–≤–æ –∑–≤—É—á–∏—Ç ‚Äî –ø–æ–∫–∞ –Ω–µ –Ω–∞—á–Ω—ë—à—å –¥–µ–ª–∞—Ç—å, –∏ –Ω–µ –ø–æ–π–º—ë—à—å, –∫–∞–∫–æ–π —ç—Ç–æ –ø–∏–∑–¥–µ—Ü.<br><br>–¢–µ–ø–µ—Ä—å –∫–∞–∂–¥–æ–µ —Ä–µ—à–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ª–∏–±–æ –≤—ã–≤–µ—Å—Ç–∏ —Ç–µ–±—è –Ω–∞—Ä—É–∂—É, –ª–∏–±–æ –∑–∞–∫–æ–ø–∞—Ç—å.<br><br><small style="color:var(--telegram-hint)">–°–∫–æ—Ä–æ –±—É–¥–µ—Ç –ø–µ—Ä–≤–∞—è ‚Äú–≤—Å—Ç—Ä–µ—á–∞‚Äù –ø—Ä–æ –ø–æ–±–µ–≥.</small>');
            // –ø–µ—Ä–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞ ‚Äî —Å—Ä–∞–∑—É (–±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è 2‚Äì3 –¥–Ω—è)
            scheduleEncounter('escape_prepare', 0, 0);
            setTimeout(() => maybeTriggerEncounter(), 350);
            manualSave(true);
        }

        function bumpEscapeHeat(v){
            ensureMeta();
            gameState.escapeHeat = clamp((gameState.escapeHeat||0) + v, 0, 100);
        }

        function finalizeEscapeEnding(){
            ensureMeta();
            // –ø–µ—Ä–µ–≤–æ–¥–∏–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤ –∏—Ç–æ–≥–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –∫–æ–Ω—Ü–æ–≤–∫–∏
            const heat = (gameState.escapeHeat||0);
            const res  = (gameState.resistance||0);
            const sus  = (gameState.suspicion||0);
            const loy  = (gameState.loyalty ?? 50);

            // –≥–æ—Ç–æ–≤–∏–º ‚Äú—É—Å–ª–æ–≤–∏—è‚Äù –¥–ª—è resolveEndingType
            // –µ—Å–ª–∏ –≥–æ—Ä—è—á–æ/–ø–æ–¥–æ–∑—Ä–µ–Ω–∏—è ‚Äî –±—É–¥–µ—Ç hunted/caught
            if (heat >= 85 || sus >= 85) gameState.tension = clamp((gameState.tension||0)+12, 0, 100);

            // –º–∞–ª–µ–Ω—å–∫–∏–µ –¥–æ–ø. –≤–ª–∏—è–Ω–∏—è
            if (gameState.escapeLeak) { addSuspicion(6); addResistance(6); }

            // –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–µ—Å—Ç–∏–∂: –µ—Å–ª–∏ –ø–æ–±–µ–≥ —É–¥–∞–ª—Å—è ‚Äî ‚Äú—Å–º–µ–Ω–∞ –≤ –∏–∑–≥–Ω–∞–Ω–∏–∏‚Äù –∏ –º–∞–ª–µ–Ω—å–∫–∏–π –ø–µ—Ä–º–∞–Ω–µ–Ω—Ç
            const success = (gameState.escapeResult === 'clean' || gameState.escapeResult === 'res' || gameState.escapeResult === 'panic_ok');
            if (success) {
                gameState.exileMode = true;
                gameState.exileShifts = (gameState.exileShifts || 0) + 1;
                // –º–∏–∫—Ä–æ-–±–æ–Ω—É—Å: –≤ –∏–∑–≥–Ω–∞–Ω–∏–∏ –ø—Ä–æ—â–µ —Ä–∞–±–æ—Ç–∞—Ç—å (–º–∞–ª–µ–Ω—å–∫–∏–π, –Ω–µ –ª–æ–º–∞–µ—Ç –±–∞–ª–∞–Ω—Å)
                gameState.permSecondMul = (gameState.permSecondMul || 1) * 1.02;
            }

            // –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ–º –∏–≥—Ä—É
            triggerEnding('walk_away');
        }


// === RARE ARTIFACTS (collection items) ===
        const artifactsCatalog = [
            { id:'flash', icon:'üíæ', name:'–§–ª–µ—à–∫–∞', desc:'–ù–∞ –Ω–µ–π —á—Ç–æ-—Ç–æ –æ—á–µ–Ω—å –Ω–µ—Ö–æ—Ä–æ—à–µ–µ.' },
            { id:'audio', icon:'üéôÔ∏è', name:'–ê—É–¥–∏–æ–∑–∞–ø–∏—Å—å', desc:'–ì–æ–ª–æ—Å–∞ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ –≥–æ–≤–æ—Ä—è—Ç –ª–∏—à–Ω–µ–µ.' },
            { id:'screenshot', icon:'üì∏', name:'–°–∫—Ä–∏–Ω', desc:'–°–∫—Ä–∏–Ω—à–æ—Ç –∏–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ø–∞–Ω–µ–ª–∏.' },
            { id:'sim', icon:'üì∂', name:'–°–∏–º–∫–∞', desc:'–ß—É–∂–∞—è SIM-–∫–∞—Ä—Ç–∞. –û—á–µ–Ω—å —É–¥–æ–±–Ω–∞—è.' },
            { id:'notebook', icon:'üìì', name:'–ë–ª–æ–∫–Ω–æ—Ç', desc:'–°–ø–∏—Å–æ–∫ –∏–º—ë–Ω –∏ –∑–∞–º–µ—Ç–æ–∫. –ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.' }
        ];

        function hasArtifact(id){
            return (gameState.artifacts || []).includes(id);
        }

        function addArtifact(id){
            if (!id) return;
            if (!Array.isArray(gameState.artifacts)) gameState.artifacts = [];
            if (gameState.artifacts.includes(id)) return;

            gameState.artifacts.push(id);
            // –æ—Ç–º–µ—á–∞–µ–º –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
            if (!gameState.collection) gameState.collection = { targets:{}, artifacts:{} };
            if (!gameState.collection.artifacts) gameState.collection.artifacts = {};
            gameState.collection.artifacts[id] = true;

            const meta = artifactsCatalog.find(a=>a.id===id);
            showToast((meta ? (meta.icon+' '+meta.name) : '–ê—Ä—Ç–µ—Ñ–∞–∫—Ç') + ' ‚Äî –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏');
            unlockAchievement('artifact_1');
            if ((gameState.artifacts||[]).length >= 3) unlockAchievement('artifact_3');
            manualSave(true);
        }

        function maybeFindRandomArtifact(chance=0.08){
            // —à–∞–Ω—Å –Ω–∏–∑–∫–∏–π: —Ä–µ–¥–∫–∏–µ —à—Ç—É–∫–∏
            if (Math.random() > chance) return;
            const available = artifactsCatalog.map(a=>a.id).filter(id => !hasArtifact(id));
            if (!available.length) return;
            const pick = available[Math.floor(Math.random()*available.length)];
            addArtifact(pick);
        }

        function renderArtifacts(){
            ensureMeta();
            const got = new Set(gameState.artifacts || []);
            let htmlOut = `<div style="text-align:left;max-width:720px;margin:0 auto;">`;
            htmlOut += `<div style="margin-bottom:10px;color:var(--telegram-hint);font-size:12px">–†–µ–¥–∫–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Ñ–∏–Ω–∞–ª—ã –∏ ‚Äú–¥–≤–æ–π–Ω—É—é –∏–≥—Ä—É‚Äù.</div>`;
            artifactsCatalog.forEach(a=>{
                const owned = got.has(a.id);
                htmlOut += `
                    <div class="upgrade-card" style="margin:8px 0;opacity:${owned?1:0.55}">
                        <div class="upgrade-name">${a.icon} ${a.name} ${owned ? '<span style="color:#4caf50">‚úì</span>' : ''}</div>
                        <div class="upgrade-desc">${a.desc}</div>
                        <div class="upgrade-cost">${owned ? '–í –∫–æ–ª–ª–µ–∫—Ü–∏–∏' : '–ù–µ –Ω–∞–π–¥–µ–Ω–æ'}</div>
                    </div>
                `;
            });
            htmlOut += `</div>`;
            document.getElementById('achTitle').textContent = '–ê–†–¢–ï–§–ê–ö–¢–´';
            document.getElementById('achText').innerHTML = htmlOut;
        }

function countDocs(opts={}) {
            ensureDocs();
            const realOnly = !!opts.realOnly;
            const leakedOnly = !!opts.leakedOnly;
            const fakeOnly = !!opts.fakeOnly;
            return gameState.documents.filter(d=>{
                if (d.status === 'burned') return false;
                if (realOnly && !d.real) return false;
                if (fakeOnly && d.real) return false;
                if (leakedOnly && d.status !== 'leaked') return false;
                return true;
            }).length;
        }

        function addResistance(v){ ensureDocs(); gameState.resistance = clamp((gameState.resistance||0)+v, 0, 100); }
        function addSuspicion(v){ ensureDocs(); gameState.suspicion  = clamp((gameState.suspicion ||0)+v, 0, 100); }

        function changeAnger(v){ gameState.tension = clamp((gameState.tension||0)+v, 0, 100); }
        function changeLoyalty(v){ gameState.loyalty = clamp((gameState.loyalty ?? 50)+v, 0, 100); }

        function showToast(msg){
            // —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: —Ä–∞–Ω—å—à–µ –Ω–∞–∑—ã–≤–∞–ª–æ—Å—å showToast
            showNotification(msg);
        }

        function leakDoc(docId){
            ensureDocs();
            const item = gameState.documents.find(d=>d.id===docId);
            if (!item || item.status==='leaked' || item.status==='burned') return;
            item.status = 'leaked';
            if (item.real) { addResistance(12); changeAnger(-6); }
            else { addResistance(4); changeAnger(+6); }
            addSuspicion(10);
            changeLoyalty(-6);
            showToast(item.real ? 'üì§ –°–ª–∏–ª —É–ª–∏–∫—É –≤ –ø–æ–¥–ø–æ–ª—å–µ' : 'üì§ –°–ª–∏–ª —Å—Ç—Ä–∞–Ω–Ω—É—é –±—É–º–∞–∂–∫—É‚Ä¶');
            unlockAchievement('leak_doc');
            manualSave(true);
        }

        function burnDoc(docId){
            ensureDocs();
            const item = gameState.documents.find(d=>d.id===docId);
            if (!item || item.status==='burned') return;
            item.status = 'burned';
            addSuspicion(-6);
            changeLoyalty(+3);
            showToast('üî• –°–∂—ë–≥ –¥–æ–∫—É–º–µ–Ω—Ç');
            manualSave(true);
        }

        function renderDocuments() {
            ensureDocs();
            document.getElementById('achTitle').textContent = '–î–û–ö–£–ú–ï–ù–¢–´';
            const list = (gameState.documents||[]).slice().filter(d=>d.status!=='burned').sort((a,b)=>(b.ts||0)-(a.ts||0));
            const real = countDocs({realOnly:true});
            const leaked = countDocs({leakedOnly:true});
            const fake = countDocs({fakeOnly:true});
            const hdr = `
                <div style="text-align:center;color:var(--telegram-hint);font-size:9px">
                    –†–µ–∞–ª—å–Ω—ã—Ö: <strong style="color:var(--rkn-gold)">${real}</strong> ¬∑
                    –°–ª–∏—Ç–æ: <strong style="color:var(--rkn-gold)">${leaked}</strong> ¬∑
                    –§–µ–π–∫–æ–≤: <strong style="color:var(--rkn-red)">${fake}</strong><br>
                    –ü–æ–¥–ø–æ–ª—å–µ: <strong style="color:var(--rkn-gold)">${Math.round(gameState.resistance||0)}</strong>/100 ¬∑
                    –†–∏—Å–∫: <strong style="color:var(--rkn-red)">${Math.round(gameState.suspicion||0)}</strong>/100
                </div>`;
            let html = hdr + `<div class="ach-list">`;
            if (!list.length) {
                html += `<div class="ach-item locked"><div class="ach-icon">üìÅ</div><div class="ach-meta"><div class="ach-name">–ü—É—Å—Ç–æ</div><div class="ach-desc">–î–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è —Ä–µ–¥–∫–æ –≤–æ ‚Äú–≤—Å—Ç—Ä–µ—á–∞—Ö‚Äù. –ò–Ω–æ–≥–¥–∞ —ç—Ç–æ —Ñ–µ–π–∫.</div><div class="ach-status">–°–æ–≤–µ—Ç: ‚Äú—Å–ª–∏—Ç—å‚Äù ‚Äî –º–æ—â–Ω–æ, –Ω–æ —Ä–∏—Å–∫ —Ä–∞—Å—Ç—ë—Ç.</div></div></div>`;
            } else {
                for (const it of list) {
                    const d = docById(it.id) || {name:it.id, desc:'‚Äî'};
                    const statusTxt = it.status==='leaked' ? '–°–õ–ò–¢–û' : '–£ –°–ï–ë–Ø';
                    const cls = it.real ? '' : 'locked';
                    const realTag = it.real ? '‚úÖ —É–ª–∏–∫–∞' : '‚ö†Ô∏è —Ñ–µ–π–∫?';
                    html += `
                        <div class="ach-item ${cls}">
                            <div class="ach-icon">${it.real ? 'üìÑ' : 'üßª'}</div>
                            <div class="ach-meta">
                                <div class="ach-name">${d.name} <span style="opacity:.7;font-size:9px">(${realTag})</span></div>
                                <div class="ach-desc">${d.desc}</div>
                                <div class="ach-status">–°—Ç–∞—Ç—É—Å: <strong>${statusTxt}</strong></div>
                                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
                                    <button class="choice-btn" style="padding:10px 12px;flex:1 1 120px" onclick="leakDoc('${it.id}')">üì§ –°–ª–∏—Ç—å</button>
                                    <button class="choice-btn secondary" style="padding:10px 12px;flex:1 1 120px" onclick="burnDoc('${it.id}')">üî• –°–∂–µ—á—å</button>
                                </div>
                            </div>
                        </div>`;
                }
            }
            html += `</div>`;
            document.getElementById('achText').innerHTML = html;
        }

        function switchAchTab(tab) {
            uiState.achTab = tab || 'ach';
            const a = document.getElementById('tabAch');
            const c = document.getElementById('tabCol');
            const d = document.getElementById('tabDocs');
            const r = document.getElementById('tabArt');

            a.classList.toggle('active', uiState.achTab === 'ach');
            c.classList.toggle('active', uiState.achTab === 'col');
            if (d) d.classList.toggle('active', uiState.achTab === 'docs');
            if (r) r.classList.toggle('active', uiState.achTab === 'art');

            if (uiState.achTab === 'col') renderCollection();
            else if (uiState.achTab === 'docs') renderDocuments();
            else if (uiState.achTab === 'art') renderArtifacts();
            else renderAchievements();
        }

        function openAchievements(tab='ach') {
            // –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é, –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ, –Ω–æ –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º modalOpen
            document.getElementById('menuOverlay').classList.remove('show');

            uiState.modalOpen = true;
            switchAchTab(tab);
            document.getElementById('achOverlay').classList.add('show');
            safeHaptic('medium');
        }

        function closeAchievements() {
            document.getElementById('achOverlay').classList.remove('show');
            uiState.modalOpen = false;
        }

        // === PRESTIGE ===
        function canPrestige() {
            return !gameState.gameEnded && (gameState.totalBlocks >= 50000);
        }

        function updatePrestigeButton() {
            const btn = document.getElementById('prestigeBtn');
            if (!btn) return;
            btn.classList.toggle('disabled', !canPrestige());
            btn.textContent = canPrestige() ? 'üîÅ –ù–æ–≤–∞—è —Å–º–µ–Ω–∞' : 'üîí –ù–æ–≤–∞—è —Å–º–µ–Ω–∞ (50K+)';
        }

        function openPrestige() {
            // –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ
            document.getElementById('menuOverlay').classList.remove('show');
            updatePrestigeButton();
            if (!canPrestige()) {
                showNotification('üîí –ù—É–∂–Ω–æ 50K –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫');
                return;
            }

            uiState.modalOpen = true;
            document.getElementById('choiceIcon').textContent = 'üîÅ';
            document.getElementById('choiceTitle').textContent = '–ù–û–í–ê–Ø –°–ú–ï–ù–ê';
            document.getElementById('choiceText').innerHTML =
                `–¢—ã –∑–∞–∫—Ä—ã–≤–∞–µ—à—å —Å–º–µ–Ω—É –∏ –Ω–∞—á–∏–Ω–∞–µ—à—å –∑–∞–Ω–æ–≤–æ.<br><br>
                 <strong>–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:</strong> –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è, –∫–æ–ª–ª–µ–∫—Ü–∏—è, –ø—Ä–µ—Å—Ç–∏–∂.<br>
                 <strong>–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è:</strong> –±—é–¥–∂–µ—Ç, —É–ª—É—á—à–µ–Ω–∏—è, –ø—Ä–æ–≥—Ä–µ—Å—Å —Ü–µ–ª–µ–π, –≥–Ω–µ–≤/–∑–¥–æ—Ä–æ–≤—å–µ.<br><br>
                 <small style="color:var(--telegram-hint)">–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –±–æ–Ω—É—Å (–º–∞–ª–µ–Ω—å–∫–∏–π): +1 –∫–ª–∏–∫ –∏ +3% –ø–∞—Å—Å–∏–≤ (–∫–∞–ø).</small>`;

            const buttonsDiv = document.getElementById('choiceButtons');
            buttonsDiv.innerHTML = '';

            const ok = document.createElement('button');
            ok.className = 'choice-btn primary';
            ok.type = 'button';
            ok.innerHTML = `<strong>–°–¥–µ–ª–∞—Ç—å –ø—Ä–µ—Å—Ç–∏–∂</strong><div class="choice-consequence">–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é —Å–º–µ–Ω—É</div>`;
            ok.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); doPrestige(); }, { passive:false });

            const no = document.createElement('button');
            no.className = 'choice-btn secondary';
            no.type = 'button';
            no.innerHTML = `<strong>–û—Ç–º–µ–Ω–∞</strong><div class="choice-consequence">–Ø –µ—â—ë –ø–æ–±–ª–æ—á—É</div>`;
            no.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); document.getElementById('choiceModal').classList.remove('show'); uiState.modalOpen=false; }, { passive:false });

            buttonsDiv.appendChild(ok);
            buttonsDiv.appendChild(no);

            document.getElementById('choiceModal').classList.add('show');
            safeHaptic('medium');
        }

        function doPrestige() {
            document.getElementById('choiceModal').classList.remove('show');
            uiState.modalOpen = false;

            ensureMeta();

            // –Ω–∞–∫–æ–ø–∏–º –æ–±—â–∏–π —Å—á—ë—Ç—á–∏–∫
            gameState.lifetimeBlocks = (gameState.lifetimeBlocks || 0) + (gameState.totalBlocks || 0);

            // –ø–æ–≤—ã—Å–∏–º –ø—Ä–µ—Å—Ç–∏–∂ / –¥–æ–ª–∂–Ω–æ—Å—Ç—å
            gameState.prestige = (gameState.prestige || 0) + 1;
            gameState.positionLevel = Math.min(positionNames.length - 1, (gameState.positionLevel || 0) + 1);

            // –º–∞–ª–µ–Ω—å–∫–∏–µ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –±–æ–Ω—É—Å—ã (–∫–∞–ø)
            gameState.permClickAdd = Math.min(5, (gameState.permClickAdd || 0) + 1);
            gameState.permSecondMul = Math.min(1.15, (gameState.permSecondMul || 1) + 0.03);

            unlockAchievement('prestige_1');
            if ((gameState.prestige || 0) >= 3) unlockAchievement('prestige_3');

            // —Å–±—Ä–æ—Å —Å–º–µ–Ω—ã, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –º–µ—Ç—É
            gameState = makeBaseState(true);
            ensureMeta();

            // –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('endingScreen').classList.remove('show');
            document.getElementById('blockedList').innerHTML = '';
            document.getElementById('bossPanel').classList.add('hidden');
            document.getElementById('targetPanel').classList.remove('hidden');

            initUpgrades(false);
            updateDialog();
            updateRank();
            updateDisplay(true);
            updateNews();

            if (_tickTimer) { clearInterval(_tickTimer); _tickTimer = null; }
            startGameLoop();

            showStoryOverlay('üîÅ', '–ù–û–í–ê–Ø –°–ú–ï–ù–ê', `–ù–æ–≤–∞—è –¥–æ–ª–∂–Ω–æ—Å—Ç—å: <strong>${positionNames[gameState.positionLevel]}</strong><br><br>–ü–æ—Å—Ç–æ—è–Ω–Ω–æ: +${gameState.permClickAdd} –∫–ª–∏–∫, +${Math.round((gameState.permSecondMul-1)*100)}% –ø–∞—Å—Å–∏–≤.`);
            manualSave(true);
        }


        // === ENDINGS ===
        const endings = {
            internet_dead: {
                icon: "üåêüíÄ",
                title: "–ò–ù–¢–ï–†–ù–ï–¢ –ú–Å–†–¢–í",
                text: "–¢—ã —Å–¥–µ–ª–∞–ª —ç—Ç–æ. –†—É–±–∏–ª—å–Ω–∏–∫ –æ–ø—É—â–µ–Ω.<br><br>–†–æ—Å—Å–∏—è –ø–æ–≥—Ä—É–∑–∏–ª–∞—Å—å –≤–æ —Ç—å–º—É. –ë–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞. –ë–µ–∑ —Å–≤—è–∑–∏. –ë–µ–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.<br><br>–¢—ã ‚Äî –≥–µ—Ä–æ–π –¥–ª—è –æ–¥–Ω–∏—Ö. –ú–æ–Ω—Å—Ç—Ä –¥–ª—è –¥—Ä—É–≥–∏—Ö. –õ–µ–≥–µ–Ω–¥–∞ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏.<br><br>–ù–æ —á—Ç–æ —Ç–æ–ª–∫—É –≤ –ª–µ–≥–µ–Ω–¥–µ, –∫–æ–≥–¥–∞ –≤–æ–∫—Ä—É–≥ ‚Äî –ø—É—Å—Ç–æ—Ç–∞?"
            },
            internet_dead_hero: {
                icon: "üåêüëë",
                title: "–ì–ï–†–û–ô –°–ò–°–¢–ï–ú–´",
                text: "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç —É–º–µ—Ä. –ù–æ —Ç—ã –≤—ã–∂–∏–ª ‚Äî –∏ –¥–∞–∂–µ –≤—ã–∏–≥—Ä–∞–ª.<br><br>–í –æ—Ç—á—ë—Ç–∞—Ö —Ç—ã ‚Äî –æ–±—Ä–∞–∑—Ü–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫. –í –∫–∞–±–∏–Ω–µ—Ç–∞—Ö ‚Äî —Å–≤–æ–π —á–µ–ª–æ–≤–µ–∫. –¢–µ–±—è –ø–æ–≤—ã—à–∞—é—Ç: –Ω–æ–≤—ã–π –∫–∞–±–∏–Ω–µ—Ç, –Ω–æ–≤–∞—è –æ—Ö—Ä–∞–Ω–∞, –Ω–æ–≤–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞.<br><br>–ù–∞—Ä–æ–¥ –∑–ª–∏—Ç—Å—è, –Ω–æ –Ω–µ –¥–æ –±—É–Ω—Ç–∞. –í—Å—ë ‚Äú–ø–æ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—É‚Äù.<br><br>–¢—ã —É–ª—ã–±–∞–µ—à—å—Å—è. –ò –ø–æ–Ω–∏–º–∞–µ—à—å: —ç—Ç–æ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ."
            },
            internet_dead_hunted: {
                icon: "üåê‚ò†Ô∏è",
                title: "–û–•–û–¢–ê",
                text: "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç —É–º–µ—Ä ‚Äî –∏ –≤–º–µ—Å—Ç–µ —Å –Ω–∏–º —Å–æ—Ä–≤–∞–ª–æ –∫—Ä—ã—à—É —É –º–∏–ª–ª–∏–æ–Ω–æ–≤.<br><br>–ì–Ω–µ–≤ –≤—ã—à–µ–ª –∏–∑-–ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è. –ê–¥—Ä–µ—Å–∞ —É—Ç–µ–∫–ª–∏. –õ–∏—Ü–∞ –Ω–∞ –ø–ª–∞–∫–∞—Ç–∞—Ö. –ù–æ—á—å –∑–∞ –Ω–æ—á—å—é.<br><br>–¢–µ–±—è –≤—ã–≤–æ–∑—è—Ç –≤ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –¥–æ–º, –Ω–æ —ç—Ç–æ –ª–∏—à—å –æ—Ç—Å—Ä–æ—á–∫–∞.<br><br>–°–∏—Å—Ç–µ–º–∞ —Ç–µ–±—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞. –ê –ø–æ—Ç–æ–º –±—Ä–æ—Å–∏–ª–∞."
            },
            internet_dead_scapegoat: {
                icon: "üåêüß®",
                title: "–ö–û–ó–Å–õ –û–¢–ü–£–©–ï–ù–ò–Ø",
                text: "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç —É–º–µ—Ä ‚Äî –∏ –Ω—É–∂–µ–Ω –≤–∏–Ω–æ–≤–Ω—ã–π. –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ –∏–º —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è —Ç—ã.<br><br>–í—á–µ—Ä–∞ —Ç—ã –±—ã–ª ‚Äú—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º‚Äù. –°–µ–≥–æ–¥–Ω—è ‚Äî ‚Äú–ø–µ—Ä–µ–≥–Ω—É–ª‚Äù.<br><br>–£–≥–æ–ª–æ–≤–Ω–æ–µ –¥–µ–ª–æ, –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ—Å–∞–¥–∫–∞, —É–Ω—ã–ª—ã–π —Å—É–¥.<br><br>–°–∏—Å—Ç–µ–º–∞ —Å–ø–∞—Å–∞–µ—Ç —Å–µ–±—è. –ù–∞ —Ç–≤–æ–∏—Ö –∫–æ—Å—Ç—è—Ö."
            },
            walk_away: {
                icon: "üö∂",
                title: "–£–•–û–î –í –ù–û–ß–¨",
                text: "–¢—ã —Ä–∞–∑–≤–µ—Ä–Ω—É–ª—Å—è –∏ —É—à—ë–ª. –ü—Ä–æ—Å—Ç–æ —É—à—ë–ª.<br><br>–ù–∏–∫—Ç–æ –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª. –ù–∏–∫—Ç–æ –Ω–µ –æ–∫–ª–∏–∫–Ω—É–ª.<br><br>–¢—ã –∏—Å—á–µ–∑. –ù–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã. –ù–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∞. –ù–æ–≤–∞—è –∂–∏–∑–Ω—å.<br><br>–ò–Ω–æ–≥–¥–∞ –Ω–æ—á—å—é —Å–Ω–∏—Ç—Å—è —Ç–æ—Ç —Ä—É–±–∏–ª—å–Ω–∏–∫. –ò —Ç—ã –ø—Ä–æ—Å—ã–ø–∞–µ—à—å—Å—è –≤ –ø–æ—Ç—É, –ø–æ–Ω–∏–º–∞—è: —Ö–æ—Ä–æ—à–æ, —á—Ç–æ –Ω–µ –Ω–∞–∂–∞–ª. –ò –¥–∞ ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–¥–µ–ª–∞–ª, —á—Ç–æ —Å—ä–µ–±–∞–ª."
            },
            walk_away_hunted: {
                icon: "üö∂üï∂Ô∏è",
                title: "–ë–ï–ì–õ–ï–¶",
                text: "–¢—ã —É—à—ë–ª ‚Äî –Ω–æ –≥–Ω–µ–≤ –Ω–µ —É—à—ë–ª –≤–º–µ—Å—Ç–µ —Å —Ç–æ–±–æ–π.<br><br>–û—Ö–æ—Ç–∞ –Ω–∞—á–∞–ª–∞—Å—å —Å—Ä–∞–∑—É: —Å–Ω–∞—á–∞–ª–∞ –æ—Ç ‚Äú–Ω–∞—Ä–æ–¥–∞‚Äù, –ø–æ—Ç–æ–º –æ—Ç ‚Äú—Å–≤–æ–∏—Ö‚Äù. –¢—ã —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–Ω–∞–µ—à—å.<br><br>–ñ–∏–∑–Ω—å –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –Ω–∞–±–æ—Ä —á—É–∂–∏—Ö –∫–≤–∞—Ä—Ç–∏—Ä –∏ –Ω–æ–≤—ã—Ö —Å–∏–º-–∫–∞—Ä—Ç.<br><br>–¢—ã –Ω–µ –Ω–∞–∂–∞–ª —Ä—É–±–∏–ª—å–Ω–∏–∫. –ù–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–ª–∞—Ç–∏—à—å —Ü–µ–Ω—É."
            },
            walk_away_caught: {
                icon: "üö∂üìÑ",
                title: "–ù–ï –í–´–ü–£–°–¢–ò–õ–ò",
                text: "–¢—ã –ø–æ–ø—ã—Ç–∞–ª—Å—è —É–π—Ç–∏, –Ω–æ –ª–æ—è–ª—å–Ω–æ—Å—Ç—å —Å—ã–≥—Ä–∞–ª–∞ –ø—Ä–æ—Ç–∏–≤ —Ç–µ–±—è.<br><br>‚Äú–ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å‚Äù –ø—Ä–∏—à–ª–∏ —Å–≤–æ–∏ –∂–µ: —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–¥–µ–ª–∞–Ω–æ, —á—Ç–æ–±—ã –æ—Ç–ø—É—Å–∫–∞—Ç—å.<br><br>–ù–æ–≤–∞—è –¥–æ–ª–∂–Ω–æ—Å—Ç—å. –ù–æ–≤—ã–µ –±—É–º–∞–≥–∏. –ò –Ω–æ–≤—ã–π –∫—Ä—É–≥.<br><br>–ò–Ω–æ–≥–¥–∞ —Å–≤–æ–±–æ–¥–∞ ‚Äî –Ω–µ –≤ –≤—ã–±–æ—Ä–µ, –∞ –≤ —Ü–µ–Ω–µ, –∫–æ—Ç–æ—Ä—É—é –≥–æ—Ç–æ–≤ –∑–∞–ø–ª–∞—Ç–∏—Ç—å."
            },
            martyr: {
                icon: "üí•",
                title: "–ú–£–ß–ï–ù–ò–ö",
                text: "–¢—ã —É–Ω–∏—á—Ç–æ–∂–∏–ª –≤—Å—ë. –°–∏—Å—Ç–µ–º—É. –†—É–±–∏–ª—å–Ω–∏–∫. –ó–¥–∞–Ω–∏–µ. –°–µ–±—è.<br><br>–í–∑—Ä—ã–≤ –±—ã–ª –≤–∏–¥–µ–Ω –∑–∞ –∫–∏–ª–æ–º–µ—Ç—Ä—ã. –°–ú–ò –Ω–∞–∑–≤–∞–ª–∏ —ç—Ç–æ —Ç–µ—Ä–∞–∫—Ç–æ–º. –ò–ª–∏ –ø–æ–¥–≤–∏–≥–æ–º. –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–∞–Ω–∞–ª–∞.<br><br>–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –≤—ã–∂–∏–ª. –¢—ã ‚Äî –Ω–µ—Ç.<br><br>–ù–æ —Ç–≤–æ—ë –∏–º—è –ø–æ–º–Ω—è—Ç. –ö–∞–∫ —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –æ—Å—Ç–∞–Ω–æ–≤–∏–ª –±–µ–∑—É–º–∏–µ."
            },
            martyr_saint: {
                icon: "üí•üïØÔ∏è",
                title: "–°–í–Ø–¢–û–ô –ü–û –ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö–ê–ú",
                text: "–¢—ã –≤–∑–æ—Ä–≤–∞–ª —Å–∏—Å—Ç–µ–º—É ‚Äî –∏ —É–º–µ—Ä.<br><br>–¢–µ–±—è –ø—ã—Ç–∞—é—Ç—Å—è –æ—á–µ—Ä–Ω–∏—Ç—å, –Ω–æ —Å—Ä–µ–¥–∏ —Å–≤–æ–∏—Ö —Ç—ã —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è –ª–µ–≥–µ–Ω–¥–æ–π: ‚Äú–æ–Ω –º–æ–≥ –Ω–∞–∂–∞—Ç—å —Ä—É–±–∏–ª—å–Ω–∏–∫ ‚Äî –Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª –±–µ–∑—É–º–∏–µ‚Äù.<br><br>–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –≤—ã–∂–∏–ª. –õ—é–¥–∏ —Å–ø–æ—Ä—è—Ç –æ —Ç–µ–±–µ –≥–æ–¥–∞–º–∏.<br><br>–ò–Ω–æ–≥–¥–∞ –æ–¥–Ω–æ–≥–æ –ø–æ—Å—Ç—É–ø–∫–∞ —Ö–≤–∞—Ç–∞–µ—Ç, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å —Ö–æ–¥ –∏—Å—Ç–æ—Ä–∏–∏."
            },
            martyr_terror: {
                icon: "üí•üì∞",
                title: "–¢–ï–†–†–û–†",
                text: "–¢—ã —É–Ω–∏—á—Ç–æ–∂–∏–ª –∑–¥–∞–Ω–∏–µ –∏ —Å–µ–±—è.<br><br>–ì–Ω–µ–≤ –±—ã–ª —Ç–∞–∫–∏–º, —á—Ç–æ –æ–±—â–µ—Å—Ç–≤—É –Ω—É–∂–µ–Ω –±—ã–ª ‚Äú—Å–∏–º–≤–æ–ª‚Äù ‚Äî –∏ —Ç–µ–±—è –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç –≤ –Ω–µ–≥–æ: —Ç–µ—Ä—Ä–æ—Ä–∏—Å—Ç, —Ñ–∞–Ω–∞—Ç–∏–∫, —á—É–¥–æ–≤–∏—â–µ.<br><br>–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –≤—ã–∂–∏–ª, –Ω–æ —Å—Ç—Ä–∞—Ö –æ—Å—Ç–∞–ª—Å—è.<br><br>–í –∏—Å—Ç–æ—Ä–∏—é —Ç—ã –≤—Ö–æ–¥–∏—à—å –Ω–µ –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫ ‚Äî –∫–∞–∫ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ."
            },
            retired: {
                icon: "üèñÔ∏è",
                title: "–ü–ï–ù–°–ò–Ø",
                text: "–¢—ã —É—à—ë–ª. –ü–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –∑–¥–æ—Ä–æ–≤—å—è. –° –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –ø–µ–Ω—Å–∏–µ–π.<br><br>–¢–µ–ø–µ—Ä—å –∂–∏–≤—ë—à—å –≤ –¥–µ—Ä–µ–≤–Ω–µ. –ë–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ ‚Äî –ø–æ –∏—Ä–æ–Ω–∏–∏ —Å—É–¥—å–±—ã. –†–∞–∑–≤–æ–¥–∏—à—å –∫—É—Ä.<br><br>–ò–Ω–æ–≥–¥–∞ –ø–æ —Ä–∞–¥–∏–æ —Å–ª—ã—à–∏—à—å –æ –Ω–æ–≤—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞—Ö. –ò –¥—É–º–∞–µ—à—å: '–≠—Ç–æ –º–æ–≥ –±—ã—Ç—å —è.'<br><br>–ù–æ –∫—É—Ä—ã –≤–∞–∂–Ω–µ–µ."
            },
            escaped: {
                icon: "‚úàÔ∏è",
                title: "–ü–û–ë–ï–ì",
                text: "–¢—ã —Å–±–µ–∂–∞–ª. –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω, –ø–æ—Ç–æ–º –ì—Ä—É–∑–∏—è, –ø–æ—Ç–æ–º ‚Äî –∫—Ç–æ –∑–Ω–∞–µ—Ç.<br><br>–ò–Ω—Ç–µ—Ä–ø–æ–ª –Ω–µ –∏—â–µ—Ç. –ü–æ–∫–∞. –î–µ–Ω—å–≥–∏ –∫–æ–Ω—á–∞—é—Ç—Å—è. –ù–æ —Ç—ã –∂–∏–≤.<br><br>–í –Ω–æ–≤–æ—Å—Ç—è—Ö –≤–∏–¥–∏—à—å, –∫–∞–∫ –≤—Å—ë –≥–æ—Ä–∏—Ç. –ò –¥—É–º–∞–µ—à—å: '–ü—Ä–∞–≤–∏–ª—å–Ω–æ —Å–¥–µ–ª–∞–ª, —á—Ç–æ —Å—ä–µ–±–∞–ª.'<br><br>–ò–ª–∏ –Ω–µ—Ç?"
            },
            leaked: {
                icon: "üì∞",
                title: "–†–ê–ó–û–ë–õ–ê–ß–ò–¢–ï–õ–¨",
                text: "–¢—ã —Å–ª–∏–ª –≤—Å—ë. –î–æ–∫—É–º–µ–Ω—Ç—ã, –ø–µ—Ä–µ–ø–∏—Å–∫–∏, –ø—Ä–∏–∫–∞–∑—ã. The Guardian. Der Spiegel. –ú–µ–¥—É–∑–∞*.<br><br>–°–∫–∞–Ω–¥–∞–ª –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∞. –°–∞–Ω–∫—Ü–∏–∏. –û—Ç—Å—Ç–∞–≤–∫–∏. –¢–≤–æ—è –≥–æ–ª–æ–≤–∞ –≤ —Ä–æ–∑—ã—Å–∫–µ.<br><br>–ù–æ —Ç—ã –≥–µ—Ä–æ–π. –î–ª—è –∫–æ–≥–æ-—Ç–æ. –í—Ä–∞–≥ ‚Äî –¥–ª—è –¥—Ä—É–≥–∏—Ö. –ù–∞–≤—Å–µ–≥–¥–∞ ‚Äî –≤ –∏–∑–≥–Ω–∞–Ω–∏–∏."
            },
            quit_youtube: {
                icon: "üö™",
                title: "–£–í–û–õ–¨–ù–ï–ù–ò–ï",
                text: "–¢—ã –ø–æ–ª–æ–∂–∏–ª –∑–∞—è–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç–æ–ª –ü–µ—Ç—Ä–æ–≤–∏—á–∞.<br><br>'–¢—ã —á—ë, –æ—Ö—É–µ–ª? –¢—ã –ø–æ–Ω–∏–º–∞–µ—à—å, —á—Ç–æ –±—É–¥–µ—Ç?'<br><br>–ü–æ–Ω–∏–º–∞–µ—à—å. –ò –ø–æ—Ö—É–π. –¢—ã –≤—ã—à–µ–ª –∏–∑ –∑–¥–∞–Ω–∏—è –∏ –±–æ–ª—å—à–µ –Ω–µ –≤–µ—Ä–Ω—É–ª—Å—è.<br><br>YouTube —Ä–∞–±–æ—Ç–∞–µ—Ç. –¢—ã ‚Äî –±–µ–∑—Ä–∞–±–æ—Ç–Ω—ã–π. –ù–æ —Å–æ —Å–ø–æ–∫–æ–π–Ω–æ–π —Å–æ–≤–µ—Å—Ç—å—é. –ü–æ—á—Ç–∏."
            },
            quit_vpn: {
                icon: "üö™",
                title: "–¢–û–ß–ö–ê",
                text: "–•–≤–∞—Ç–∏—Ç. –ü—Ä–æ—Å—Ç–æ ‚Äî —Ö–≤–∞—Ç–∏—Ç.<br><br>–¢—ã –Ω–∞–ø–∏—Å–∞–ª –∑–∞—è–≤–ª–µ–Ω–∏–µ, –≤—ã–∫–ª—é—á–∏–ª –∫–æ–º–ø—å—é—Ç–µ—Ä –∏ –≤—ã—à–µ–ª.<br><br>–ù–∏–∫—Ç–æ –Ω–µ –¥–µ—Ä–∂–∞–ª. –ù–∏–∫—Ç–æ –Ω–µ –ø–ª–∞–∫–∞–ª. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Ç–µ–±—è.<br><br>–ê —Ç—ã —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—à—å –≤ –ü—è—Ç—ë—Ä–æ—á–∫–µ. –ò –∑–Ω–∞–µ—à—å —á—Ç–æ? –ù–æ—Ä–º."
            },
            dead: {
                icon: "‚ò†Ô∏è",
                title: "–°–ú–ï–†–¢–¨",
                text: "–û–Ω–∏ –¥–æ—Å—Ç–∞–ª–∏ —Ç–µ–±—è. –ö—Ç–æ –∏–º–µ–Ω–Ω–æ ‚Äî —É–∂–µ –Ω–µ–≤–∞–∂–Ω–æ.<br><br>–•–∞–∫–µ—Ä—ã. –ü—Ä–æ—Ç–µ—Å—Ç—É—é—â–∏–µ. –ú–æ–∂–µ—Ç, —Å–≤–æ–∏ –∂–µ ‚Äî –∑–∞ –ø—Ä–æ–≤–∞–ª.<br><br>–¢–µ–ª–æ –Ω–∞—à–ª–∏ —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é. –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ ‚Äî —Å–µ—Ä–¥–µ—á–Ω—ã–π –ø—Ä–∏—Å—Ç—É–ø.<br><br>–ù–µ–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ ‚Äî –≤—Å–µ –≤—Å—ë –ø–æ–Ω–∏–º–∞—é—Ç."
            },
            fired: {
                icon: "üìÑ",
                title: "–£–í–û–õ–ï–ù",
                text: "–°–∞–±–æ—Ç–∞–∂ –≤—Å–∫—Ä—ã–ª—Å—è. –¢–µ–±—è –≤—ã–∑–≤–∞–ª–∏ –Ω–∞ –∫–æ–≤—ë—Ä.<br><br>'–¢—ã —á—Ç–æ —Ç–≤–æ—Ä–∏—à—å, —ë–±–∞–Ω—ã–π –∫—Ä–æ—Ç?!'<br><br>–£–≤–æ–ª–µ–Ω –ø–æ —Å—Ç–∞—Ç—å–µ. –ë–µ–∑ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ. –° –≤–æ–ª—á—å–∏–º –±–∏–ª–µ—Ç–æ–º.<br><br>–ù–æ —Ö–æ—Ç—è –±—ã –∂–∏–≤. –ò –∏–Ω—Ç–µ—Ä–Ω–µ—Ç ‚Äî —Ç–æ–∂–µ."
            }
        };

        // === PROLOGUE ===
        function startPrologue() {
            const textEl = document.getElementById('prologueText');
            textEl.classList.add('visible');
            
            prologueInterval = setInterval(() => {
                if (prologueIndex < prologueLines.length) {
                    textEl.textContent += prologueLines[prologueIndex] + '\n';
                    prologueIndex++;
                } else {
                    clearInterval(prologueInterval);
                    document.getElementById('prologueContinue').classList.add('visible');
                }
            }, 300);
        }

        function skipPrologue() { clearInterval(prologueInterval); endPrologue(); }

        function endPrologue() {
            document.getElementById('prologueScreen').classList.add('hidden');
            document.getElementById('introScreen').classList.remove('hidden');
            updateIntroContinueButton();
        }

        // === GAME START ===
        
        
        // === Telegram BackButton integration ===
        function setupTelegramButtons(){
            const tg = window.__tg || (window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null);
            if (!tg) return;

            if (window.__tgBtnsSetup) return;
            window.__tgBtnsSetup = true;

            // MainButton = –±—ã—Å—Ç—Ä—ã–π —Å–µ–π–≤ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ –º–µ–Ω—é, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª –∏–≥—Ä—É)
            try{
                tg.MainButton.setText('üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å');
                tg.MainButton.hide();
                tg.MainButton.onClick(()=>{ 
                    try{ 
                        manualSave(true); 
                        showNotification('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); 
                        safeHaptic('light'); 
                    }catch(e){} 
                });
            }catch(e){}

            // BackButton closes overlays/modals
            try{
                tg.BackButton.show();
                tg.BackButton.onClick(()=>{
                    try{
                        const cm = document.getElementById('choiceModal');
                        if (cm && cm.classList.contains('show')){
                            cm.classList.remove('show');
                            uiState.modalOpen = false;
                            safeHaptic('light');
                            return;
                        }
                        const am = document.getElementById('achOverlay');
                        if (am && am.classList.contains('show')){
                            am.classList.remove('show');
                            safeHaptic('light');
                            return;
                        }
                        const menu = document.getElementById('menuOverlay');
                        if (menu && menu.classList.contains('show')){
                            closeMenu();
                            safeHaptic('light');
                            return;
                        }
                    }catch(e){}
                    try{ tg.close(); }catch(e){}
                });
            }catch(e){}
        }

        function showTgMainButton(){
            const tg = window.__tg || (window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null);
            if (!tg) return;
            try{ tg.MainButton.show(); }catch(e){}
            document.body.classList.add('tg-mainbutton');
        }

        function hideTgMainButton(){
            const tg = window.__tg || (window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null);
            if (!tg) return;
            try{ tg.MainButton.hide(); }catch(e){}
            document.body.classList.remove('tg-mainbutton');
        }

        function startGame() {
            // –Ω–æ–≤–∞—è –∏–≥—Ä–∞: –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å—ë (–≤–∫–ª—é—á–∞—è –ø—Ä–µ—Å—Ç–∏–∂/–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è)
            clearSave();
            gameState = makeBaseState(false);
            ensureMeta();

            document.getElementById('introScreen').classList.add('hidden');
            document.getElementById('gameContainer').classList.remove('hidden');

            initUpgrades(false);
            updateDialog();
            updateRank();
            updateDisplay(true);
            updateNews();
            updatePrestigeButton();
            startGameLoop();

            setTimeout(() => showChapter(0), 450);
            setTimeout(() => { try { runStartScenes(); } catch(e){} }, 700);
            manualSave(true);
            safeHaptic('heavy');
        }


        
        function initUpgrades(isResume=false) {
            if (!gameState.upgrades || typeof gameState.upgrades !== 'object') gameState.upgrades = {};
            upgradesData.forEach(u => {
                if (!gameState.upgrades[u.id]) gameState.upgrades[u.id] = { level: 0 };
                if (!isResume && gameState.upgrades[u.id].level == null) gameState.upgrades[u.id].level = 0;
            });
            buildUpgradeCards();
            refreshUpgradeCards(true);
        }

        let _upgradeEls = null;

        function buildUpgradeCards() {
            const grid = document.getElementById('upgradesGrid');
            if (_upgradeEls) return; // —É–∂–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω—ã
            _upgradeEls = {};
            grid.innerHTML = '';

            upgradesData.forEach(u => {
                const card = document.createElement('div');
                card.className = 'upgrade-card';
                card.innerHTML = `
                    <div class="upgrade-level" data-up="lvl">–£—Ä.0</div>
                    <div class="upgrade-icon">${u.id === 'armor' ? 'üõ°Ô∏è' : u.id === 'bunker' ? 'üè†' : u.name.split(' ')[0]}</div>
                    <div class="upgrade-name">${u.name}</div>
                    <div class="upgrade-desc">${u.desc}</div>
                    <div class="upgrade-cost" data-up="cost">üí∞0</div>
                `;
                card.addEventListener('click', () => buyUpgrade(u.id));
                card.addEventListener('touchend', (e) => { e.preventDefault(); buyUpgrade(u.id); }, { passive:false });

                _upgradeEls[u.id] = card;
                grid.appendChild(card);
            });
        }

        function refreshUpgradeCards(force=false) {
            if (!_upgradeEls) return;
            upgradesData.forEach(u => {
                const card = _upgradeEls[u.id];
                if (!card) return;
                const level = gameState.upgrades[u.id]?.level || 0;
                const price = Math.floor(u.basePrice * Math.pow(u.mult, level));
                const canAfford = gameState.money >= price;

                card.classList.toggle('can-afford', canAfford);
                const lvlEl = card.querySelector('[data-up="lvl"]');
                const costEl = card.querySelector('[data-up="cost"]');
                if (lvlEl) lvlEl.textContent = `–£—Ä.${level}`;
                if (costEl) costEl.textContent = `üí∞${formatNumber(price)}`;
            });
        }

        // legacy alias
        function renderUpgrades() { refreshUpgradeCards(); }


        function buyUpgrade(id) {
            const u = upgradesData.find(x => x.id === id);
            if (!u) return;

            const level = gameState.upgrades[id]?.level || 0;
            let price = Math.floor(u.basePrice * Math.pow(u.mult, level));
            // —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –±–æ–Ω—É—Å ‚Äú–î–æ—Å—Ç—É–ø –∫ –±—é–¥–∂–µ—Ç—É‚Äù: —Ä–∞–∑–æ–≤–∞—è —Å–∫–∏–¥–∫–∞ –Ω–∞ –ø–µ—Ä–≤—É—é –ø–æ–∫—É–ø–∫—É
            if (gameState.firstBuyDiscount) {
                price = Math.floor(price * 0.80);
            }

            if (gameState.money < price) {
                showNotification('üí∏ –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –±—é–¥–∂–µ—Ç–∞');
                return;
            }

            gameState.money -= price;
            gameState.totalSpent += price;
            gameState.upgrades[id].level = level + 1;

            gameState.upgradeBuys = (gameState.upgradeBuys || 0) + 1;
            if (gameState.upgradeBuys === 1) unlockAchievement('first_upgrade');
            if ((gameState.upgradeBuys || 0) >= 10) unlockAchievement('ten_upgrades');

            if (u.effect === 'perSecond') gameState.perSecond += u.value;
            else if (u.effect === 'perClick') gameState.perClick += u.value;
            else if (u.effect === 'health') gameState.health = Math.min(100, gameState.health + u.value);
            else if (u.effect === 'tension') gameState.tension = Math.max(0, gameState.tension + u.value);

            // –ß—É—Ç—å-—á—É—Ç—å –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∑–∞ ‚Äú—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å‚Äù
            gameState.loyalty = Math.min(100, (gameState.loyalty ?? 50) + 1);

            showNotification(`${u.name} –∫—É–ø–ª–µ–Ω–æ`);
            refreshUpgradeCards(true);
            updateDisplay(true);
            manualSave(true);
            safeHaptic('medium');
        }


        // === BLOCK BUTTON ===
        const blockButton = document.getElementById('blockButton');

        // Pointer events = no double taps on mobile
        blockButton.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            blockButton.setPointerCapture?.(e.pointerId);
            doBlock(e.clientX, e.clientY);
        }, { passive: false });

        function spawnRipple(x, y) {
            const r = document.createElement('span');
            r.className = 'ripple';
            const rect = blockButton.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            r.style.width = r.style.height = size + 'px';
            r.style.left = (x - rect.left - size/2) + 'px';
            r.style.top = (y - rect.top - size/2) + 'px';
            blockButton.appendChild(r);
            setTimeout(() => r.remove(), 500);
        }

        function doBlock(x, y) {
            if (gameState.gameEnded || uiState.modalOpen) return;

            // visual feedback
            spawnRipple(x, y);
            blockButton.classList.remove('flash');
            // force reflow to restart animation
            void blockButton.offsetWidth;
            blockButton.classList.add('flash');

            // —Å—á—ë—Ç—á–∏–∫–∏
            gameState.clicks = (gameState.clicks || 0) + 1;
            if (gameState.clicks === 1) unlockAchievement('first_click');

            // –∫–∞—Ä—å–µ—Ä–∞: —á–µ–º –±–æ–ª—å—à–µ –±–ª–æ—á–∏—à—å, —Ç–µ–º –≤—ã—à–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç—å (–º–µ–¥–ª–µ–Ω–Ω–æ)
            gameState.loyalty = Math.min(100, (gameState.loyalty ?? 50) + 0.002 * gameState.perClick);
            if ((gameState.loyalty ?? 50) >= 90) unlockAchievement('loyal');


            const rates = getEffectiveRates();
            gameState.money += rates.perClick;
            gameState.totalBlocks += rates.perClick;

            if (!isAchUnlocked('1k_blocks') && (gameState.totalBlocks||0) >= 1000) unlockAchievement('1k_blocks');
            if (!isAchUnlocked('50k_blocks') && (gameState.totalBlocks||0) >= 50000) unlockAchievement('50k_blocks');

            
            if (gameState.bossActive) {
                gameState.bossHealth -= rates.perClick;
                updateBossHealth();
                if (gameState.bossHealth <= 0) defeatBoss();
            } else {
                gameState.targetProgress += rates.perClick;
                checkTargetCompletion();
            }
            
            createFlyingNumber(x, y, `+${formatNumber(rates.perClick)}`);

            checkChapters();
            updateRank();
            updateDisplay(true);
            manualSave(true);

            
            safeHaptic('light');

            // –∞–≤—Ç–æ—Å–µ–π–≤: —Ä–∞–∑ –≤ ~5 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            if (!uiState._lastAutosave || Date.now() - uiState._lastAutosave > 5000) {
                uiState._lastAutosave = Date.now();
                manualSave(true);
            }

        }

        function createFlyingNumber(x, y, text) {
            const num = document.createElement('div');
            num.className = 'fly-number';
            num.textContent = text;
            num.style.left = x + 'px';
            num.style.top = y + 'px';
            document.body.appendChild(num);
            setTimeout(() => num.remove(), 1000);
        }

        // === TARGET COMPLETION ===
        function checkTargetCompletion() {
            const target = targets[gameState.currentTargetIndex];
            if (!target || gameState.bossActive) return;
            
            if (gameState.targetProgress >= target.required) {
                if (target.hasChoice) {
                    showChoice(target.choiceId);
                } else if (target.isBoss) {
                    startBoss(target);
                } else {
                    completeTarget(target);
                }
            }
        }

        function startBoss(target) {
            gameState.bossActive = true;
            gameState.bossHealth = target.bossHealth;
            gameState.bossMaxHealth = target.bossHealth;
            
            document.getElementById('targetPanel').classList.add('hidden');
            document.getElementById('bossPanel').classList.remove('hidden');
            document.getElementById('bossName').textContent = target.name;
            updateBossHealth();
            
            showStoryOverlay(target.dialog.avatar, target.dialog.name + ': ' + target.dialog.role, target.dialog.text);
        }

        function updateBossHealth() {
            const percent = Math.max(0, (gameState.bossHealth / gameState.bossMaxHealth) * 100);
            document.getElementById('bossHealthBar').style.width = percent + '%';
            document.getElementById('bossHealthText').textContent = formatNumber(Math.max(0, gameState.bossHealth));
        }

        function defeatBoss() {
            gameState.bossActive = false;
            document.getElementById('bossPanel').classList.add('hidden');
            document.getElementById('targetPanel').classList.remove('hidden');
            
            const target = targets[gameState.currentTargetIndex];
            completeTarget(target);
        }

        function completeTarget(target) {
            ensureMeta();
            gameState.blockedSites.push(target.name);
            gameState.collection.targets[target.name] = true;
            gameState.money += target.reward;
            gameState.tension = Math.min(100, gameState.tension + (target.tensionAdd || 0));
            gameState.loyalty = Math.min(100, (gameState.loyalty ?? 50) + 1.5);
            recalcDay();
            
            if (target.isEnding) {
                triggerEnding('internet_dead');
                return;
            }
            
            showStoryOverlay('üö´', '–ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–û!', target.completion);
            addBlockedSite(target.name);
            
            if (target.news) updateNews(target.news);
            if (target.triggerEvent && !gameState.eventsTriggered.includes(target.triggerEvent)) {
                gameState.eventsTriggered.push(target.triggerEvent);
                setTimeout(() => triggerEvent(target.triggerEvent), 2000);
            }
            
            gameState.currentTargetIndex++;
            gameState.targetProgress = 0;
            
            updateDialog();
            checkTensionThreshold();
            checkHealthThreshold();
            manualSave(true);
        }

        // === CHOICES ===
        function showChoice(choiceId) {
            const choice = gameChoices[choiceId];
            if (!choice) return;
            
            document.getElementById('choiceIcon').textContent = choice.icon;
            document.getElementById('choiceTitle').textContent = choice.title;
            document.getElementById('choiceText').innerHTML = choice.text;
            
            const buttonsDiv = document.getElementById('choiceButtons');
            buttonsDiv.innerHTML = '';
            
            choice.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = `choice-btn ${i === 0 ? 'primary' : 'secondary'}`;
                btn.type = 'button';
                btn.innerHTML = `<strong>${opt.text}</strong><div class="choice-consequence">${opt.subtext}</div>`;
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏ click –∏ touchend –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
                const handleClick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    handleChoice(choiceId, opt);
                };
                
                btn.addEventListener('click', handleClick);
                btn.addEventListener('touchend', handleClick);
                
                buttonsDiv.appendChild(btn);
            });
            
            uiState.modalOpen = true;
            document.getElementById('choiceModal').classList.add('show');
            
            safeHaptic('medium');
        }

        function handleChoice(choiceId, option) {
            document.getElementById('choiceModal').classList.remove('show');
            uiState.modalOpen = false;
            
            if (option.isEnding) {
                const endingType = option.endingType || option.action.replace('quit_', 'quit_');
                if (option.action === 'leak') triggerEnding('leaked');
                else if (option.action === 'quit_youtube') triggerEnding('quit_youtube');
                else if (option.action === 'quit_vpn') triggerEnding('quit_vpn');
                else if (option.action === 'escape') triggerEnding('escaped');
                else if (option.action === 'retire') triggerEnding('retired');
                else if (option.action === 'walk_away') { startEscapeArc(); return; }
                else if (option.action === 'destroy') triggerEnding('martyr');
                else if (option.endingType) triggerEnding(option.endingType);
                return;
            }
            
            if (option.tensionAdd) gameState.tension = Math.min(100, Math.max(0, gameState.tension + option.tensionAdd));
            
            if (option.action === 'sabotage') {
                if (Math.random() * 100 < (option.riskFire || 0)) {
                    setTimeout(() => triggerEnding('fired'), 1000);
                    return;
                }
                showNotification('–°–∞–±–æ—Ç–∞–∂ —É–¥–∞–ª—Å—è... –ø–æ–∫–∞');
            }
            
            if (option.action === 'block' || option.action === 'continue') {
                gameState.loyalty = Math.min(100, (gameState.loyalty ?? 50) + 2);

                const target = targets[gameState.currentTargetIndex];
                if (target.isBoss && !gameState.bossActive) {
                    startBoss(target);
                } else if (!target.isBoss) {
                    completeTarget(target);
                }
            }
            
            updateDisplay();
        }

        // === EVENTS ===
        function triggerEvent(eventId) {
            const event = gameEvents[eventId];
            if (!event) return;
            
            document.body.classList.add('shake');
            setTimeout(() => document.body.classList.remove('shake'), 500);
            
            gameState.tension = Math.min(100, gameState.tension + (event.tensionAdd || 0));
            gameState.health = Math.max(0, gameState.health - (event.healthLoss || 0));
            
            if (event.news) updateNews(event.news);
            
            showStoryOverlay(event.icon, event.title, event.text);
            
            if (gameState.health <= 0) {
                setTimeout(() => triggerEnding('dead'), 2000);
            }
            
            gameState.loyalty = Math.min(100, Math.max(0, (gameState.loyalty ?? 50) - 1));
            updateDisplay(true);
            checkHealthThreshold();
            manualSave(true);
        }

        function checkTensionThreshold() {
            if (gameState.tension >= 90) unlockAchievement('fury');
            if (gameState.tension >= 90 && !gameState.eventsTriggered.includes('high_tension_choice')) {
                gameState.eventsTriggered.push('high_tension_choice');
                setTimeout(() => showChoice('high_tension'), 2000);
            }
        }

        function checkHealthThreshold() {
            if (gameState.health <= 20 && gameState.health > 0 && !gameState.eventsTriggered.includes('low_health_choice')) {
                gameState.eventsTriggered.push('low_health_choice');
                setTimeout(() => showChoice('low_health'), 2000);
            }
        }

        // === UI UPDATES ===
        function updateDialog() {
            const target = targets[gameState.currentTargetIndex];
            if (!target) return;
            
            const d = target.dialog;
            document.getElementById('dialogAvatar').textContent = d.avatar;
            document.getElementById('dialogName').textContent = d.name;
            document.getElementById('dialogRole').textContent = d.role;
            document.getElementById('dialogText').innerHTML = d.text;
        }

        function updateNews(text) {
            document.getElementById('newsText').textContent = text || newsHeadlines[Math.floor(Math.random() * newsHeadlines.length)];
        }

        function showChapter(index) {
            const chapter = chapters[index];
            document.getElementById('chapterNumber').textContent = `–ì–õ–ê–í–ê ${chapter.num}`;
            document.getElementById('chapterTitle').textContent = chapter.title;
            
            const screen = document.getElementById('chapterScreen');
            screen.classList.add('show');
            setTimeout(() => screen.classList.remove('show'), 2500);
        }

        function checkChapters() {
            chapters.forEach((chapter, index) => {
                if (gameState.totalBlocks >= chapter.trigger && gameState.currentChapter < index) {
                    gameState.currentChapter = index;
                    setTimeout(() => showChapter(index), 500);
                }
            });
        }

        function updateRank() {
            let currentRank = ranks[0];
            for (let r of ranks) {
                if (gameState.totalBlocks >= r.blocks) currentRank = r;
            }
            document.getElementById('rankDisplay').textContent = currentRank.name;
        }

        function addBlockedSite(name) {
            const list = document.getElementById('blockedList');
            const badge = document.createElement('div');
            badge.className = 'site-badge';
            badge.textContent = name.substring(0, 20);
            list.insertBefore(badge, list.firstChild);
        }

        function showStoryOverlay(icon, title, text) {
            uiState.modalOpen = true;
            document.getElementById('storyOverlayIcon').textContent = icon;
            document.getElementById('storyOverlayTitle').textContent = title;
            document.getElementById('storyOverlayText').innerHTML = text;
            document.getElementById('storyOverlay').classList.add('show');
        }

        function closeStoryOverlay() {
            document.getElementById('storyOverlay').classList.remove('show');
            uiState.modalOpen = false;
        }

        function showNotification(text) {
            document.getElementById('notificationText').textContent = text;
            document.getElementById('notification').classList.add('show');
            setTimeout(() => document.getElementById('notification').classList.remove('show'), 2000);
        }

        function updateDisplay(force=false) {
            document.getElementById('money').textContent = formatNumber(gameState.money);
            document.getElementById('totalBlocks').textContent = formatNumber(gameState.totalBlocks);
            const rates = getEffectiveRates();
            document.getElementById('perClick').textContent = formatNumber(rates.perClick);
            const buffsCount = (gameState.buffs || []).filter(b => b.expiresAt > Date.now()).length;
            document.getElementById('perSecondPill').textContent = formatNumber(rates.perSecond);
            document.getElementById('buffsPill').textContent = buffsCount;
            document.getElementById('health').textContent = gameState.health;
            document.getElementById('health').className = `stat-value ${gameState.health <= 30 ? 'danger' : ''}`;
            document.getElementById('day').textContent = gameState.day || 1;
            document.getElementById('loyalty').textContent = Math.floor(gameState.loyalty ?? 50);
            const posEl = document.getElementById('position');
            if (posEl) posEl.textContent = positionLabel();
            
            // Tension
            document.getElementById('tensionValue').textContent = Math.floor(gameState.tension) + '%';
            document.getElementById('tensionFill').style.width = gameState.tension + '%';
            
            let warning = '';
            if (gameState.tension >= 80) warning = '‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –£–†–û–í–ï–ù–¨!';
            else if (gameState.tension >= 60) warning = 'üò† –ù–∞—Ä–æ–¥ –≤ —è—Ä–æ—Å—Ç–∏';
            else if (gameState.tension >= 40) warning = 'üò§ –†–∞—Å—Ç—ë—Ç –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ';
            else if (gameState.tension >= 20) warning = 'üòê –ï—Å—Ç—å –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ';
            document.getElementById('tensionWarning').textContent = warning;
            
            // Target
            if (!gameState.bossActive) {
                const target = targets[gameState.currentTargetIndex];
                if (target) {
                    document.getElementById('targetName').textContent = target.name;
                    const progress = Math.min(100, (gameState.targetProgress / target.required) * 100);
                    document.getElementById('targetProgress').style.width = progress + '%';
                    document.getElementById('targetProgressText').textContent = `${formatNumber(gameState.targetProgress)}/${formatNumber(target.required)}`;
                }
            }
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return Math.floor(num).toString();
        }

        function formatTime(ms) {
            const s = Math.floor(ms / 1000);
            const m = Math.floor(s / 60);
            const h = Math.floor(m / 60);
            if (h > 0) return `${h}—á ${m % 60}–º`;
            if (m > 0) return `${m}–º ${s % 60}—Å`;
            return `${s}—Å`;
        }


        // === BUFFS / DEBUFFS ===
        function pruneBuffs() {
            const now = Date.now();
            gameState.buffs = (gameState.buffs || []).filter(b => b.expiresAt > now);
        }

        function addBuff(buff) {
            pruneBuffs();
            gameState.buffs = gameState.buffs || [];

            // —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –±–æ–Ω—É—Å–æ–≤ = —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ö–∞–æ—Å–∞.
            // –¥–µ—Ä–∂–∏–º –º–∞–∫—Å–∏–º—É–º 2 –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–∞ (—Å–∞–º—ã–µ —Å–≤–µ–∂–∏–µ).
            // —Ç–∞–∫–∂–µ –Ω–µ –¥–∞—ë–º –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∏–º–µ–Ω–∞.
            if (buff && buff.name) {
                gameState.buffs = gameState.buffs.filter(b => b.name !== buff.name);
            }

            if (gameState.buffs.length >= 2) {
                gameState.buffs.sort((a,b)=> (a.expiresAt||0) - (b.expiresAt||0));
                gameState.buffs.shift();
            }
            gameState.buffs.push(buff);
        }

        function getEffectiveRates() {
            pruneBuffs();
            let perClick = (gameState.perClick || 0) + (gameState.permClickAdd || 0);
            let perSecond = (gameState.perSecond || 0) * (gameState.permSecondMul || 1);

            for (const b of (gameState.buffs || [])) {
                if (b.perClickMul) perClick *= b.perClickMul;
                if (b.perSecondMul) perSecond *= b.perSecondMul;
                if (b.perClickAdd) perClick += b.perClickAdd;
                if (b.perSecondAdd) perSecond += b.perSecondAdd;
            }

            perClick = Math.max(0, perClick);
            perSecond = Math.max(0, perSecond);
            return { perClick, perSecond };
        }

        function describeBuffs() {
            pruneBuffs();
            const now = Date.now();
            const list = (gameState.buffs || []).map(b => `‚Ä¢ ${b.name} (${formatTime(b.expiresAt - now)})`);
            return list.length ? list.join('<br>') : '‚Äî';
        }

        
// === DOCUMENTS / CLUES SYSTEM ===
const allDocuments = [
 {id:'order66',   name:'–ü—Ä–∏–∫–∞–∑ ‚Ññ66',          desc:'–¢–∞–π–Ω—ã–π –ø—Ä–∏–∫–∞–∑ –æ–± —É–∂–µ—Å—Ç–æ—á–µ–Ω–∏–∏ —Ü–µ–Ω–∑—É—Ä—ã.', real:true,  rarity:1},
 {id:'leak1',     name:'–°–ª–∏–≤ –±–∞–∑—ã',           desc:'–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –Ω–µ–∑–∞–∫–æ–Ω–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫.', real:true,  rarity:1},
 {id:'memo',      name:'–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∑–∞–ø–∏—Å–∫–∞',  desc:'–ü—Ä–∏–∑–Ω–∞–Ω–∏–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –≤ –ø—Ä–æ–≤–∞–ª–µ.',     real:true,  rarity:1},
 {id:'blacklist', name:'–ß—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫',       desc:'–°–ø–∏—Å–æ–∫ –Ω–µ—Å–æ–≥–ª–∞—Å–Ω—ã—Ö –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–æ–≤.',      real:true,  rarity:1},
 {id:'protocol',  name:'–ü—Ä–æ—Ç–æ–∫–æ–ª –¥–æ–ø—Ä–æ—Å–∞',    desc:'–ü–∞—á–∫–∞ —Ñ–∞–ª—å—à–∏–≤—ã—Ö –ø–æ–∫–∞–∑–∞–Ω–∏–π.',            real:true,  rarity:1},

 // –§–ï–ô–ö–ò (–æ–ø–∞—Å–Ω–æ —Å–ª–∏–≤–∞—Ç—å)
 {id:'decoy',     name:'–ü–∞–ø–∫–∞-–ø—Ä–∏–º–∞–Ω–∫–∞',      desc:'–°–ª–∏—à–∫–æ–º ‚Äú—É–¥–æ–±–Ω–∞—è‚Äù —É–ª–∏–∫–∞. –ü–∞—Ö–Ω–µ—Ç –ª–æ–≤—É—à–∫–æ–π.', real:false, rarity:2},
 {id:'deepfake',  name:'–î–∏–ø—Ñ–µ–π–∫-—Ä–∞—Å–ø–µ—á–∞—Ç–∫–∞',  desc:'–ö–∞—Ä—Ç–∏–Ω–∫–∏, –ø–æ–¥–ø–∏—Å–∏, –ø–µ—á–∞—Ç–∏‚Ä¶ –Ω–æ –≤—Å—ë –∫–∞–∫-—Ç–æ –∫—Ä–∏–≤–æ.', real:false, rarity:2}
];

function docById(id){ return allDocuments.find(d=>d.id===id); }

function ensureDocs(){
    if (!gameState.documents) gameState.documents = [];
    if (Array.isArray(gameState.documents) && gameState.documents.length && typeof gameState.documents[0] === 'string') {
        gameState.documents = gameState.documents.map(x => ({ id:x, real:true, status:'kept', ts:Date.now() }));
    }
    if (!Array.isArray(gameState.documents)) gameState.documents = [];
    gameState.resistance = (gameState.resistance ?? 0);
    gameState.suspicion  = (gameState.suspicion  ?? 0);
}

function hasDoc(id){
    ensureDocs();
    return gameState.documents.some(d=>d.id===id && d.status!=='burned');
}

function addDoc(doc){
    ensureDocs();
    if (!doc || hasDoc(doc.id)) return false;
    const entry = { id: doc.id, real: !!doc.real, status: 'kept', ts: Date.now() };
    gameState.documents.push(entry);
    showToast((entry.real ? 'üìÑ' : 'üßª') + ' –î–æ–∫—É–º–µ–Ω—Ç: ' + doc.name);
    if (!entry.real) unlockAchievement('fake_doc');
    if (countDocs({realOnly:false}) >= 3) unlockAchievement('doc_3');
    manualSave(true);
    return true;
}

function addRandomDocument(reason='') {
    ensureDocs();
    const available = allDocuments.filter(d => !hasDoc(d.id));
    if (!available.length) return false;

    // –±–∞–∑–æ–≤—ã–π —à–∞–Ω—Å —Ä–µ–¥–∫–æ–π –Ω–∞—Ö–æ–¥–∫–∏
    let chance = 0.12;

    // —Ü–µ–ø–æ—á–∫–∏: –∏–º–µ–µ—à—å –æ–¥–Ω—É —É–ª–∏–∫—É ‚Äî —à–∞–Ω—Å –ø–æ–ª—É—á–∏—Ç—å ‚Äú—Å–ª–µ–¥—É—é—â—É—é‚Äù –≤—ã—à–µ
    if (hasDoc('order66') && !hasDoc('memo')) chance += 0.06;
    if (hasDoc('leak1') && !hasDoc('blacklist')) chance += 0.05;
    if (hasDoc('blacklist') && !hasDoc('protocol')) chance += 0.04;

    // –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ = –±–æ–ª—å—à–µ –ø—Ä–∏–º–∞–Ω–æ–∫
    const sus = (gameState.suspicion||0);
    const fakeBoost = sus >= 55 ? 0.12 : 0.0;

    if (Math.random() > chance) return false;

    // –≤–∑–≤–µ—à–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä
    const pool = available.map(d=>{
        let w = 1 / (d.rarity || 1);
        if (!d.real) w += fakeBoost;

        // –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ü–µ–ø–æ—á–∫–∏
        if (d.id==='memo' && hasDoc('order66')) w *= 1.8;
        if (d.id==='blacklist' && hasDoc('leak1')) w *= 1.7;
        if (d.id==='protocol' && hasDoc('blacklist')) w *= 1.5;
        return {d, w};
    });

    const sum = pool.reduce((a,x)=>a+x.w,0);
    let r = Math.random() * sum;
    for (const x of pool) { r -= x.w; if (r<=0) return addDoc(x.d); }
    return addDoc(pool[0].d);
}

// === RANDOM ENCOUNTERS ===
        const encounters = [
            {
                id: 'ddos',
                weight: 3,
                title: 'DDoS-–∞–¥',
                icon: 'üå™Ô∏è',
                text: '–°–µ—Ä–≤–∞–∫–∏ –≤ –∫—Ä–∞—Å–Ω–æ–π –∑–æ–Ω–µ, –º–µ—Ç—Ä–∏–∫–∏ –ø–ª–∞—á—É—Ç, –Ω–∞—á–∞–ª—å—Å—Ç–≤–æ –æ—Ä—ë—Ç. –ß—Ç–æ –¥–µ–ª–∞–µ—à—å?',
                minDay: 2,
                options: [
                    { text: 'üí∏ –û–ø–ª–∞—Ç–∏—Ç—å –∑–∞—â–∏—Ç—É', subtext: '–ú–∏–Ω—É—Å –¥–µ–Ω—å–≥–∏, –ø–ª—é—Å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å', action: 'ddos_pay' },
                    { text: 'üò§ –¢–µ—Ä–ø–µ—Ç—å', subtext: '–õ–∞–≥–∏, –≥–Ω–µ–≤ —Ä–∞—Å—Ç—ë—Ç', action: 'ddos_tank' },
                    { text: 'ü§ù ‚Äú–î–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è‚Äù', subtext: '–†–∏—Å–∫: –º–æ–≥—É—Ç –ø–æ—Ç–æ–º –≤–µ—Ä–Ω—É—Ç—å—Å—è', action: 'ddos_deal' }
                ]
            },
            {
                id: 'insider',
                weight: 2,
                title: '–ò–Ω—Å–∞–π–¥–µ—Ä',
                icon: 'üïµÔ∏è',
                text: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —à–µ–ø—á–µ—Ç: ‚Äú–ï—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã. –•–æ—á–µ—à—å ‚Äî –ø—Ä–∏–Ω–µ—Å—É.‚Äù',
                minDay: 3,
                options: [
                    { text: 'üìÇ –í–∑—è—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã', subtext: '–ü–æ—è–≤—è—Ç—Å—è —É–ª–∏–∫–∏ –∏ —Ü–µ–ø–æ—á–∫–∞', action: 'insider_take' },
                    { text: 'üö´ –°–¥–∞—Ç—å –µ–≥–æ', subtext: '–õ–æ—è–ª—å–Ω–æ—Å—Ç—å –≤–≤–µ—Ä—Ö, –ø–æ–¥–ø–æ–ª—å–µ –∑–ª–∏—Ç—Å—è', action: 'insider_report' },
                    { text: 'ü§ê –û—Ç–∫—É–ø–∏—Ç—å—Å—è', subtext: '–î–æ—Ä–æ–≥–æ, –Ω–æ —Ç–∏—à–µ', action: 'insider_pay' }
                ]
            },
            {
                id: 'journalist',
                weight: 2,
                title: '–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç',
                icon: 'üé•',
                text: '–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç –∫–æ–ø–∞–µ—Ç –ø–æ–¥ —Ç–µ–±—è –∏ —è–≤–Ω–æ —á—Ç–æ-—Ç–æ –≤—ã–Ω—é—Ö–∏–≤–∞–µ—Ç.',
                minDay: 4,
                options: [
                    { text: 'üßæ –ü–æ–¥–∫—É–ø–∏—Ç—å', subtext: '–î–µ–Ω—å–≥–∏ –≤ —Ç—Ä—É–±—É, –Ω–æ —à—É–º —Ç–∏—à–µ', action: 'journalist_bribe' },
                    { text: '‚ö° –ó–∞–ø—É–≥–∞—Ç—å', subtext: '–ì–Ω–µ–≤ —Ä–∞—Å—Ç—ë—Ç, —Ä–∏—Å–∫ —Ç–æ–∂–µ', action: 'journalist_threat' },
                    { text: 'üìú –ù–∞–º–µ–∫–Ω—É—Ç—å –Ω–∞ –ø—Ä–∞–≤–¥—É', subtext: '–ü–æ–¥–ø–æ–ª—å–µ –¥–æ–≤–æ–ª—å–Ω–µ–µ, –ª–æ—è–ª—å–Ω–æ—Å—Ç—å –ø–∞–¥–∞–µ—Ç', action: 'journalist_truth' }
                ]
            },
            {
                id: 'audit',
                weight: 2,
                title: '–ü—Ä–æ–≤–µ—Ä–∫–∞',
                icon: 'üìã',
                text: '–ö–æ–º–∏—Å—Å–∏—è —Ä–æ–µ—Ç—Å—è –≤ –±—É–º–∞–≥–∞—Ö –∏ –∑–∞–¥–∞—ë—Ç –º–µ—Ä–∑–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã.',
                minDay: 5,
                options: [
                    { text: 'üßπ ‚Äú–ü–æ—Ä–µ—à–∞—Ç—å‚Äù', subtext: '–ú–∏–Ω—É—Å –¥–µ–Ω—å–≥–∏, –ø–ª—é—Å –ª–æ—è–ª—å–Ω–æ—Å—Ç—å', action: 'audit_bribe' },
                    { text: 'üìú –£–ø—ë—Ä–µ—Ç—å—Å—è –≤ –∑–∞–∫–æ–Ω', subtext: '–ü—Ä–∏–¥—Ä–∞–ª–∏—Å—å ‚Äî –∏ –ø–æ–Ω–µ—Å–ª–æ—Å—å', action: 'audit_law' },
                    { text: 'üÉè –î–≤–æ–π–Ω–∞—è –∏–≥—Ä–∞', subtext: '–ü–æ–¥–ø–æ–ª—å–µ –ø–æ–ª—É—á–∞–µ—Ç –∫—Ä–æ—à–∫–∏, —Ä–∏—Å–∫ —Ä–∞—Å—Ç—ë—Ç', action: 'audit_double' }
                ]
            },
            {
                id: 'overtime',
                weight: 2,
                title: '–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞',
                icon: '‚òï',
                text: '‚Äú–ù–∞–¥–æ —É—Å–∫–æ—Ä–∏—Ç—å—Å—è. –°–µ–≥–æ–¥–Ω—è –±–µ–∑ —Å–Ω–∞.‚Äù',
                minDay: 2,
                options: [
                    { text: 'ü´° –û—Å—Ç–∞—Ç—å—Å—è', subtext: '–ë–∞—Ñ—Ñ –∫–ª–∏–∫–∞, –º–∏–Ω—É—Å –∑–¥–æ—Ä–æ–≤—å–µ', action: 'ot_go' },
                    { text: 'üôÖ –û—Ç–∫–∞–∑–∞—Ç—å—Å—è', subtext: '–õ–æ—è–ª—å–Ω–æ—Å—Ç—å –≤–Ω–∏–∑', action: 'ot_no' }
                ]
            },
            {
                id: 'vacation',
                weight: 1,
                title: '–í—ã—Ö–æ–¥–Ω–æ–π',
                icon: 'üèñÔ∏è',
                text: '–ï—Å—Ç—å —à–∞–Ω—Å –≤—ã–¥–æ—Ö–Ω—É—Ç—å.',
                minDay: 6,
                options: [
                    { text: 'üèñÔ∏è –û—Ç–¥–æ—Ö–Ω—É—Ç—å', subtext: '–•–ø +, –≥–Ω–µ–≤ -', action: 'vac_take' },
                    { text: 'ü´° –†–∞–±–æ—Ç–∞—Ç—å', subtext: '–õ–æ—è–ª—å–Ω–æ—Å—Ç—å +', action: 'vac_work' }
                ]
            },

            // === CHAIN ENCOUNTERS ===
            {
                id: 'insider_followup',
                weight: 0,
                title: '–ë–µ–∑–æ–ø–∞—Å–Ω–∏–∫–∏',
                icon: 'üßø',
                text: '–ß–µ—Ä–µ–∑ –ø–∞—Ä—É –¥–Ω–µ–π –ø–æ—Å–ª–µ ‚Äú–º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤‚Äù –ø—Ä–∏—à–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–∏–∫–∏: ‚Äú–û—Ç–∫—É–¥–∞ –±—É–º–∞–≥–∏?‚Äù',
                options: [
                    { text: 'üî• –°–∂–µ—á—å —Å–ª–µ–¥—ã', subtext: '–ú–∏–Ω—É—Å —É–ª–∏–∫–∏, —Ä–∏—Å–∫ –Ω–∏–∂–µ', action: 'followup_burn' },
                    { text: 'üí∏ –û—Ç–∫—É–ø–∏—Ç—å—Å—è', subtext: '–î–æ—Ä–æ–≥–æ, –Ω–æ –ø—Ä–æ—â–µ', action: 'followup_bribe' },
                    { text: 'üÉè –ò–≥—Ä–∞—Ç—å –≤ –¥–≤–æ–π–Ω—É—é', subtext: '–ü–æ–¥–ø–æ–ª—å–µ –ø–æ–ª—É—á–∏—Ç –∫—É—Å–æ–∫, —Ä–∏—Å–∫ —Ä–∞—Å—Ç—ë—Ç', action: 'followup_double' }
                ]
            },
            {
                id: 'blackmail',
                weight: 0,
                title: '–®–∞–Ω—Ç–∞–∂',
                icon: 'üß®',
                text: '–¢–æ—Ç —Å–∞–º—ã–π –∂—É—Ä–Ω–∞–ª–∏—Å—Ç –≤–µ—Ä–Ω—É–ª—Å—è: ‚Äú–•–æ—á–µ—à—å —Ç–∏—à–∏–Ω—É ‚Äî –ø–ª–∞—Ç–∏ –µ—â—ë.‚Äù',
                options: [
                    { text: 'üí∏ –ó–∞–ø–ª–∞—Ç–∏—Ç—å', subtext: '–î–µ–Ω—å–≥–∏, –Ω–æ –±–µ–∑ —à—É–º–∞', action: 'blackmail_pay' },
                    { text: 'ü™§ –ü–æ–¥—Å—Ç–∞–≤–∞', subtext: '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —É—Ç–æ–ø–∏—Ç—å –µ–≥–æ', action: 'blackmail_trap' },
                    { text: 'üì§ –°–ª–∏—Ç—å –∫–æ–º–ø—Ä–æ–º–∞—Ç', subtext: '–ü–æ–¥–ø–æ–ª—å–µ –≤ –≤–æ—Å—Ç–æ—Ä–≥–µ, —Å–∏—Å—Ç–µ–º–∞ –≤ —è—Ä–æ—Å—Ç–∏', action: 'blackmail_leak' }
                ]
            },
            {
                id: 'raid',
                weight: 0,
                title: '–û–±—ã—Å–∫',
                icon: 'üî¶',
                text: '–†–∞–Ω–æ —É—Ç—Ä–æ–º –ø—Ä–∏—à–ª–∏ —Å ‚Äú–æ—Å–º–æ—Ç—Ä–æ–º‚Äù. –ö—Ç–æ-—Ç–æ –Ω–∞ —Ç–µ–±—è —Å—Ç—É–∫–∞–Ω—É–ª.',
                options: [
                    { text: 'üßπ –ó–∞–º–µ—Å—Ç–∏ —Å–ª–µ–¥—ã', subtext: '–®–∞–Ω—Å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —É–ª–∏–∫–∏', action: 'raid_hide' },
                    { text: 'ü§ù –°–¥–∞—Ç—å –∫–æ–≥–æ-—Ç–æ', subtext: '–õ–æ—è–ª—å–Ω–æ—Å—Ç—å –≤–≤–µ—Ä—Ö, –ø–æ–¥–ø–æ–ª—å–µ –≤–Ω–∏–∑', action: 'raid_betray' },
                    { text: 'üÉè –î–≤–æ–π–Ω–∞—è –∏–≥—Ä–∞', subtext: '–¢–æ–Ω–∫–æ. –û—á–µ–Ω—å —Ç–æ–Ω–∫–æ.', action: 'raid_double' }
                ]
            },

            
            // === MENTOR ARC (forced chain 2‚Äì3 days) ===
            {
                id: 'mentor_intro',
                weight: 0,
                title: '–ù–∞—Å—Ç–∞–≤–Ω–∏–∫',
                icon: 'üßë‚Äçüè´',
                text: '–ö —Ç–µ–±–µ –ø–æ–¥—Å–∞–∂–∏–≤–∞–µ—Ç—Å—è –∫—É—Ä–∞—Ç–æ—Ä-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫. –£–ª—ã–±–∫–∞ –∫–∞–∫ —É —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞: —Ö–æ–ª–æ–¥–Ω–∞—è –∏ –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è.<br><br>‚Äú–°–ª—É—à–∞–π —Å—é–¥–∞. –¢—É—Ç –≤—Å—ë –ø—Ä–æ—Å—Ç–æ: –¥–µ–ª–∞–π –≤–∏–¥, —á—Ç–æ –≤—Å—ë —Å–ª–æ–∂–Ω–æ. –ò –Ω–µ –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å–æ–≤.‚Äù<br><br>–û–Ω –∫–ª–∞–¥—ë—Ç –Ω–∞ —Å—Ç–æ–ª –±—Ä–µ–ª–æ–∫ –∏ –≥–æ–≤–æ—Ä–∏—Ç: ‚Äú–¢–µ—Å—Ç –Ω–∞ –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å. –ß—Ç–æ –≤—ã–±–µ—Ä–µ—à—å?‚Äù',
                options: [
                    { text:'üòá ‚Äú–Ø –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏‚Äù', subtext:'–õ–æ—è–ª—å–Ω–æ—Å—Ç—å +, —Ä–∏—Å–∫ -', action:'mentor_rule' },
                    { text:'üòà ‚Äú–Ø –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É‚Äù', subtext:'–ì–Ω–µ–≤ +, —Ä–∏—Å–∫ +', action:'mentor_result' },
                    { text:'üÉè ‚Äú–Ø –Ω–∞ –¥–≤–∞ —Ñ—Ä–æ–Ω—Ç–∞‚Äù', subtext:'–ü–æ–¥–ø–æ–ª—å–µ +, —Ä–∏—Å–∫ ++', action:'mentor_double' }
                ]
            },
            {
                id: 'mentor_day2',
                weight: 0,
                title: '–†–∞–∑–±–æ—Ä –ø–æ–ª—ë—Ç–æ–≤',
                icon: 'üßæ',
                text: '–ß–µ—Ä–µ–∑ –ø–∞—Ä—É –¥–Ω–µ–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –ø—Ä–∏–Ω–æ—Å–∏—Ç —Ä–∞—Å–ø–µ—á–∞—Ç–∫—É. –ù–∞ –Ω–µ–π ‚Äî —Ç–≤–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è, –∫–∞–∫ –±—É–¥—Ç–æ —Ç—ã –∂–∏–≤—ë—à—å –≤ —á—É–∂–æ–º —ç–∫—Ä–∞–Ω–µ.<br><br>‚Äú–ö—Ä–∞—Å–∏–≤–æ. –¢–µ–ø–µ—Ä—å –∏—Å–ø—Ä–∞–≤–ª—è–π. –ò–ª–∏ –¥–µ–ª–∞–π –≤–∏–¥, —á—Ç–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ—à—å.‚Äù',
                options: [
                    { text:'üßπ ‚Äú–ò—Å–ø—Ä–∞–≤–∏—Ç—å‚Äù', subtext:'–†–∏—Å–∫ -, –¥–µ–Ω—å–≥–∏ -', action:'mentor_fix' },
                    { text:'ü™§ ‚Äú–°–≤–∞–ª–∏—Ç—å –Ω–∞ —Å—Ç–∞–∂—ë—Ä–∞‚Äù', subtext:'–õ–æ—è–ª—å–Ω–æ—Å—Ç—å +, –ø–æ–¥–ø–æ–ª—å–µ -', action:'mentor_blame' },
                    { text:'üì§ ‚Äú–ü–æ–¥–∫–∏–Ω—É—Ç—å —Å–ª–∏–≤‚Äù', subtext:'–ü–æ–¥–ø–æ–ª—å–µ ++, —Ä–∏—Å–∫ +', action:'mentor_leak' }
                ]
            },
            {
                id: 'mentor_day3',
                weight: 0,
                title: '–ü–æ–¥–∞—Ä–æ–∫',
                icon: 'üéÅ',
                text: '–ï—â—ë —á–µ—Ä–µ–∑ –ø–∞—Ä—É –¥–Ω–µ–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –æ—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–∞ —Å—Ç–æ–ª–µ –∫–æ–Ω–≤–µ—Ä—Ç: ‚Äú–≠—Ç–æ —Ç–µ–±–µ. –ó–∞ —Ç–æ, —á—Ç–æ –ø–æ–∫–∞ –Ω–µ —Å–¥–æ—Ö.‚Äù<br><br>–í–Ω—É—Ç—Ä–∏ –ª–∏–±–æ –ø–æ–º–æ—â—å, –ª–∏–±–æ –ø–æ–¥—Å—Ç–∞–≤–∞. –¢—É—Ç –∫–∞–∫ –ø–æ–≤–µ–∑—ë—Ç.',
                options: [
                    { text:'üì¶ –û—Ç–∫—Ä—ã—Ç—å', subtext:'–®–∞–Ω—Å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞/—É–ª–∏–∫–∏', action:'mentor_open' },
                    { text:'üî• –°–∂–µ—á—å', subtext:'–†–∏—Å–∫ -, –Ω–æ –±–µ–∑ –Ω–∏—à—Ç—è–∫–æ–≤', action:'mentor_burn' },
                    { text:'üÉè –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ —Ä—ã—á–∞–≥', subtext:'–î–≤–æ–π–Ω–∞—è –∏–≥—Ä–∞, —Ä–∏—Å–∫ +', action:'mentor_leverage' }
                ]
            },

// === ESCAPE ARC (forced) ===
            {
                id: 'escape_prepare',
                weight: 0,
                title: '–°–±–æ—Ä—ã',
                icon: 'üß≥',
                text: '–û–∫–µ–π. –¢—ã —Ä–µ–∞–ª—å–Ω–æ —Ä–µ—à–∏–ª —Å–≤–∞–ª–∏—Ç—å. –í –≥–æ–ª–æ–≤–µ –ø–ª–∞–Ω, –Ω–∞ –¥—É—à–µ –ø–∏–∑–¥–µ—Ü. –ß—Ç–æ –ø–µ—Ä–≤—ã–º –¥–µ–ª–æ–º?',
                options: [
                    { text: 'üí∏ –ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç—ã', subtext: '–î–æ—Ä–æ–≥–æ, –Ω–æ —Å–ø–æ–∫–æ–π–Ω–æ', action: 'esc_ticket' },
                    { text: 'ü™™ –ü–æ–¥–¥–µ–ª–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã', subtext: '–†–∏—Å–∫ –≤—ã—à–µ, –Ω–æ –¥–µ—à–µ–≤–ª–µ', action: 'esc_forge' },
                    { text: 'üì§ –ü–µ—Ä–µ–¥ —É—Ö–æ–¥–æ–º —Å–ª–∏—Ç—å –ø–∞–ø–∫—É', subtext: '–ü–æ–¥–ø–æ–ª—å–µ –ø–æ–º–æ–∂–µ—Ç, –Ω–æ —Ç–µ–±—è –±—É–¥—É—Ç –∏—Å–∫–∞—Ç—å', action: 'esc_leak' }
                ]
            },
            {
                id: 'escape_border',
                weight: 0,
                title: '–ì—Ä–∞–Ω–∏—Ü–∞',
                icon: 'üõÇ',
                text: '–¢—ã –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ. –û—á–µ—Ä–µ–¥—å, –ª–∏—Ü–∞, –∫–∞–º–µ—Ä—ã. –û–¥–∏–Ω –Ω–µ—É–¥–∞—á–Ω—ã–π –≤–∑–≥–ª—è–¥ ‚Äî –∏ —Ç—ã –≤ —Å–ø–∏—Å–∫–∞—Ö. –ö–∞–∫ –ø—Ä–æ—Ö–æ–¥–∏—à—å?',
                options: [
                    { text: 'üßæ ‚Äú–ü–æ—Ä–µ—à–∞—Ç—å‚Äù', subtext: '–ú–∏–Ω—É—Å –¥–µ–Ω—å–≥–∏, —à–∞–Ω—Å –≤—ã—à–µ', action: 'esc_bribe' },
                    { text: 'üèÉ –ß–µ—Ä–µ–∑ –ª–µ—Å', subtext: '–ë–æ–ª—å–Ω–æ, –≥—Ä—è–∑–Ω–æ, –Ω–æ –±–µ–∑ —à—Ç–∞–º–ø–∞', action: 'esc_forest' },
                    { text: 'üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å ‚Äú—Å–≤–æ–∏–º‚Äù', subtext: '–ï—Å–ª–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç—å –≤—ã—Å–æ–∫–∞—è ‚Äî –ø—Ä–æ–∫–∞—Ç–∏—Ç', action: 'esc_call' },
                    { text: 'üíæ –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–ª–µ—à–∫—É', subtext: '–ï—Å–ª–∏ –µ—Å—Ç—å —á—Ç–æ ‚Äú–ø–æ–∫–∞–∑–∞—Ç—å‚Äù‚Ä¶', action: 'esc_flash', requiresArtifact: 'flash' },
                    { text: 'üéôÔ∏è –í–∫–ª—é—á–∏—Ç—å –∑–∞–ø–∏—Å—å', subtext: '–ü—É–≥–∞—é—â–µ —É–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ', action: 'esc_audio', requiresArtifact: 'audio' }
                ]
            },
            {
                id: 'escape_middleman',
                weight: 0,
                title: '–ü–æ—Å—Ä–µ–¥–Ω–∏–∫',
                icon: 'üßî‚Äç‚ôÇÔ∏è',
                text: '–¢–µ–±—è –≤–µ–¥—É—Ç –∫ ‚Äú–ø—Ä–æ–≤–æ–¥–Ω–∏–∫—É‚Äù. –õ–∏—Ü–æ –º—É—Ç–Ω–æ–µ, —É–ª—ã–±–∫–∞ –ª–∏–ø–∫–∞—è. ‚Äú–î–µ–Ω—å–≥–∏ –≤–ø–µ—Ä—ë–¥‚Äù. –ü–∞—Ö–Ω–µ—Ç –Ω–∞—ë–±–æ–º.',
                options: [
                    { text: 'üí∏ –ó–∞–ø–ª–∞—Ç–∏—Ç—å', subtext: '–î–æ—Ä–æ–≥–æ, –Ω–æ –±—ã—Å—Ç—Ä–æ', action: 'esc_pay_mid' },
                    { text: 'üÉè –ù–∞ –ø–æ–Ω—Ç', subtext: '–ü—É–≥–Ω—É—Ç—å –ø–∞–ø–∫–∞–º–∏/–∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞–º–∏', action: 'esc_bluff_mid' },
                    { text: 'üï≥Ô∏è –ß–µ—Ä–µ–∑ –ø–æ–¥–ø–æ–ª—å–µ', subtext: '–ï—Å–ª–∏ –ø–æ–¥–ø–æ–ª—å–µ —Å–∏–ª—å–Ω–æ–µ ‚Äî –ø–æ–º–æ–≥—É—Ç', action: 'esc_res_mid' }
                ]
            },
            {
                id: 'escape_twist',
                weight: 0,
                title: '–°—Ä—ã–≤',
                icon: 'üö®',
                text: '–ù–æ—á—å—é –∫—Ç–æ-—Ç–æ –ª–æ–º–∏—Ç—Å—è –≤ –¥–≤–µ—Ä—å. –¢–µ–ª–µ—Ñ–æ–Ω –º–æ–ª—á–∏—Ç. –°–∏—Ç—É–∞—Ü–∏—è –Ω–∞ –≥—Ä–∞–Ω–∏ –ø–∏–∑–¥–µ—Ü–∞. –î–µ–π—Å—Ç–≤—É–µ—à—å?',
                options: [
                    { text: 'üîá –ü–µ—Ä–µ–∂–¥–∞—Ç—å', subtext: '–ï—Å–ª–∏ —Ä–∏—Å–∫ –Ω–∏–∑–∫–∏–π ‚Äî –ø—Ä–æ–∫–∞—Ç–∏—Ç', action: 'esc_wait' },
                    { text: 'üèÉ –†–≤–∞–Ω—É—Ç—å', subtext: '–®–∞–Ω—Å, —á—Ç–æ –≤—ã—Å–∫–æ—á–∏—à—å. –®–∞–Ω—Å, —á—Ç–æ –Ω–∞–∫—Ä–æ—é—Ç.', action: 'esc_run' },
                    { text: 'üì§ –°–ª–∏—Ç—å –≤—Å—ë', subtext: '–°–∂–µ—á—å –º–æ—Å—Ç—ã –∏ –ø–æ–¥–Ω—è—Ç—å —à—É–º', action: 'esc_full_leak' }
                ]
            },
            {
                id: 'escape_final',
                weight: 0,
                title: '–§–∏–Ω–∞–ª—å–Ω—ã–π —Ä—ã–≤–æ–∫',
                icon: 'üõ£Ô∏è',
                text: '–ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥. –û—à–∏–±–∫–∞ ‚Äî –∏ –≤—Å—ë. –ö–∞–∫ –≤—ã—Ö–æ–¥–∏—à—å –∏–∑ –∏–≥—Ä—ã –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å?',
                options: [
                    { text: 'üöê –ö–∞–Ω–∞–ª –ø–æ–¥–ø–æ–ª—å—è', subtext: '–ù—É–∂–Ω–æ –¥–æ–≤–µ—Ä–∏–µ –∫ –ø–æ–¥–ø–æ–ª—å—é', action: 'esc_resistance' },
                    { text: 'üßæ –¢–∏—Ö–æ –∏ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ', subtext: '–ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∏—Å–∫–∞ –∏ —Ç–µ–ø–ª–∞', action: 'esc_official' },
                    { text: 'üí• –ù–∞ —É–¥–∞—á—É', subtext: '–ê–¥—Ä–µ–Ω–∞–ª–∏–Ω –∏ —Ö–∞–æ—Å', action: 'esc_panic' }
                ]
            }
        ];


        function maybeTriggerEncounter() {
            if (uiState.modalOpen || gameState.gameEnded) return;

            ensureChains();

            // 1) –°–Ω–∞—á–∞–ª–∞ ‚Äî —Ü–µ–ø–æ—á–∫–∏ (–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤—Å—Ç—Ä–µ—á–∏)
            const forcedId = popScheduledEncounterForToday();
            let pick = null;

            if (forcedId) {
                pick = encounters.find(e => e.id === forcedId) || null;
            }

            const now = Date.now();

            // 2) –ï—Å–ª–∏ —Ü–µ–ø–æ—á–∫–∏ –Ω–µ—Ç ‚Äî –æ–±—ã—á–Ω—ã–π —Ä–∞–Ω–¥–æ–º (—Å –∫—É–ª–¥–∞—É–Ω–æ–º)
            if (!pick) {
                if (now - (uiState.lastEventTs || 0) < 90000) return; // –∫—É–ª–¥–∞—É–Ω 90—Å
                if (Math.random() > 0.0018) return; // —Ä–µ–∂–µ: —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∞–ª–∏–≤–∞–ª–æ
                const pool = encounters.filter(e => {
                    if ((e.weight || 0) <= 0) return false; // —Ü–µ–ø–æ—á–∫–∏ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ —Ä–∞–Ω–¥–æ–º
                    if (e.minDay && (gameState.day||1) < e.minDay) return false;
                    if (e.maxDay && (gameState.day||1) > e.maxDay) return false;
                    if (e.requiresDocs && !e.requiresDocs.every(id => hasDoc(id))) return false;
                    if (e.blockedIf && e.blockedIf.some(id => hasDoc(id))) return false;
                    return (e.cond ? e.cond() : true);
                });
                if (!pool.length) return;
                const sum = pool.reduce((a,b)=>a+(b.weight||1),0);
                let r = Math.random() * sum;
                pick = pool[0];
                for (const e of pool) { r -= (e.weight||1); if (r <= 0) { pick = e; break; } }
                uiState.lastEventTs = now;
            }

            if (!pick) return;

            // UI
            uiState.modalOpen = true;
            document.getElementById('choiceIcon').textContent = pick.icon;
            document.getElementById('choiceTitle').textContent = pick.title;
            document.getElementById('choiceText').innerHTML = pick.text + `<br><br><small style="color:var(--telegram-hint)">–ê–∫—Ç–∏–≤–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã:<br>${describeBuffs()}</small>`;
            const buttonsDiv = document.getElementById('choiceButtons');
            buttonsDiv.innerHTML = '';

            const opts = pick.options || [];
            opts.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = `choice-btn ${i === 0 ? 'primary' : 'secondary'}`;
                btn.type = 'button';
                btn.innerHTML = `<strong>${opt.text}</strong><div class="choice-consequence">${opt.subtext || ''}</div>`;
                btn.addEventListener('click', (ev) => { ev.preventDefault(); ev.stopPropagation(); handleEncounter(pick, opt); }, { passive:false });
                btn.addEventListener('touchend', (ev) => { ev.preventDefault(); ev.stopPropagation(); }, { passive:false });
                buttonsDiv.appendChild(btn);
            });

            document.getElementById('choiceModal').classList.add('show');
            safeHaptic('medium');
        }

        function handleEncounter(enc, opt) {
            document.getElementById('choiceModal').classList.remove('show');
            uiState.modalOpen = false;

            const now = Date.now();

            switch(opt.action) {
                // === BASE ENCOUNTERS ===
                case 'ddos_pay':
                    gameState.money = Math.max(0, gameState.money * 0.85);
                    addBuff({ name:'üõ°Ô∏è Anti-DDoS', expiresAt: now + 45_000, perSecondMul: 1.06 });
                    gameState.loyalty = Math.min(100, (gameState.loyalty ?? 50) + 2);
                    showNotification('üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞');
                    break;

                case 'ddos_tank':
                    addBuff({ name:'üå™Ô∏è –õ–∞–≥–∏', expiresAt: now + 35_000, perSecondMul: 0.75 });
                    gameState.tension = Math.min(100, gameState.tension + 3);
                    showNotification('üå™Ô∏è –°–∏—Å—Ç–µ–º—ã –ª–∞–≥–∞—é—Ç‚Ä¶');
                    break;

                case 'ddos_deal':
                    // —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω—ã–π ‚Äú–¥–æ–≥–æ–≤–æ—Ä–Ω—è–∫‚Äù: –∏–Ω–æ–≥–¥–∞ –¥–∞—Å—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç/—É–ª–∏–∫—É, –Ω–æ –ø–æ–¥–Ω–∏–º–µ—Ç –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–µ
                    if (Math.random() < 0.45) {
                        maybeFindRandomArtifact(0.25);
                        if (Math.random() < 0.35) addRandomDocument();
                        showNotification('ü§ù ‚Äú–î–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å‚Äù‚Ä¶ –ø–æ–∫–∞ —á—Ç–æ');
                        gameState.tension = Math.max(0, gameState.tension - 4);
                    } else {
                        showNotification('ü§ù –ù–∏—Ö—Ä–µ–Ω–∞ –Ω–µ –ø–æ–º–æ–≥–ª–æ');
                        gameState.tension = Math.min(100, gameState.tension + 6);
                        addSuspicion(8);
                    }
                    // —Ö–≤–æ—Å—Ç: –º–æ–≥—É—Ç –≤–µ—Ä–Ω—É—Ç—å—Å—è
                    scheduleEncounter('ddos', 2, 3);
                    break;

                case 'insider_take':
                    addRandomDocument();
                    maybeFindRandomArtifact(0.18);
                    addResistance(10);
                    addSuspicion(10);
                    changeLoyalty(-4);
                    showNotification('üïµÔ∏è –ú–∞—Ç–µ—Ä–∏–∞–ª—ã —É —Ç–µ–±—è');
                    scheduleEncounter('insider_followup', 2, 3);
                    break;

                case 'insider_report':
                    changeLoyalty(+8);
                    changeAnger(+6);
                    addResistance(-6);
                    showNotification('üïµÔ∏è –ò–Ω—Å–∞–π–¥–µ—Ä–∞ —É–≤–µ–ª–∏');
                    break;

                case 'insider_pay':
                    gameState.money = Math.max(0, gameState.money - 600);
                    changeAnger(-4);
                    addSuspicion(4);
                    showNotification('ü§ê ‚Äú–î–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å‚Äù');
                    break;

                case 'journalist_bribe':
                    gameState.money = Math.max(0, gameState.money - 400);
                    changeAnger(-6);
                    addSuspicion(6);
                    showNotification('üé• –í—Ä–µ–º–µ–Ω–Ω–æ –∑–∞—Ç–∫–Ω—É–ª—Å—è');
                    if (Math.random() < 0.65) scheduleEncounter('blackmail', 2, 3);
                    break;

                case 'journalist_threat':
                    changeAnger(+10);
                    changeLoyalty(-5);
                    addSuspicion(10);
                    showNotification('‚ö° –ó–∞–ø—É–≥–∞–ª. –ù–æ —Å–ª–µ–¥—ã –æ—Å—Ç–∞–ª–∏—Å—å');
                    if (Math.random() < 0.5) scheduleEncounter('blackmail', 2, 3);
                    break;

                case 'journalist_truth':
                    addResistance(10);
                    changeAnger(-10);
                    changeLoyalty(-6);
                    maybeFindRandomArtifact(0.12);
                    showNotification('üìú –ù–∞–º—ë–∫ —É—à—ë–ª ‚Äú–∫—É–¥–∞ –Ω–∞–¥–æ‚Äù');
                    break;

                case 'audit_bribe':
                    gameState.money -= 500;
                    gameState.loyalty = Math.min(100, (gameState.loyalty ?? 50) + 6);
                    gameState.tension = Math.max(0, gameState.tension - 2);
                    showNotification('üßæ –ü—Ä–æ–≤–µ—Ä–∫–∞ ‚Äú–¥–æ–≤–æ–ª—å–Ω–∞‚Äù');
                    break;

                case 'audit_law':
                    gameState.loyalty = Math.max(0, (gameState.loyalty ?? 50) - 6);
                    gameState.tension = Math.min(100, gameState.tension + 5);
                    showNotification('üßæ –ü—Ä–∏–¥—Ä–∞–ª–∏—Å—å –∫–æ –≤—Å–µ–º—É');
                    break;

                case 'audit_double':
                    addResistance(8);
                    addSuspicion(14);
                    changeLoyalty(+2);
                    changeAnger(-4);
                    maybeFindRandomArtifact(0.12);
                    showNotification('üÉè –°—ã–≥—Ä–∞–ª –Ω–∞ –¥–≤–∞ —Ñ—Ä–æ–Ω—Ç–∞');
                    if ((gameState.suspicion||0) >= 55 && Math.random() < 0.55) scheduleEncounter('raid', 2, 3);
                    break;

                case 'pr_run':
                    gameState.money -= 800;
                    gameState.tension = Math.max(0, gameState.tension - 12);
                    showNotification('üì£ –ì–Ω–µ–≤ –ø–∞–¥–∞–µ—Ç');
                    break;

                case 'pr_skip':
                    showNotification('ü§∑ –ù—É –∏ –ª–∞–¥–Ω–æ');
                    break;

                case 'ot_go':
                    gameState.health = Math.max(0, gameState.health - 10);
                    addBuff({ name:'‚òï –£–¥–∞—Ä–Ω—ã–π —Ä–µ–∂–∏–º', expiresAt: now + 45_000, perClickMul: 1.15 });
                    gameState.loyalty = Math.min(100, (gameState.loyalty ?? 50) + 2);
                    showNotification('‚òï –ü–æ–≥–Ω–∞–ª–∏!');
                    break;

                case 'ot_no':
                    gameState.loyalty = Math.max(0, (gameState.loyalty ?? 50) - 5);
                    showNotification('üòí –ù–∞—á–∞–ª—å—Å—Ç–≤–æ –∑–∞–ø–æ–º–Ω–∏–ª–æ');
                    break;

                case 'vac_take':
                    addBuff({ name:'üèñÔ∏è –û—Ç–¥—ã—Ö', expiresAt: now + 60_000, perSecondMul: 0.85 });
                    gameState.health = Math.min(100, gameState.health + 15);
                    gameState.tension = Math.max(0, gameState.tension - 8);
                    showNotification('üèñÔ∏è –ß—É—Ç—å –ø–æ–ª–µ–≥—á–µ');
                    break;

                case 'vac_work':
                    gameState.loyalty = Math.min(100, (gameState.loyalty ?? 50) + 2);
                    showNotification('ü´° –†–∞–±–æ—Ç–∞–µ–º');
                    break;

                // === CHAIN ENCOUNTERS ===
                case 'followup_burn':
                    ensureDocs();
                    (gameState.documents||[]).filter(d=>d.status==='kept').slice(0,2).forEach(d=>burnDoc(d.id));
                    addSuspicion(-10);
                    changeAnger(+4);
                    showNotification('üî• –°–ª–µ–¥—ã –ø–æ–¥—á–∏—â–µ–Ω—ã');
                    break;

                case 'followup_bribe':
                    gameState.money = Math.max(0, gameState.money - 700);
                    addSuspicion(-12);
                    changeLoyalty(+4);
                    showNotification('üí∏ –ë–µ–∑–æ–ø–∞—Å–Ω–∏–∫–∏ ‚Äú–ø–æ–Ω—è–ª–∏‚Äù');
                    break;

                case 'followup_double':
                    addResistance(12);
                    addSuspicion(18);
                    changeLoyalty(-2);
                    maybeFindRandomArtifact(0.20);
                    showNotification('üÉè –û—Ç–º–∞–∑–∞–ª—Å—è ‚Äî –∏ –ø–µ—Ä–µ–¥–∞–ª –∫—É—Å–æ–∫ –ø–æ–¥–ø–æ–ª—å—é');
                    if ((gameState.suspicion||0) >= 70) scheduleEncounter('raid', 2, 3);
                    break;

                case 'blackmail_pay':
                    gameState.money = Math.max(0, gameState.money - 650);
                    addSuspicion(-6);
                    showNotification('üí∏ –ó–∞–ø–ª–∞—Ç–∏–ª. –°—Ç—ã–¥–Ω–æ.');
                    break;

                case 'blackmail_trap':
                    if (Math.random() < 0.45) {
                        changeLoyalty(+6);
                        addSuspicion(-8);
                        showNotification('ü™§ –ü–æ–¥—Å—Ç–∞–≤–∞ —Å—Ä–∞–±–æ—Ç–∞–ª–∞');
                        maybeFindRandomArtifact(0.15);
                    } else {
                        addSuspicion(14);
                        changeAnger(+8);
                        showNotification('ü™§ –ù–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ. –¢–µ–ø–µ—Ä—å —Ö—É–∂–µ');
                        scheduleEncounter('raid', 2, 3);
                    }
                    break;

                case 'blackmail_leak':
                    addResistance(16);
                    addSuspicion(16);
                    changeAnger(-8);
                    changeLoyalty(-6);
                    addRandomDocument();
                    maybeFindRandomArtifact(0.18);
                    showNotification('üì§ –°–ª–∏–ª –∏—Å—Ç–æ—Ä–∏—é –Ω–∞—Ä—É–∂—É');
                    scheduleEncounter('raid', 2, 3);
                    break;

                case 'raid_hide':
                    if (Math.random() < 0.5) {
                        addSuspicion(-8);
                        showNotification('üßπ –ó–∞–º—ë–ª —Å–ª–µ–¥—ã');
                    } else {
                        ensureDocs();
                        const keptR = (gameState.documents||[]).filter(d=>d.status==='kept');
                        if (keptR.length) burnDoc(keptR[Math.floor(Math.random()*keptR.length)].id);
                        addSuspicion(10);
                        showNotification('üî¶ –ù–∞—à–ª–∏ –∫–æ–µ-—á—Ç–æ‚Ä¶');
                    }
                    break;

                case 'raid_betray':
                    changeLoyalty(+10);
                    addResistance(-10);
                    addSuspicion(-6);
                    showNotification('ü§ù –°–¥–∞–ª ‚Äú—É–¥–æ–±–Ω–æ–≥–æ‚Äù —á–µ–ª–æ–≤–µ–∫–∞');
                    break;

                case 'raid_double':
                    addResistance(14);
                    addSuspicion(20);
                    maybeFindRandomArtifact(0.22);
                    showNotification('üÉè –û—á–µ–Ω—å —Ç–æ–Ω–∫–æ. –û—á–µ–Ω—å –æ–ø–∞—Å–Ω–æ.');
                    break;

                // === ESCAPE ARC CASES ===
                case 'esc_ticket':
                    if (gameState.money < 1200) { showNotification('üí∏ –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –±—é–¥–∂–µ—Ç–∞'); break; }
                    gameState.money -= 1200;
                    changeLoyalty(-6);
                    bumpEscapeHeat(-8);
                    addSuspicion(-6);
                    maybeFindRandomArtifact(0.10);
                    showNotification('üß≥ –ë–∏–ª–µ—Ç—ã –∫—É–ø–ª–µ–Ω—ã. –°–µ—Ä–¥—Ü–µ –∫–æ–ª–æ—Ç–∏—Ç—Å—è');
                    scheduleEncounter('escape_border', 2, 3);
                    break;

                case 'esc_forge':
                    if (gameState.money < 450) { showNotification('üí∏ –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –±—é–¥–∂–µ—Ç–∞'); break; }
                    gameState.money -= 450;
                    addSuspicion(10);
                    bumpEscapeHeat(+10);
                    changeLoyalty(-4);
                    maybeFindRandomArtifact(0.18);
                    showNotification('ü™™ –õ–∏–ø–∞ –≥–æ—Ç–æ–≤–∞. –ï—Å–ª–∏ –Ω–µ —Å–ø–∞–ª—è—Ç‚Ä¶');
                    scheduleEncounter('escape_border', 2, 3);
                    break;

                case 'esc_leak':
                    ensureDocs();
                    const keptE = (gameState.documents||[]).filter(d=>d.status==='kept');
                    if (keptE.length) leakDoc(keptE[Math.floor(Math.random()*keptE.length)].id);
                    gameState.escapeLeak = true;
                    addResistance(16);
                    addSuspicion(16);
                    bumpEscapeHeat(+14);
                    changeLoyalty(-8);
                    showNotification('üì§ –°–ª–∏–ª –ø–∞–ø–∫—É. –¢–µ–ø–µ—Ä—å —Ç–µ–±—è —Ä–µ–∞–ª—å–Ω–æ –∏—â—É—Ç');
                    scheduleEncounter('escape_border', 2, 3);
                    break;

                case 'esc_bribe':
                    if (gameState.money < 800) { showNotification('üí∏ –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –±—é–¥–∂–µ—Ç–∞'); break; }
                    gameState.money -= 800;
                    addSuspicion(-8);
                    bumpEscapeHeat(-6);
                    showNotification('üõÇ ‚Äú–í–æ–ø—Ä–æ—Å —Ä–µ—à—ë–Ω‚Äù. –ì–∞–¥–∫–æ, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç');
                    scheduleEncounter('escape_middleman', 2, 3);
                    break;

                case 'esc_forest':
                    gameState.health = Math.max(0, gameState.health - 18);
                    bumpEscapeHeat(+8);
                    addSuspicion(-4);
                    if (!hasArtifact('sim') && Math.random() < 0.35) addArtifact('sim');
                    showNotification('üèÉ –ù–æ–≥–∏ –≤ –≥–æ–≤–Ω–µ, –Ω–æ —Ç—ã –ø—Ä–æ—à—ë–ª');
                    scheduleEncounter('escape_middleman', 2, 3);
                    break;

                case 'esc_call':
                    if ((gameState.loyalty ?? 50) >= 70) {
                        bumpEscapeHeat(-10);
                        addSuspicion(-10);
                        showNotification('üìû ‚Äú–°–≤–æ–∏‚Äù –ø—Ä–æ—Ç–æ–ª–∫–Ω—É–ª–∏. –ü–æ–≤–µ–∑–ª–æ');
                    } else {
                        bumpEscapeHeat(+18);
                        addSuspicion(14);
                        showNotification('üìû –ù–µ–ª–æ–≤–∫–∏–π –∑–≤–æ–Ω–æ–∫. –ö–∞–∂–µ—Ç—Å—è, —Ç—ã —Å–ø–∞–ª–∏–ª—Å—è');
                    }
                    scheduleEncounter('escape_middleman', 2, 3);
                    break;

                case 'esc_resistance':
                    if ((gameState.resistance||0) >= 55) {
                        bumpEscapeHeat(-12);
                        changeAnger(-8);
                        showNotification('üöê –ü–æ–¥–ø–æ–ª—å–µ –≤—ã–≤–µ–∑–ª–æ. –ö–∞–∫ –≤ –∫–∏–Ω–æ, —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–∞—à–Ω–µ–µ');
                        gameState.escapeResult = 'res';
                    } else {
                        bumpEscapeHeat(+12);
                        addSuspicion(10);
                        showNotification('üöê –ö–∞–Ω–∞–ª —Ö–ª–∏–ø–∫–∏–π. –¢—ã –Ω–∞ –≤–æ–ª–æ—Å–∫–µ');
                        gameState.escapeResult = 'bad_res';
                    }
                    finalizeEscapeEnding();
                    break;

                case 'esc_official':
                    if ((gameState.suspicion||0) <= 55 && (gameState.escapeHeat||0) <= 65) {
                        showNotification('üßæ –¢–∏—Ö–æ –ø—Ä–æ—à—ë–ª –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º. –ß—É–¥–æ');
                        gameState.escapeResult = 'clean';
                    } else {
                        showNotification('üßæ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—Ç—è–Ω—É–ª–∞—Å—å. –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤');
                        gameState.escapeResult = 'caught';
                    }
                    finalizeEscapeEnding();
                    break;

                case 'esc_panic':
                    if (Math.random() < 0.5) {
                        showNotification('üí• –¢—ã —Ä–≤–∞–Ω—É–ª –∏ —á—É–¥–æ–º –≤—ã—Å–∫–æ—á–∏–ª');
                        gameState.escapeResult = 'panic_ok';
                        bumpEscapeHeat(+6);
                    } else {
                        showNotification('üí• –í—Å—ë –ø–æ—à–ª–æ –ø–æ –ø–∏–∑–¥–µ. –¢–µ–±—è –Ω–∞–∫—Ä—ã–ª–∏');
                        gameState.escapeResult = 'panic_fail';
                        bumpEscapeHeat(+22);
                        addSuspicion(18);
                    }
                    finalizeEscapeEnding();
                    break;

                case 'esc_flash':
                    // —Ñ–ª–µ—à–∫–∞ –∫–∞–∫ —Ä—ã—á–∞–≥: —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫, –Ω–æ –º–æ–∂–µ—Ç —Ä–∞–∑–æ–∑–ª–∏—Ç—å —Å–∏—Å—Ç–µ–º—É
                    bumpEscapeHeat(-12);
                    addSuspicion(-10);
                    changeAnger(+4);
                    showNotification('üíæ –ü–æ–∫–∞–∑–∞–ª –Ω–∞–º—ë–∫. –ü–æ–≥—Ä–∞–Ω–µ—Ü –ø–æ–±–ª–µ–¥–Ω–µ–ª');
                    scheduleEncounter('escape_middleman', 2, 3);
                    break;

                case 'esc_audio':
                    bumpEscapeHeat(-16);
                    addSuspicion(-12);
                    changeAnger(+6);
                    showNotification('üéôÔ∏è –ó–∞–ø–∏—Å—å —Å—ã–≥—Ä–∞–ª–∞. –¢–µ–±—è –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ –º–æ–ª—á–∞');
                    scheduleEncounter('escape_middleman', 2, 3);
                    break;

                case 'esc_pay_mid':
                    if (gameState.money < 900) { showNotification('üí∏ –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –±—é–¥–∂–µ—Ç–∞'); break; }
                    gameState.money -= 900;
                    bumpEscapeHeat(-6);
                    addSuspicion(6);
                    showNotification('üßî‚Äç‚ôÇÔ∏è –¢—ã –∑–∞–ø–ª–∞—Ç–∏–ª. –ù–∞–¥–µ–µ—à—å—Å—è, —á—Ç–æ –Ω–µ –ª–æ—Ö');
                    scheduleEncounter('escape_twist', 2, 3);
                    break;

                case 'esc_bluff_mid':
                    // –µ—Å–ª–∏ –µ—Å—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç/—É–ª–∏–∫–∞ ‚Äî —à–∞–Ω—Å –≤—ã—à–µ
                    const bluffPower = ((gameState.artifacts||[]).length) + countDocs({realOnly:true});
                    if (Math.random() < Math.min(0.75, 0.25 + bluffPower*0.12)) {
                        bumpEscapeHeat(-10);
                        addSuspicion(-6);
                        maybeFindRandomArtifact(0.10);
                        showNotification('üÉè –û–Ω —Å–¥—É–ª—Å—è. –¢—ã –ø–æ–±–µ–¥–∏–ª —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–º');
                        scheduleEncounter('escape_twist', 2, 3);
                    } else {
                        bumpEscapeHeat(+12);
                        addSuspicion(12);
                        showNotification('üÉè –ù–µ –ø—Ä–æ–∫–∞—Ç–∏–ª–æ. –û–Ω –ø–æ–Ω—è–ª, —á—Ç–æ —Ç—ã —É—è–∑–≤–∏–º');
                        scheduleEncounter('raid', 2, 3);
                        scheduleEncounter('escape_twist', 2, 3);
                    }
                    break;

                case 'esc_res_mid':
                    if ((gameState.resistance||0) >= 60) {
                        bumpEscapeHeat(-10);
                        addSuspicion(-4);
                        showNotification('üï≥Ô∏è –ü–æ–¥–ø–æ–ª—å–µ –≤–∑—è–ª–æ –Ω–∞ —Å–µ–±—è. –° —Ç–µ–±—è —Ç–æ–ª—å–∫–æ –º–æ–ª—á–∞—Ç—å');
                    } else {
                        bumpEscapeHeat(+8);
                        addSuspicion(10);
                        showNotification('üï≥Ô∏è –ü–æ–¥–ø–æ–ª—å–µ –Ω–µ —Ç—è–Ω–µ—Ç. –¢—ã —Å–Ω–æ–≤–∞ –æ–¥–∏–Ω');
                    }
                    scheduleEncounter('escape_twist', 2, 3);
                    break;

                case 'esc_wait':
                    if ((gameState.escapeHeat||0) <= 55 && (gameState.suspicion||0) <= 55) {
                        bumpEscapeHeat(-8);
                        addSuspicion(-6);
                        showNotification('üîá –ü–µ—Ä–µ—Å–∏–¥–µ–ª. –°–µ—Ä–¥—Ü–µ —á—É—Ç—å –Ω–µ –ª–æ–ø–Ω—É–ª–æ');
                    } else {
                        bumpEscapeHeat(+10);
                        addSuspicion(10);
                        showNotification('üîá –ü–µ—Ä–µ—Å–∏–¥–µ–ª‚Ä¶ –Ω–æ, –∫–∞–∂–µ—Ç—Å—è, —Ç–µ–±—è –≤—ã—á–∏—Å–ª–∏–ª–∏');
                    }
                    scheduleEncounter('escape_final', 2, 3);
                    break;

                case 'esc_run':
                    if (Math.random() < 0.52) {
                        gameState.health = Math.max(0, gameState.health - 10);
                        bumpEscapeHeat(+6);
                        addSuspicion(-4);
                        showNotification('üèÉ –¢—ã –≤—ã—Å–∫–æ—á–∏–ª. –ü–∏–∑–¥–µ—Ü, –Ω–æ –∂–∏–≤');
                        if (!hasArtifact('screenshot') && Math.random()<0.30) addArtifact('screenshot');
                        scheduleEncounter('escape_final', 2, 3);
                    } else {
                        bumpEscapeHeat(+20);
                        addSuspicion(18);
                        showNotification('üèÉ –ù–µ –ø–æ–≤–µ–∑–ª–æ. –ü–æ—á—Ç–∏ –Ω–∞–∫—Ä—ã–ª–∏');
                        scheduleEncounter('escape_final', 2, 3);
                    }
                    break;

                case 'esc_full_leak':
                    // —É—Å–∏–ª–∏–≤–∞–µ—Ç –ø–æ–¥–ø–æ–ª—å–µ, –Ω–æ —Ä–∞–∑–æ–≥—Ä–µ–≤–∞–µ—Ç –æ—Ö–æ—Ç—É
                    ensureDocs();
                    (gameState.documents||[]).filter(d=>d.status==='kept' && d.real).slice(0,2).forEach(d=>leakDoc(d.id));
                    addResistance(20);
                    bumpEscapeHeat(+18);
                    addSuspicion(18);
                    changeLoyalty(-10);
                    showNotification('üì§ –°–ª–∏–ª –ø–æ-–∫—Ä—É–ø–Ω–æ–º—É. –¢–µ–ø–µ—Ä—å —Ç—ã —Ü–µ–ª—å');
                    scheduleEncounter('escape_final', 2, 3);
                    break;


                // === MENTOR ARC ===
                case 'mentor_rule':
                    changeLoyalty(+6);
                    addSuspicion(-4);
                    showNotification('üßë‚Äçüè´ ‚Äú–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–∞–ª—å—á–∏–∫. –ü–æ–∫–∞.‚Äù');
                    scheduleEncounter('mentor_day2', 2, 3);
                    break;

                case 'mentor_result':
                    changeAnger(+6);
                    addSuspicion(+6);
                    showNotification('üßë‚Äçüè´ ‚Äú–õ—é–±–ª—é —Ç–∞–∫–∏—Ö. –ù–æ –æ–Ω–∏ –±—ã—Å—Ç—Ä–æ –≥–æ—Ä—è—Ç.‚Äù');
                    scheduleEncounter('mentor_day2', 2, 3);
                    break;

                case 'mentor_double':
                    addResistance(+10);
                    addSuspicion(+10);
                    changeLoyalty(-4);
                    showNotification('üßë‚Äçüè´ ‚Äú–û, –∫–ª–æ—É–Ω. –°–∞–º–æ–µ –æ–ø–∞—Å–Ω–æ–µ.‚Äù');
                    scheduleEncounter('mentor_day2', 2, 3);
                    break;

                case 'mentor_fix':
                    if (gameState.money < 300) { showNotification('üí∏ –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –±—é–¥–∂–µ—Ç–∞'); break; }
                    gameState.money -= 300;
                    addSuspicion(-8);
                    changeAnger(-3);
                    showNotification('üßæ ‚Äú–ù–æ—Ä–º. –ù–∞ —Å–µ–≥–æ–¥–Ω—è –∂–∏–≤—ë—à—å.‚Äù');
                    scheduleEncounter('mentor_day3', 2, 3);
                    break;

                case 'mentor_blame':
                    changeLoyalty(+5);
                    addResistance(-6);
                    addSuspicion(+4);
                    showNotification('ü™§ ‚Äú–°—Ç–∞–∂—ë—Ä ‚Äî –≤–µ—á–Ω—ã–π –≥—Ä–æ–º–æ–æ—Ç–≤–æ–¥.‚Äù');
                    scheduleEncounter('mentor_day3', 2, 3);
                    break;

                case 'mentor_leak':
                    addResistance(+14);
                    addSuspicion(+10);
                    changeLoyalty(-6);
                    try { addRandomDocument('mentor'); } catch(e){}
                    showNotification('üì§ ‚Äú–°–ª–∏–ª –∞–∫–∫—É—Ä–∞—Ç–Ω–æ‚Ä¶ –ø–æ—á—Ç–∏.‚Äù');
                    scheduleEncounter('mentor_day3', 2, 3);
                    break;

                case 'mentor_open':
                    // —Ä–∞–Ω–¥–æ–º: –ª–∏–±–æ –ø–æ–¥–∞—Ä–æ–∫, –ª–∏–±–æ –ø–æ–¥—Å—Ç–∞–≤–∞
                    if (Math.random() < 0.55) {
                        maybeFindRandomArtifact(0.45);
                        if (Math.random() < 0.35) addRandomDocument('gift');
                        addSuspicion(-4);
                        showNotification('üéÅ –ü–æ–≤–µ–∑–ª–æ. –ü–æ–∫–∞.');
                    } else {
                        addSuspicion(+12);
                        changeAnger(+6);
                        showNotification('üéÅ –ü–æ–¥—Å—Ç–∞–≤–∞. –ü—Ä–∏–≤—ã–∫–∞–π, –±–ª—è–¥—å.');
                        scheduleEncounter('raid', 2, 3);
                    }
                    break;

                case 'mentor_burn':
                    addSuspicion(-10);
                    changeAnger(+2);
                    showNotification('üî• –°–∂—ë–≥. –ò –ø—Ä–∞–≤–∏–ª—å–Ω–æ.');
                    break;

                case 'mentor_leverage':
                    addSuspicion(+12);
                    addResistance(+6);
                    changeLoyalty(+2);
                    showNotification('üÉè –¢–µ–ø–µ—Ä—å —É —Ç–µ–±—è —Ä—ã—á–∞–≥. –ò –ø—Ä–æ–±–ª–µ–º–∞.');
                    break;


            }

            if (gameState.health <= 0) {
                setTimeout(() => triggerEnding('dead'), 600);
                return;
            }

            if ((gameState.loyalty ?? 50) <= 0) {
                setTimeout(() => triggerEnding('fired'), 600);
                return;
            }

            updateDisplay(true);
            manualSave(true);
        }

        // === DAY PROGRESSION ===
        function recalcDay() {
            // –º–µ–¥–ª–µ–Ω–Ω–æ —Ä–∞—Å—Ç—ë—Ç —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º, —á—Ç–æ–±—ã –±—ã–ª–æ –æ—â—É—â–µ–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏
            const prev = (gameState.day || 1);
            const newDay = Math.max(1, 1 + Math.floor(gameState.totalBlocks / 7000));
            if (newDay > prev) {
                gameState.day = newDay;
                showStoryOverlay('üìÖ', `–î–ï–ù–¨ ${newDay}`, '–ù–æ–≤—ã–π –¥–µ–Ω—å —Å–ª—É–∂–±—ã. –ù–æ–≤—ã–µ –ø—Ä–∏–∫–∞–∑—ã. –ù–æ–≤—ã–µ –≤—Ä–∞–≥–∏.<br><br><small style="color:var(--telegram-hint)">–ó–∞–π–¥–∏ –≤ –º–µ–Ω—é ‚ò∞ —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–ª–∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.</small>');
                if (newDay >= 5 && (gameState.tension || 0) < 30) unlockAchievement('calm');

                // —Ü–µ–ø–æ—á–∫–∏ –≤—Å—Ç—Ä–µ—á: –æ—Ç–º–µ—á–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –¥–Ω—è (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫–∏ —Å—Ä–∞–∑—É, —Ç–æ–ª—å–∫–æ –ø–ª–∞–Ω–∏—Ä—É–µ–º)
                ensureChains();
                // –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º –∑–¥–µ—Å—å –∫—Ä–æ–º–µ –º–∏–≥—Ä–∞—Ü–∏–∏ ‚Äî —Å–∞–º–∏ —Ü–µ–ø–æ—á–∫–∏ —Å—Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ maybeTriggerEncounter()

                safeHaptic('medium');
                setTimeout(() => { 
                    maybeTriggerStory(); 
                    maybeTriggerEncounter(); 
                }, 250);
            }
        }

        // === STORY MILESTONES (20‚Äì30 –¥–Ω–µ–π –∫–∞–º–ø–∞–Ω–∏–∏) === (20‚Äì30 –¥–Ω–µ–π –∫–∞–º–ø–∞–Ω–∏–∏) ===
        const storyMilestones = [
            { id:'s_day3',  day:3,  icon:'üìú', title:'–î–∏—Ä–µ–∫—Ç–∏–≤–∞', text:'–ü—Ä–∏—à–ª–∞ –Ω–æ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞: ‚Äú–∂—ë—Å—Ç—á–µ, –±—ã—Å—Ç—Ä–µ–µ, –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π‚Äù. –ö–∞–∫ –∏–≥—Ä–∞–µ—à—å?', choices:[
                { text:'üßæ –ü–æ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—É', effect:()=>{ changeLoyalty(+6); changeAnger(+3); } },
                { text:'ü™ì –ü–æ—Ö–µ—Ä –Ω–∞ –ø—Ä–∞–≤–∏–ª–∞', effect:()=>{ changeAnger(+10); addSuspicion(+6); } },
                { text:'üï≥Ô∏è –í—Ç–∏—Ö–∞—Ä—è —Å–∞–±–æ—Ç–∏—Ä–æ–≤–∞—Ç—å', effect:()=>{ addResistance(+8); changeLoyalty(-6); addSuspicion(+4); } }
            ]},
            { id:'s_day7',  day:7,  icon:'ü§ù', title:'–°–≤—è–∑–Ω–æ–π', text:'–ö —Ç–µ–±–µ –ø–æ–¥—Ö–æ–¥–∏—Ç ‚Äú—Å–≤–æ–π‚Äù –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∫–∞–Ω–∞–ª —Å–≤—è–∑–∏ —Å –ø–æ–¥–ø–æ–ª—å–µ–º. –≠—Ç–æ —Ä–∏—Å–∫, –Ω–æ –∏ —Ä—ã—á–∞–≥.', choices:[
                { text:'‚úÖ –°–æ–≥–ª–∞—Å–∏—Ç—å—Å—è', effect:()=>{ addResistance(+10); addSuspicion(+8); changeLoyalty(-6); addRandomDocument('svyaz'); } },
                { text:'üö´ –û—Ç–∫–∞–∑–∞—Ç—å', effect:()=>{ changeLoyalty(+4); } },
                { text:'üé£ –°–¥–∞—Ç—å —Å–≤—è–∑–Ω–æ–≥–æ', effect:()=>{ changeLoyalty(+8); changeAnger(+6); } }
            ]},
            { id:'s_day12', day:12, icon:'üì∫', title:'–≠—Ñ–∏—Ä', text:'–¢–µ–±—è –∑–æ–≤—É—Ç –Ω–∞ —ç—Ñ–∏—Ä: ‚Äú–æ–±—ä—è—Å–Ω–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏‚Äù. –ü—É–±–ª–∏—á–Ω–æ—Å—Ç—å ‚Äî —ç—Ç–æ –ø–∏–∑–¥–µ—Ü.', choices:[
                { text:'üôÇ –£–ª—ã–±–∞—Ç—å—Å—è –∏ –≤—Ä–∞—Ç—å', effect:()=>{ changeLoyalty(+5); changeAnger(+8); } },
                { text:'üò° –ù–∞—Ö–∞–º–∏—Ç—å –≤ –ø—Ä—è–º–æ–º', effect:()=>{ changeAnger(+14); addSuspicion(+6); } },
                { text:'üß® –°–ª–∏—Ç—å –Ω–∞–º—ë–∫ –Ω–∞ –ø—Ä–∞–≤–¥—É', effect:()=>{ addResistance(+10); changeAnger(-8); changeLoyalty(-7); addRandomDocument('efir'); } }
            ]},
            { id:'s_day18', day:18, icon:'üßæ', title:'–ö–æ–º–ø—Ä–æ–º–∞—Ç', text:'–£ —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –∫–∞–∫ —Ä—ã—á–∞–≥ (–¥–ª—è —Å–∏—Å—Ç–µ–º—ã) –∏–ª–∏ –∫–∞–∫ –æ—Ä—É–∂–∏–µ (–¥–ª—è –ø–æ–¥–ø–æ–ª—å—è)?', choices:[
                { text:'üëî –î–µ—Ä–∂–∞—Ç—å –ø—Ä–∏ —Å–µ–±–µ', effect:()=>{ changeLoyalty(+4); addSuspicion(+4); } },
                { text:'üì§ –ù–∞—á–∞—Ç—å —Å–ª–∏–≤–∞—Ç—å', effect:()=>{ ensureDocs(); const kept = (gameState.documents||[]).filter(d=>d.status==='kept'); if (kept.length) leakDoc(kept[Math.floor(Math.random()*kept.length)].id); if (kept.length>1 && Math.random()<0.5) leakDoc(kept[Math.floor(Math.random()*kept.length)].id); } },
                { text:'üî• –°–∂–µ—á—å –≤—Å—ë –∫ —á—ë—Ä—Ç—É', effect:()=>{ ensureDocs(); (gameState.documents||[]).forEach(d=>{ if(d.status==='kept') burnDoc(d.id); }); } }
            ]},
            { id:'s_day24', day:24, icon:'üîé', title:'–û–±—ã—Å–∫', text:'–†–∏—Å–∫ –≤—ã—Ä–æ—Å. –ö—Ç–æ-—Ç–æ –ø—Ä–∏—à—ë–ª ‚Äú–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∏–∫–∏‚Äù.', choices:[
                { text:'üßπ –ß–∏—Å—Ç–∫–∞ (800‚ÇΩ)', cost:800, effect:()=>{ addSuspicion(-18); changeLoyalty(+4); ensureDocs(); (gameState.documents||[]).forEach(d=>{ if(!d.real && d.status==='kept') burnDoc(d.id); }); } },
                { text:'üòá –î–µ–ª–∞—Ç—å –≤–∏–¥, —á—Ç–æ —Ç–∞–∫ –∏ –±—ã–ª–æ', effect:()=>{ addSuspicion(+12); } },
                { text:'üï≥Ô∏è –£–π—Ç–∏ –≤ —Ç–µ–Ω—å', effect:()=>{ addResistance(+6); addSuspicion(+8); changeLoyalty(-6); } }
            ]},
            { id:'s_day30', day:30, icon:'‚öñÔ∏è', title:'–†–∞–∑–≤–∏–ª–∫–∞', text:'–ö —Ñ–∏–Ω–∞–ª—É –≤—Å—ë —Å—Ö–æ–¥–∏—Ç—Å—è. –¢—ã –∑–∞ —Å–∏—Å—Ç–µ–º—É –∏–ª–∏ –ø—Ä–æ—Ç–∏–≤ –Ω–µ—ë?', choices:[
                { text:'üõ°Ô∏è –ó–∞ —Å–∏—Å—Ç–µ–º—É', effect:()=>{ changeLoyalty(+12); addResistance(-10); } },
                { text:'üî• –ü—Ä–æ—Ç–∏–≤ —Å–∏—Å—Ç–µ–º—ã', effect:()=>{ addResistance(+18); changeLoyalty(-12); addSuspicion(+10); } },
                { text:'üÉè –î–≤–æ–π–Ω–∞—è –∏–≥—Ä–∞', effect:()=>{ changeLoyalty(+4); addResistance(+8); addSuspicion(+12); } }
            ]}
        ];

        function maybeTriggerStory() {
            if (gameState.gameEnded) return;
            const day = (gameState.day || 1);
            for (const e of storyMilestones) {
                if (day >= e.day && !gameState.eventsTriggered.includes(e.id)) {
                    gameState.eventsTriggered.push(e.id);
                    showEncounterLike(e);
                    manualSave(true);
                    break;
                }
            }
        }

        
        // === START SCENES (—á–µ—Ä–Ω—É—Ö–∞ + –∞–±—Å—É—Ä–¥) ===
        function grantStarterPerk(kind){
            ensureMeta();
            if (gameState.starterPerk) return; // —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
            gameState.starterPerk = kind || '';

            if (kind === 'panel') {
                gameState.permSecondMul = (gameState.permSecondMul || 1) * 1.03;
                showNotification('üìü –î–æ—Å—Ç—É–ø –∫ –ø–∞–Ω–µ–ª–∏: –ø–∞—Å—Å–∏–≤ +3%');
            } else if (kind === 'budget') {
                gameState.money += 900;
                gameState.firstBuyDiscount = true;
                showNotification('üíº –î–æ—Å—Ç—É–ø –∫ –±—é–¥–∂–µ—Ç—É: +900 –∏ —Å–∫–∏–¥–∫–∞ –Ω–∞ 1 –ø–æ–∫—É–ø–∫—É');
            } else if (kind === 'archive') {
                try { addRandomDocument('starter'); } catch(e){}
                try { addRandomDocument('starter2'); } catch(e){}
                try { maybeFindRandomArtifact(0.45); } catch(e){}
                addSuspicion(6);
                showNotification('üìÅ –î–æ—Å—Ç—É–ø –∫ –∞—Ä—Ö–∏–≤—É: —É–ª–∏–∫–∏ –µ—Å—Ç—å, –∏ –ø—Ä–æ–±–ª–µ–º—ã —Ç–æ–∂–µ');
            }
            manualSave(true);
            updateDisplay(true);
        }

        function runStartScenes(){
            // –°—Ü–µ–Ω–∞ 1: ‚Äú—Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ‚Äù
            const s0 = {
                icon:'ü™™',
                title:'–°–û–ë–ï–°–ï–î–û–í–ê–ù–ò–ï',
                text:
                    '–ö–æ–º–Ω–∞—Ç–∞ –±–µ–∑ –æ–∫–æ–Ω. –ü–∞–ø–∫–∞. –ö–∞–º–µ—Ä–∞ –≤ —É–≥–ª—É –º–æ—Ä–≥–∞–µ—Ç –∫–∞–∫ —Å–æ–≤–µ—Å—Ç—å.<br><br>' +
                    '–ì–æ–ª–æ—Å –∏–∑ —Ç–µ–Ω–∏: ‚Äú–¢—ã –ø–æ–Ω–∏–º–∞–µ—à—å, —á—Ç–æ —Ç—É—Ç –Ω–µ –ª—é–¥–∏ —Ä–∞–±–æ—Ç–∞—é—Ç, –∞ —Ñ—É–Ω–∫—Ü–∏–∏? –¢—ã ‚Äî —Ñ—É–Ω–∫—Ü–∏—è.‚Äù<br><br>' +
                    '–í–º–µ—Å—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è ‚Äî –≤–æ–ø—Ä–æ—Å: <b>‚Äú–°–∫–æ–ª—å–∫–æ —Ç—ã –≥–æ—Ç–æ–≤ –ø–æ—Ç–µ—Ä—è—Ç—å, —á—Ç–æ–±—ã –æ—Å—Ç–∞—Ç—å—Å—è –Ω–∞ —Ä–∞–±–æ—Ç–µ?‚Äù</b>',
                choices:[
                    { text:'ü´° ‚Äú–Ø –≤–∏–Ω—Ç–∏–∫, —è –≤—ã–¥–µ—Ä–∂—É.‚Äù', subtext:'–õ–æ—è–ª—å–Ω–æ—Å—Ç—å +', effect:()=>{ changeLoyalty(+8); } },
                    { text:'üòà ‚Äú–ü–æ—Ö—É–π. –î–∞–π—Ç–µ –∫–Ω–æ–ø–∫—É.‚Äù', subtext:'–ì–Ω–µ–≤ +, —Ä–∏—Å–∫ +', effect:()=>{ changeAnger(+6); addSuspicion(+4); } },
                    { text:'üï≥Ô∏è ‚Äú–Ø —Ç—É—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ. –ü—Ä–∞–≤–¥–∞.‚Äù', subtext:'–ü–æ–¥–ø–æ–ª—å–µ +, –ª–æ—è–ª—å–Ω–æ—Å—Ç—å -', effect:()=>{ addResistance(+6); changeLoyalty(-4); } }
                ]
            };

            // –°—Ü–µ–Ω–∞ 2: –∫–∞–±–∏–Ω–µ—Ç
            const s1 = {
                icon:'üóÑÔ∏è',
                title:'–ö–ê–ë–ò–ù–ï–¢',
                text:
                    '–¢–≤–æ–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî —ç—Ç–æ —Å—Ç–æ–ª, —Å—Ç—É–ª –∏ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —à—É–º–∏—Ç –∫–∞–∫ –º–µ–º—ã –ø—Ä–æ —Ç–µ–±—è.<br><br>' +
                    '–í —è—â–∏–∫–µ: —Å—Ç–µ–ø–ª–µ—Ä, —á–∞–π 2008 –≥–æ–¥–∞ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è ‚Äú–∫–∞–∫ –Ω–µ —É–º–µ—Ä–µ—Ç—å (–Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è)‚Äù.<br><br>' +
                    '–°–≤–µ—Ä—Ö—É —Å–æ–æ–±—â–µ–Ω–∏–µ: ‚Äú–ù–ï –î–£–ú–ê–¢–¨. –í–´–ü–û–õ–ù–Ø–¢–¨.‚Äù',
                choices:[
                    { text:'üìé ‚Äú–û–∫–µ–π. –ü–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.‚Äù', subtext:'–õ–æ—è–ª—å–Ω–æ—Å—Ç—å +, —Ä–∏—Å–∫ -', effect:()=>{ changeLoyalty(+4); addSuspicion(-2); } },
                    { text:'üß® ‚Äú–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Ö—É–π –≤—Å—ë.‚Äù', subtext:'+1 –∫ –∫–ª–∏–∫—É, –≥–Ω–µ–≤ +', effect:()=>{ gameState.perClick = (gameState.perClick||1)+1; changeAnger(+4); } },
                    { text:'üíæ ‚Äú–°—Ç–∞—â–∏—Ç—å –º–µ–ª–æ—á—å.‚Äù', subtext:'–®–∞–Ω—Å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞', effect:()=>{ maybeFindRandomArtifact(0.35); addSuspicion(+3); } }
                ]
            };

            // –°—Ü–µ–Ω–∞ 3: –ø—Ä–∏–∫–∞–∑ + ‚Äú–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø‚Äù
            const s2 = {
                icon:'üìú',
                title:'–ü–†–ò–ö–ê–ó',
                text:
                    '–ö—É—Ä–∞—Ç–æ—Ä –≤ –∏–¥–µ–∞–ª—å–Ω–æ —á–∏—Å—Ç–æ–º –∫–æ—Å—Ç—é–º–µ –≥–æ–≤–æ—Ä–∏—Ç —Å–ø–æ–∫–æ–π–Ω–æ, –∫–∞–∫ –±—É–¥—Ç–æ –æ–±—Å—É–∂–¥–∞–µ—Ç –ø–æ–≥–æ–¥—É:<br><br>' +
                    '‚Äú–í–æ—Ç –ø—Ä–∏–∫–∞–∑. –í–æ—Ç —Å–ø–∏—Å–æ–∫. –í–æ—Ç –∫—Ä–∞–π–Ω–∏–π. –ï—Å–ª–∏ —á—Ç–æ ‚Äî –∫—Ä–∞–π–Ω–∏–π —Ç—ã.‚Äù<br><br>' +
                    '–ü–æ—Ç–æ–º, –∫–∞–∫ –≤ –ø–∞—Ä–æ–¥–∏–∏ –Ω–∞ –º–æ—Ç–∏–≤–∞—Ü–∏—é, –¥–æ–±–∞–≤–ª—è–µ—Ç: ‚Äú–í—ã–±–µ—Ä–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø. –¢–∏–ø–∞ –∑–∞–±–æ—Ç–∞. –•–∞.‚Äù',
                choices:[
                    { text:'üìü –î–æ—Å—Ç—É–ø –∫ –ø–∞–Ω–µ–ª–∏', subtext:'–ü–∞—Å—Å–∏–≤ +3%', effect:()=>{ grantStarterPerk('panel'); } },
                    { text:'üíº –î–æ—Å—Ç—É–ø –∫ –±—é–¥–∂–µ—Ç—É', subtext:'+900 –∏ —Å–∫–∏–¥–∫–∞ –Ω–∞ 1 –ø–æ–∫—É–ø–∫—É', effect:()=>{ grantStarterPerk('budget'); } },
                    { text:'üìÅ –î–æ—Å—Ç—É–ø –∫ –∞—Ä—Ö–∏–≤—É', subtext:'–£–ª–∏–∫–∏/–∞—Ä—Ç–µ—Ñ–∞–∫—Ç, –Ω–æ —Ä–∏—Å–∫', effect:()=>{ grantStarterPerk('archive'); } }
                ]
            };

            // –ø–æ–∫–∞–∑ –ø–æ –æ—á–µ—Ä–µ–¥–∏ (—á–µ—Ä–µ–∑ showEncounterLike)
            showEncounterLike({
                icon: s0.icon, title: s0.title, text: s0.text,
                choices: s0.choices.map(a=>({text:a.text, subtext:a.subtext, effect:()=>{ a.effect(); setTimeout(()=>showEncounterLike({
                    icon: s1.icon, title: s1.title, text: s1.text,
                    choices: s1.choices.map(b=>({text:b.text, subtext:b.subtext, effect:()=>{ b.effect(); setTimeout(()=>showEncounterLike({
                        icon: s2.icon, title: s2.title, text: s2.text,
                        choices: s2.choices.map(c=>({text:c.text, subtext:c.subtext, effect:()=>{ c.effect();
                            // –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ ‚Äî –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ (—Ü–µ–ø–æ—á–∫–∞ 2‚Äì3 –¥–Ω—è)
                            scheduleEncounter('mentor_intro', 0, 0);
                            setTimeout(()=>maybeTriggerEncounter(), 350);
                        }}))
                    }), 350); }}))
                }), 350); }}))
            });
        }

function showEncounterLike(pick) {
            // story milestone shown —á–µ—Ä–µ–∑ —Ç–æ—Ç –∂–µ choiceModal
            uiState.modalOpen = true;
            document.getElementById('choiceIcon').textContent = pick.icon || 'üìú';
            document.getElementById('choiceTitle').textContent = pick.title || '–°–æ–±—ã—Ç–∏–µ';
            document.getElementById('choiceText').innerHTML =
                (pick.text || '') +
                `<br><br><small style="color:var(--telegram-hint)">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å: ${Math.round(gameState.loyalty??50)} ¬∑ –ì–Ω–µ–≤: ${Math.round(gameState.tension||0)} ¬∑ –ü–æ–¥–ø–æ–ª—å–µ: ${Math.round(gameState.resistance||0)} ¬∑ –†–∏—Å–∫: ${Math.round(gameState.suspicion||0)}</small>`;

            const btns = document.getElementById('choiceButtons');
            btns.innerHTML = '';
            (pick.choices || []).forEach((ch, i) => {
                const b = document.createElement('button');
                b.className = `choice-btn ${i===0 ? 'primary':'secondary'}`;
                b.type = 'button';
                b.innerHTML = `<strong>${ch.text}</strong><div class="choice-consequence">${ch.subtext || ''}</div>`;
                b.addEventListener('click', (ev) => {
                    ev.preventDefault(); ev.stopPropagation();
                    if (ch.cost && ch.cost>0) {
                        if (gameState.money < ch.cost) { showNotification('üí∏ –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –±—é–¥–∂–µ—Ç–∞'); safeHaptic('light'); return; }
                        gameState.money -= ch.cost;
                    }
                    try { ch.effect && ch.effect(); } catch(e){}
                    document.getElementById('choiceModal').classList.remove('show');
                    uiState.modalOpen = false;
                    updateDisplay(true);
                    manualSave(true);
                }, {passive:false});
                btns.appendChild(b);
            });

            document.getElementById('choiceModal').classList.add('show');
            safeHaptic('medium');
        }
        // === GAME LOOP ===
        let _tickTimer = null;

        function startGameLoop() {
            if (_tickTimer) return;

            const TICK_MS = 250; // —ç–∫–æ–Ω–æ–º–∏—è –±–∞—Ç–∞—Ä–µ–∏ + —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
            _tickTimer = setInterval(() => {
                if (gameState.gameEnded) return;

                const rates = getEffectiveRates();
                const gain = rates.perSecond * (TICK_MS / 1000);

                if (gain > 0) {
                    gameState.money += gain;
                    gameState.totalBlocks += gain;

                    if (!isAchUnlocked('1k_blocks') && (gameState.totalBlocks||0) >= 1000) unlockAchievement('1k_blocks');
                    if (!isAchUnlocked('50k_blocks') && (gameState.totalBlocks||0) >= 50000) unlockAchievement('50k_blocks');

                    if (gameState.bossActive) {
                        gameState.bossHealth -= gain;
                        updateBossHealth();
                        if (gameState.bossHealth <= 0) defeatBoss();
                    } else {
                        gameState.targetProgress += gain;
                        checkTargetCompletion();
                    }

                    // –Ω–µ–±–æ–ª—å—à–æ–µ ‚Äú—Å–∞–º–æ—Ä–∞–∑–æ–≥—Ä–µ–≤–∞–Ω–∏–µ‚Äù –≥–Ω–µ–≤–∞
                    if (Math.random() < 0.02) {
                        gameState.tension = Math.min(100, gameState.tension + 0.15);
                    }

                    recalcDay();
                    checkChapters();
                    updateRank();
                } else {
                    // –¥–∞–∂–µ –±–µ–∑ –∞–≤—Ç–æ–¥–æ–±–æ—Ä–∞ –∏–Ω–æ–≥–¥–∞ –ø–æ–¥–∫–∏–¥—ã–≤–∞–µ–º –Ω–æ–≤–æ—Å—Ç–∏/—Å–æ–±—ã—Ç–∏—è
                    if (Math.random() < 0.01) updateNews();
                }

                maybeTriggerEncounter();
                // UI –æ–±–Ω–æ–≤–∏–º —á–µ—Ä–µ–∑ RAF (—Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥)
                requestUiUpdate();
            }, TICK_MS);

            // –∞–≤—Ç–æ—Å–µ–π–≤ –ø—Ä–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') manualSave(true);
            });

            window.addEventListener('pagehide', () => manualSave(true));
        }

        function requestUiUpdate() {
            const now = Date.now();
            if (now - uiState.lastUiFrame < 80) return; // –Ω–µ —á–∞—â–µ ~12fps –¥–ª—è —Ç–µ–∫—Å—Ç–∞/DOM
            uiState.lastUiFrame = now;
            window.requestAnimationFrame(() => {
                updateDisplay();
                // –æ–±–Ω–æ–≤–ª—è—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ —É–ª—É—á—à–µ–Ω–∏–π –Ω–µ —á–∞—â–µ 2 —Ä–∞–∑/—Å–µ–∫
                if (now - uiState.lastUpgradeRefresh > 500) {
                    uiState.lastUpgradeRefresh = now;
                    refreshUpgradeCards();
                }
            });
        }


        // === ENDINGS ===
        function resolveEndingType(type) {
            const loy = (gameState.loyalty ?? 50);
            const anger = (gameState.tension || 0);

            if (type === 'internet_dead') {
                if (anger >= 85) return 'internet_dead_hunted';
                if (loy >= 75 && anger < 70) return 'internet_dead_hero';
                if (loy < 35 && anger >= 70) return 'internet_dead_scapegoat';
                return 'internet_dead';
            }

            if (type === 'walk_away') {
                if (anger >= 80) return 'walk_away_hunted';
                if (loy >= 80) return 'walk_away_caught';
                return 'walk_away';
            }

            if (type === 'martyr') {
                if (loy >= 70 && anger < 80) return 'martyr_saint';
                if (anger >= 85) return 'martyr_terror';
                return 'martyr';
            }

            return type;
        }

        function triggerEnding(type) {
            ensureDocs();
            gameState.gameEnded = true;

            const baseType = resolveEndingType(type);

            const real = countDocs({realOnly:true});
            const leakedReal = (gameState.documents||[]).filter(d=>d.real && d.status==='leaked').length;
            const fake = countDocs({fakeOnly:true});
            const leakedFake = (gameState.documents||[]).filter(d=>!d.real && d.status==='leaked').length;

            const loy = (gameState.loyalty ?? 50);
            const anger = (gameState.tension || 0);
            const res = (gameState.resistance || 0);
            const sus = (gameState.suspicion || 0);

            let finalType = baseType;
            let ending = endings[finalType] || endings.internet_dead;

            // —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∏–Ω–∞–ª: —Å–æ–±—Ä–∞–ª –≤—Å—ë –Ω–∞—Å—Ç–æ—è—â–µ–µ
            if (real >= 5 && leakedReal >= 3 && res >= 60) {
                ending = {
                    icon: "üìöüî•",
                    title: "–ê–†–•–ò–í–ê–†–ò–£–° –ê–ü–û–ö–ê–õ–ò–ü–°–ò–°–ê",
                    text: "–¢—ã —Å–æ–±—Ä–∞–ª –≤—Å—ë –∏ –ø—É—Å—Ç–∏–ª —ç—Ç–æ –≤ —Ö–æ–¥.<br><br>–ê—Ä—Ö–∏–≤ —É—Ç—ë–∫. –°–∏—Å—Ç–µ–º—É —Ç—Ä—è—Ö–Ω—É–ª–æ. –í –æ—Ç—á—ë—Ç–∞—Ö ‚Äî —Ö–∞–æ—Å, –≤ –∫–∞–±–∏–Ω–µ—Ç–∞—Ö ‚Äî –ø–∞–Ω–∏–∫–∞.<br><br>–¢—ã –Ω–µ –≥–µ—Ä–æ–π –∏ –Ω–µ –∑–ª–æ–¥–µ–π ‚Äî —Ç—ã –∫–∞—Ç–∞–ª–∏–∑–∞—Ç–æ—Ä. –ò —Ç–µ–ø–µ—Ä—å —ç—Ç–æ—Ç –º–∏—Ä –±—É–¥–µ—Ç –¥—Ä—É–≥–∏–º."
                };
            } else {
                if (finalType.startsWith('internet_dead')) {
                    if (leakedReal >= 3 && res >= 55) {
                        ending = {
                            icon: "üåêüß®",
                            title: "–†–ê–ó–û–ë–õ–ê–ß–ò–¢–ï–õ–¨ –°–ò–°–¢–ï–ú–´",
                            text: "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç —É–º–µ—Ä, –Ω–æ —Ç—ã —É—Å–ø–µ–ª –æ—Å—Ç–∞–≤–∏—Ç—å –º–∏—Ä—É –∫–æ–º–ø—Ä–æ–º–∞—Ç.<br><br>–î–æ–∫—É–º–µ–Ω—Ç—ã —Ä–∞–∑–ª–µ—Ç–µ–ª–∏—Å—å, –∫–∞–∫ –∏—Å–∫—Ä—ã. –õ—é–¥–∏ —É–≤–∏–¥–µ–ª–∏ –º–µ—Ö–∞–Ω–∏–∑–º –∏–∑–Ω—É—Ç—Ä–∏.<br><br>–°–∏—Å—Ç–µ–º–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–º–µ—Å—Ç–∏ —Å–ª–µ–¥—ã ‚Äî –Ω–æ –ø–æ–∑–¥–Ω–æ."
                        };
                    } else if (sus >= 80 || leakedFake >= 1) {
                        finalType = 'internet_dead_scapegoat';
                        ending = endings[finalType];
                        ending = Object.assign({}, ending, {
                            text: ending.text + "<br><br><small style='color:var(--telegram-hint)'>–ü–æ–¥—Å—Ç–∞–≤–∞ —Å—Ä–∞–±–æ—Ç–∞–ª–∞: –ø–æ–¥–æ–∑—Ä–µ–Ω–∏—è –∑–∞—à–∫–∞–ª–∏–ª–∏.</small>"
                        });
                    }
                }

                if (finalType.startsWith('walk_away')) {
                    if (leakedReal >= 2 && res >= 45) {
                        ending = {
                            icon: "üö∂üì§",
                            title: "–£–®–Å–õ –ò –°–õ–ò–õ",
                            text: "–¢—ã —É—à—ë–ª ‚Äî –∏ –æ—Å—Ç–∞–≤–∏–ª –ø–æ—Å–ª–µ —Å–µ–±—è –ø–∞—á–∫—É —É–ª–∏–∫.<br><br>–ü–æ–¥–ø–æ–ª—å–µ –ø–æ–¥–Ω—è–ª–æ —à—É–º. –°–∏—Å—Ç–µ–º–∞ –±–µ—Å–∏—Ç—Å—è. –¢–µ–±—è –∏—â—É—Ç, –Ω–æ —Ç—ã —É–∂–µ –¥–∞–ª–µ–∫–æ.<br><br>–í–ø–µ—Ä–≤—ã–µ –∑–∞ –¥–æ–ª–≥–æ–µ –≤—Ä–µ–º—è —Ç–µ–±–µ –Ω–µ —Å—Ç—ã–¥–Ω–æ."
                        };
                    } else if (sus >= 80) {
                        finalType = 'walk_away_caught';
                        ending = endings[finalType];
                    }
                }

                if (finalType.startsWith('martyr')) {
                    if (leakedReal >= 2 && res >= 55) {
                        ending = {
                            icon: "üïØÔ∏èüìÑ",
                            title: "–ú–£–ß–ï–ù–ò–ö –° –î–û–ö–£–ú–ï–ù–¢–ê–ú–ò",
                            text: "–¢—ã —Å–≥–æ—Ä–µ–ª ‚Äî –Ω–æ –Ω–µ –∑—Ä—è.<br><br>–¢–≤–æ–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å—Ç–∞–ª–∏ —Ç–µ–º, —á—Ç–æ –ª—é–¥–∏ –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞—é—Ç —à—ë–ø–æ—Ç–æ–º.<br><br>–°–∏—Å—Ç–µ–º–∞ –≤—ã—á—ë—Ä–∫–∏–≤–∞–µ—Ç —Ç–µ–±—è –∏–∑ –æ—Ç—á—ë—Ç–æ–≤, –Ω–æ —É–∂–µ –ø–æ–∑–¥–Ω–æ: –ø–∞–º—è—Ç—å –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è."
                        };
                    }
                }

                const keptReal = (gameState.documents||[]).filter(d=>d.real && d.status==='kept').length;
                if (keptReal >= 3 && loy >= 70 && sus < 70 && baseType === 'internet_dead_hero') {
                    ending = {
                        icon: "üëîüìÅ",
                        title: "–°–ï–†–´–ô –ö–ê–†–î–ò–ù–ê–õ",
                        text: "–¢—ã –Ω–µ —Å–ª–∏–≤–∞–ª ‚Äî —Ç—ã –∫–æ–ø–∏–ª.<br><br>–ü–∞–ø–∫–∞ –Ω–∞ –∫–∞–∂–¥–æ–≥–æ. –†—ã—á–∞–≥–∞ —Ö–≤–∞—Ç–∏—Ç –Ω–∞ –≥–æ–¥—ã.<br><br>–¢–µ–±—è –ø–æ–≤—ã—à–∞—é—Ç. –¢–µ–±—è –±–æ—è—Ç—Å—è. –ò, —á—Ç–æ —Ö—É–∂–µ –≤—Å–µ–≥–æ, —Ç–µ–±—è —É–≤–∞–∂–∞—é—Ç."
                    };
                }

                if (leakedFake >= 1 && sus >= 70) {
                    ending = {
                        icon: "üßª‚öñÔ∏è",
                        title: "–ü–û–î–°–¢–ê–í–ê",
                        text: "–¢—ã —Å–ª–∏–ª ‚Äú—É–ª–∏–∫—É‚Äù ‚Äî –∏ –ø–æ–ø–∞–ª—Å—è –Ω–∞ –ø—Ä–∏–º–∞–Ω–∫—É.<br><br>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å. –ö—Ä–∞—Å–∏–≤—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏. –ì–ª—É—Ö–∏–µ –¥–≤–µ—Ä–∏.<br><br>–°–∏—Å—Ç–µ–º–∞ –ª—é–±–∏—Ç —Ç–µ—Ö, –∫—Ç–æ —É–¥–æ–±–µ–Ω. –ê —Ç—ã —Å—Ç–∞–ª —É–¥–æ–±–Ω—ã–º."
                    };
                }
            }

            
            // === DOUBLE GAME SPECIAL ENDINGS ===
            const artCount = (gameState.artifacts || []).length;
            const hasFlash = hasArtifact('flash');
            const hasAudio = hasArtifact('audio');
            const hasShot  = hasArtifact('screenshot');

            // ‚Äú–°–µ—Ä—ã–π –∫–∞—Ä–¥–∏–Ω–∞–ª‚Äù: –±–∞–ª–∞–Ω—Å–∏—Ä—É–µ—à—å, –ø–æ–¥–ø–æ–ª—å–µ –∫–æ—Ä–º–∏—Ç—Å—è, –∞ —Å–∏—Å—Ç–µ–º–∞ —Ç–µ–±—è –Ω–µ –ø—Ä–∏–∫–æ–Ω—á–∏–ª–∞
            if (!gameState.gameEndedDoubleApplied) {
                if (res >= 65 && sus >= 45 && sus <= 80 && loy >= 45 && loy <= 80 && leakedReal >= 2 && artCount >= 1) {
                    ending = {
                        icon: "üï∂Ô∏èüÉè",
                        title: "–°–ï–†–´–ô –ö–ê–†–î–ò–ù–ê–õ",
                        text: "–¢—ã –∏–≥—Ä–∞–ª –Ω–∞ –¥–≤–∞ —Ñ—Ä–æ–Ω—Ç–∞ –∏ –≤—ã–∂–∏–ª.<br><br>–°–∏—Å—Ç–µ–º–µ —Ç—ã –Ω—É–∂–µ–Ω –∫–∞–∫ –≤–∏–Ω—Ç–∏–∫, –ø–æ–¥–ø–æ–ª—å—é ‚Äî –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫. –¢—ã –∫–æ—Ä–º–∏—à—å –æ–±–æ–∏—Ö, –∏ –æ–±–∞ –±–æ—è—Ç—Å—è –ø–æ—Ç–µ—Ä—è—Ç—å —Ç–µ–±—è.<br><br>–°–∞–º–æ–µ —Å—Ç—Ä–∞—à–Ω–æ–µ: —Ç–µ–±–µ —ç—Ç–æ –¥–∞–∂–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å."
                    };
                }

                // ‚Äú–°–≥–æ—Ä–µ–ª –Ω–∞ –¥–≤–æ–π–Ω–æ–π‚Äù: —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ä–∏—Å–∫–∞
                if (res >= 60 && sus >= 85) {
                    ending = {
                        icon: "ü™§üí•",
                        title: "–°–û–†–í–ê–õ–°–Ø –ù–ê –î–í–û–ô–ù–û–ô",
                        text: "–¢—ã –ø—ã—Ç–∞–ª—Å—è —É—Å–∏–¥–µ—Ç—å –Ω–∞ –¥–≤—É—Ö —Å—Ç—É–ª—å—è—Ö ‚Äî –∏ –æ–±–∞ —Å–ª–æ–º–∞–ª–∏—Å—å.<br><br>–ü–æ–¥–ø–æ–ª—å–µ —Å—á–∏—Ç–∞–µ—Ç —Ç–µ–±—è –∫—Ä—ã—Å–æ–π. –°–∏—Å—Ç–µ–º–∞ ‚Äî —É–≥—Ä–æ–∑–æ–π.<br><br>–¢–µ–±—è —É–Ω–µ—Å–ª–∏ –±–µ–∑ —à—É–º–∞. –ò –±–µ–∑ —à–∞–Ω—Å–æ–≤."
                    };
                }

                // ‚Äú–ö–æ—Ä–æ–ª—å —à–∞–Ω—Ç–∞–∂–∞‚Äù: –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –∫–∞–∫ —Ä—ã—á–∞–≥, –ø–æ–¥–ø–æ–ª—å—é –ø–æ—á—Ç–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Ç–¥–∞–ª
                if (loy >= 75 && res <= 35 && (hasAudio || hasShot) && sus >= 70) {
                    ending = {
                        icon: "üëëüìº",
                        title: "–ö–û–†–û–õ–¨ –®–ê–ù–¢–ê–ñ–ê",
                        text: "–¢—ã –Ω–µ —Å–ª–∏–≤–∞–ª –ø—Ä–∞–≤–¥—É ‚Äî —Ç—ã –ø—Ä–æ–¥–∞–≤–∞–ª –µ—ë.<br><br>–ü–∞–ø–∫–∏ –∏ –∑–∞–ø–∏—Å–∏ —Å–¥–µ–ª–∞–ª–∏ —Ç–µ–±—è –Ω–µ–ø—Ä–∏–∫–∞—Å–∞–µ–º—ã–º: —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ª—é–¥–µ–π –±–æ—è—Ç—Å—è, —á—Ç–æ —Ç—ã –Ω–∞–∂–º—ë—à—å ‚Äú–æ—Ç–ø—Ä–∞–≤–∏—Ç—å‚Äù.<br><br>–í —ç—Ç–æ–º –∞–¥—É —Ç—ã –ø–æ—Å—Ç—Ä–æ–∏–ª —Å–µ–±–µ —Ç—Ä–æ–Ω."
                    };
                }
                gameState.gameEndedDoubleApplied = true;
            }


            // === ESCAPE ARC OVERRIDES (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ ‚Äú—Å—ä–µ–±–∞—Ç—å‚Äù) ===
            if (gameState.escapeActive) {
                const r = gameState.escapeResult || 'unknown';
                if (r === 'clean') {
                    ending = {
                        icon: "üß≥‚úÖ",
                        title: "–¢–ò–•–û –°–í–ê–õ–ò–õ",
                        text: "–¢—ã —É—à—ë–ª –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –∏ –±–µ–∑ —Ü–∏—Ä–∫–∞.<br><br>–ù–∏ –æ–±—ã—Å–∫–∞, –Ω–∏ –ø–æ–≥–æ–Ω–∏. –¢–æ–ª—å–∫–æ –º–µ—Ä–∑–∫–∏–π –≤–∫—É—Å –≤–æ —Ä—Ç—É –∏ —á—É–≤—Å—Ç–≤–æ, —á—Ç–æ —Ç—ã –±—Ä–æ—Å–∏–ª –≤—Å—ë –∫ —á—ë—Ä—Ç—É.<br><br>–ù–æ —Ç—ã –∂–∏–≤. –ò —ç—Ç–æ, –º–∞—Ç—å –µ–≥–æ, –≥–ª–∞–≤–Ω–æ–µ."
                    };
                } else if (r === 'res') {
                    ending = {
                        icon: "üöêüï≥Ô∏è",
                        title: "–ö–ê–ù–ê–õ –ü–û–î–ü–û–õ–¨–Ø",
                        text: "–ü–æ–¥–ø–æ–ª—å–µ –≤—ã–≤–µ–∑–ª–æ —Ç–µ–±—è —á–µ—Ä–µ–∑ —Å–≤–æ–∏ —Ö–æ–¥—ã.<br><br>–¢—ã —Ç–µ–ø–µ—Ä—å –Ω–µ ‚Äú–±—ã–≤—à–∏–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫‚Äù ‚Äî —Ç—ã —Ä–µ—Å—É—Ä—Å. –¢–µ–±—è –ø—Ä—è—á—É—Ç, —Ç–µ–±—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç, —Ç–µ–±—è –æ—Ö—Ä–∞–Ω—è—é—Ç.<br><br>–¢—ã —Å–ø–∞—Å—Å—è. –ò –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤–ª—è–ø–∞–ª—Å—è –ø–æ —É—à–∏."
                    };
                } else if (r === 'caught' || r === 'panic_fail') {
                    ending = {
                        icon: "üõÇ‚õìÔ∏è",
                        title: "–ù–ï –í–´–ü–£–°–¢–ò–õ–ò",
                        text: "–ù–∞ –≥—Ä–∞–Ω–∏—Ü–µ –≤—Å—ë –±—ã–ª–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ‚Ä¶ –ø–æ–∫–∞ –Ω–µ —Å—Ç–∞–ª–æ.<br><br>–ü–∞—Ä–∞ –ª–∏—à–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤. –ü–∞—É–∑–∞. –ó–≤–æ–Ω–æ–∫. –ò –≤—Å—ë ‚Äî —Ç–µ–±—è –≤–µ–¥—É—Ç –≤ –∫–æ–º–Ω–∞—Ç—É –±–µ–∑ –æ–∫–æ–Ω.<br><br>–¢—ã —Ö–æ—Ç–µ–ª —Å—ä–µ–±–∞—Ç—å. –ê –ø–æ–ª—É—á–∏–ª–æ—Å—å ‚Äî –ø–æ–¥–∞—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º–µ –≥–æ—Ç–æ–≤—ã–π —Ç—Ä–æ—Ñ–µ–π."
                    };
                } else if (r === 'panic_ok') {
                    ending = {
                        icon: "üèÉüí®",
                        title: "–°–í–ê–õ–ò–õ –ù–ê –ê–î–†–ï–ù–ê–õ–ò–ù–ï",
                        text: "–¢—ã —Ä–≤–∞–Ω—É–ª –±–µ–∑ –ø–ª–∞–Ω–∞ ‚Äî –∏ —á—É–¥–æ–º –≤—ã—Å–∫–æ—á–∏–ª.<br><br>–¢–µ–ø–µ—Ä—å –∂–∏–≤—ë—à—å –∫–∞–∫ —Ç–µ–Ω—å: –±–µ–∑ –∞–¥—Ä–µ—Å–∞, –±–µ–∑ —Å–Ω–∞, –±–µ–∑ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è.<br><br>–ù–æ —Ç—ã –≤—ã–∂–∏–ª. –ê –¥–∞–ª—å—à–µ ‚Äî –∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—Å—è."
                    };
                } else if (r === 'bad_res') {
                    ending = {
                        icon: "üï≥Ô∏èü™§",
                        title: "–•–õ–ò–ü–ö–ò–ô –ö–ê–ù–ê–õ",
                        text: "–ö–∞–Ω–∞–ª –ø–æ–¥–ø–æ–ª—å—è –æ–∫–∞–∑–∞–ª—Å—è —Å–ª–∞–±—ã–º. –ö—Ç–æ-—Ç–æ –æ—à–∏–±—Å—è. –ö—Ç–æ-—Ç–æ –ø—Ä–æ–¥–∞–ª—Å—è.<br><br>–¢—ã –≤—Ä–æ–¥–µ –≤—ã—à–µ–ª‚Ä¶ –Ω–æ —Ö–≤–æ—Å—Ç —É–∂–µ —Ä—è–¥–æ–º.<br><br>–í —ç—Ç–æ–º –º–∏—Ä–µ –¥–∞–∂–µ –ø–æ–±–µ–≥ ‚Äî —Ä–∞–±–æ—Ç–∞ –Ω–∞ –∏–∑–Ω–æ—Å."
                    };
                }
                // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –≤ —Å–ª–µ–¥—É—é—â–µ–π —Å–º–µ–Ω–µ –Ω–µ –≤–ª–∏—è–ª–æ
                gameState.escapeActive = false;
                gameState.escapeStage = 0;
            }

gameState.endingType = (ending.title || finalType);

            document.getElementById('endingIcon').textContent = ending.icon;
            document.getElementById('endingTitle').textContent = ending.title;
            document.getElementById('endingText').innerHTML = ending.text;
            document.getElementById('endBlocks').textContent = formatNumber(gameState.totalBlocks);
            document.getElementById('endTime').textContent = formatTime(Date.now() - gameState.startTime);
            document.getElementById('endType').textContent = ending.title;

            document.getElementById('endingScreen').classList.add('show');

            if (tg) tg.HapticFeedback?.notificationOccurred('success');
        }

                function restartGame(keepMeta=true) {
            if (_tickTimer) { clearInterval(_tickTimer); _tickTimer = null; }

            gameState = makeBaseState(keepMeta);
            ensureMeta();

            document.getElementById('endingScreen').classList.remove('show');
            document.getElementById('blockedList').innerHTML = '';
            document.getElementById('bossPanel').classList.add('hidden');
            document.getElementById('targetPanel').classList.remove('hidden');

            initUpgrades(false);
            updateDialog();
            updateRank();
            updateDisplay(true);
            updateNews();
            updatePrestigeButton();
            manualSave(true);

            // –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª
            startGameLoop();
        }


        // === TOP ACTIONS ===
        document.getElementById('btnMenu').addEventListener('click', (e) => { e.preventDefault(); openMenu(); }, { passive:false });
        document.getElementById('btnSave').addEventListener('click', (e) => { e.preventDefault(); manualSave(false); }, { passive:false });
        document.getElementById('btnAch').addEventListener('click', (e) => { e.preventDefault(); openAchievements('ach'); }, { passive:false });
        document.getElementById('btnDocs').addEventListener('click', (e) => { e.preventDefault(); openAchievements('docs'); }, { passive:false });

        // Telegram: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –≤ MainButton (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø—Ä–∏—è—Ç–Ω–æ)
        if (tg && tg.MainButton) {
            tg.MainButton.setText('üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å');
            tg.MainButton.show();
            tg.MainButton.onClick(() => manualSave(false));
        }

        // === START ===
        window.onload = () => {
            try { startPrologue(); } catch(e) { try{ endPrologue(); }catch(_){} }
            try { updateIntroContinueButton(); } catch(e) {}

            // safety: if prologue text didn't render (webview quirks) ‚Äî skip to intro
            setTimeout(() => {
                try{
                    const t = document.getElementById('prologueText');
                    const scr = document.getElementById('prologueScreen');
                    if (scr && !scr.classList.contains('hidden')) {
                        const empty = !t || !t.textContent || t.textContent.trim().length < 2;
                        if (empty) endPrologue();
                    }
                }catch(e){}
            }, 800);
        };
    </script>
</body>
</html>
